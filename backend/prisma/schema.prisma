// Prisma Schema for Familien-Lokal Platform
// PostgreSQL with PostGIS extension

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}

// ============================================
// CORE EVENT MODELS
// ============================================

// Canonical Events - THE single source of truth per event
model CanonicalEvent {
  id                String   @id @default(uuid())
  title             String   @db.VarChar(200)
  description_short String?  @db.VarChar(500)
  description_long  String?  @db.Text
  
  // DateTime
  start_datetime    DateTime @db.Timestamptz
  end_datetime      DateTime? @db.Timestamptz
  
  // Location
  location_address  String?  @db.VarChar(300)
  location_district String?  @db.VarChar(100)
  location_lat      Decimal? @db.Decimal(10, 8)
  location_lng      Decimal? @db.Decimal(11, 8)
  // PostGIS point will be added via raw SQL migration
  
  // Pricing
  price_type        PriceType @default(unknown)
  price_min         Decimal?  @db.Decimal(8, 2)
  price_max         Decimal?  @db.Decimal(8, 2)
  
  // Age range
  age_min           Int?      @db.SmallInt
  age_max           Int?      @db.SmallInt
  
  // Indoor/Outdoor
  is_indoor         Boolean   @default(false)
  is_outdoor        Boolean   @default(false)
  
  // Contact
  booking_url       String?   @db.VarChar(500)
  contact_email     String?   @db.VarChar(200)
  contact_phone     String?   @db.VarChar(50)
  
  // Media
  image_urls        Json?     @default("[]")
  
  // Source tracking
  primary_source_id String?   @unique
  primary_source    EventSource? @relation("PrimarySource", fields: [primary_source_id], references: [id])
  merged_from       Json?     @default("[]") // Array of source IDs
  
  // Provider (if registered)
  provider_id       String?
  provider          Provider? @relation(fields: [provider_id], references: [id])
  
  // Status & Quality
  status            EventStatus @default(raw)
  is_complete       Boolean     @default(false)
  is_verified       Boolean     @default(false)
  completeness_score Int?       @db.SmallInt // 0-100
  last_verified_at  DateTime?   @db.Timestamptz
  
  // Timestamps
  created_at        DateTime    @default(now()) @db.Timestamptz
  updated_at        DateTime    @updatedAt @db.Timestamptz
  
  // Relations
  categories        EventCategory[]
  scores            EventScore?
  amenities         EventAmenity[]
  event_sources     EventSource[] @relation("CanonicalEventSources")
  saved_by          SavedEvent[]
  plan_slots        PlanSlot[]
  
  @@index([status, start_datetime])
  @@index([start_datetime])
  @@index([provider_id])
  @@map("canonical_events")
}

enum EventStatus {
  raw
  incomplete
  pending_ai
  pending_review
  published
  stale
  archived
  rejected
}

enum PriceType {
  free
  paid
  range
  unknown
}

// Event Scores from AI
model EventScore {
  event_id          String   @id
  event             CanonicalEvent @relation(fields: [event_id], references: [id], onDelete: Cascade)
  
  relevance_score   Int?     @db.SmallInt // 0-100
  quality_score     Int?     @db.SmallInt // 0-100
  family_fit_score  Int?     @db.SmallInt // 0-100
  stressfree_score  Int?     @db.SmallInt // 0-100
  confidence        Decimal? @db.Decimal(3, 2) // 0.00-1.00
  
  ai_model_version  String?  @db.VarChar(50)
  ai_reasoning      Json?    // Reasoning for scores
  scored_at         DateTime @default(now()) @db.Timestamptz
  
  @@map("event_scores")
}

// ============================================
// SOURCE & INGESTION MODELS
// ============================================

// Raw event data from each source
model EventSource {
  id                  String   @id @default(uuid())
  canonical_event_id  String?
  canonical_event     CanonicalEvent? @relation("CanonicalEventSources", fields: [canonical_event_id], references: [id])
  
  source_id           String
  source              Source   @relation(fields: [source_id], references: [id])
  
  external_id         String?  @db.VarChar(255) // ID at the source
  source_url          String?  @db.VarChar(500)
  
  raw_data            Json?    // Original data as received
  normalized_data     Json?    // After parsing/normalization
  
  fingerprint         String?  @db.VarChar(32) // For deduplication
  
  fetched_at          DateTime @default(now()) @db.Timestamptz
  updated_at          DateTime @updatedAt @db.Timestamptz
  
  // Canonical events that use this as primary source
  primary_for         CanonicalEvent? @relation("PrimarySource")
  
  @@unique([source_id, external_id])
  @@index([fingerprint])
  @@index([canonical_event_id])
  @@map("event_sources")
}

// Data Sources (RSS feeds, APIs, scrapers, etc.)
model Source {
  id                    String       @id @default(uuid())
  name                  String       @db.VarChar(200)
  type                  SourceType
  url                   String?      @db.VarChar(500)
  
  // Scheduling
  schedule_cron         String?      @db.VarChar(50)
  last_fetch_at         DateTime?    @db.Timestamptz
  next_fetch_at         DateTime?    @db.Timestamptz
  last_success_at       DateTime?    @db.Timestamptz
  last_failure_at       DateTime?    @db.Timestamptz
  
  // Health monitoring
  is_active             Boolean      @default(true)
  consecutive_failures  Int          @default(0)
  health_status         HealthStatus @default(unknown)
  avg_events_per_fetch  Float?
  expected_event_count_min Int?
  
  // Rate limiting & compliance
  scrape_allowed        Boolean      @default(true)
  rate_limit_ms         Int          @default(5000)
  priority              Int          @default(3) // 1=partner, 2=api, 3=feed, 4=scraper
  
  notes                 String?      @db.Text
  
  created_at            DateTime     @default(now()) @db.Timestamptz
  updated_at            DateTime     @updatedAt @db.Timestamptz
  
  // Relations
  event_sources         EventSource[]
  fetch_logs            SourceFetchLog[]
  compliance            SourceCompliance?
  
  @@map("sources")
}

enum SourceType {
  api
  rss
  ics
  scraper
  partner
  manual
}

enum HealthStatus {
  healthy
  degraded
  failing
  dead
  unknown
}

// Legal compliance tracking for sources
model SourceCompliance {
  source_id             String   @id
  source                Source   @relation(fields: [source_id], references: [id], onDelete: Cascade)
  
  robots_txt_checked_at DateTime? @db.Timestamptz
  robots_txt_allows     Boolean?
  
  tos_reviewed_at       DateTime? @db.Timestamptz
  tos_allows_scraping   Boolean?
  
  contact_attempted     Boolean   @default(false)
  partnership_status    PartnershipStatus @default(none)
  
  legal_notes           String?   @db.Text
  updated_at            DateTime  @updatedAt @db.Timestamptz
  
  @@map("source_compliance")
}

enum PartnershipStatus {
  none
  pending
  agreed
  rejected
}

// Fetch logs for monitoring
model SourceFetchLog {
  id                String   @id @default(uuid())
  source_id         String
  source            Source   @relation(fields: [source_id], references: [id], onDelete: Cascade)
  
  started_at        DateTime @default(now()) @db.Timestamptz
  finished_at       DateTime? @db.Timestamptz
  
  status            FetchStatus @default(running)
  events_found      Int?
  events_new        Int?
  events_updated    Int?
  
  error_message     String?  @db.Text
  http_status_code  Int?
  response_size_bytes Int?
  
  @@index([source_id, started_at])
  @@map("source_fetch_logs")
}

enum FetchStatus {
  running
  success
  partial
  error
}

// ============================================
// GEOCODING & LOCATION
// ============================================

model GeocodeCache {
  address_hash        String   @id @db.VarChar(64)
  original_address    String   @db.Text
  normalized_address  String?  @db.Text
  
  lat                 Decimal  @db.Decimal(10, 8)
  lng                 Decimal  @db.Decimal(11, 8)
  confidence          Decimal? @db.Decimal(3, 2)
  
  provider            String   @db.VarChar(50) // nominatim, google, manual
  district_canonical  String?  @db.VarChar(100)
  
  created_at          DateTime @default(now()) @db.Timestamptz
  
  @@map("geocode_cache")
}

model DistrictAlias {
  id                String   @id @default(uuid())
  canonical_name    String   @unique @db.VarChar(100)
  aliases           Json     @default("[]") // Array of alternative names
  center_lat        Decimal? @db.Decimal(10, 8)
  center_lng        Decimal? @db.Decimal(11, 8)
  
  @@map("district_aliases")
}

// ============================================
// AI & CACHING
// ============================================

model AICache {
  content_hash         String   @id @db.VarChar(64)
  model_version        String   @db.VarChar(50)
  
  classification_result Json?
  scores               Json?
  
  created_at           DateTime @default(now()) @db.Timestamptz
  expires_at           DateTime @db.Timestamptz
  hit_count            Int      @default(0)
  
  @@index([expires_at])
  @@map("ai_cache")
}

model AIUsageLog {
  id                String   @id @default(uuid())
  timestamp         DateTime @default(now()) @db.Timestamptz
  
  model             String   @db.VarChar(50)
  operation         String   @db.VarChar(50) // classify, score, enrich, plan
  
  input_tokens      Int?
  output_tokens     Int?
  estimated_cost_usd Decimal? @db.Decimal(10, 6)
  
  event_id          String?
  user_id           String?
  
  @@index([timestamp])
  @@index([model, operation])
  @@map("ai_usage_log")
}

// ============================================
// CATEGORIES & AMENITIES
// ============================================

model Category {
  id          String   @id @default(uuid())
  slug        String   @unique @db.VarChar(50)
  name_de     String   @db.VarChar(100)
  icon        String?  @db.VarChar(10)
  parent_id   String?
  parent      Category? @relation("CategoryHierarchy", fields: [parent_id], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  
  events      EventCategory[]
  
  @@map("categories")
}

model EventCategory {
  event_id    String
  event       CanonicalEvent @relation(fields: [event_id], references: [id], onDelete: Cascade)
  category_id String
  category    Category @relation(fields: [category_id], references: [id], onDelete: Cascade)
  
  @@id([event_id, category_id])
  @@map("event_categories")
}

model Amenity {
  id          String   @id @default(uuid())
  slug        String   @unique @db.VarChar(50)
  name_de     String   @db.VarChar(100)
  icon        String?  @db.VarChar(10)
  
  events      EventAmenity[]
  
  @@map("amenities")
}

model EventAmenity {
  event_id    String
  event       CanonicalEvent @relation(fields: [event_id], references: [id], onDelete: Cascade)
  amenity_id  String
  amenity     Amenity @relation(fields: [amenity_id], references: [id], onDelete: Cascade)
  is_confirmed Boolean @default(false)
  
  @@id([event_id, amenity_id])
  @@map("event_amenities")
}

// ============================================
// PROVIDERS (B2B)
// ============================================

model Provider {
  id                String   @id @default(uuid())
  name              String   @db.VarChar(200)
  type              ProviderType
  
  website           String?  @db.VarChar(500)
  email             String?  @db.VarChar(200)
  phone             String?  @db.VarChar(50)
  
  address           String?  @db.VarChar(300)
  lat               Decimal? @db.Decimal(10, 8)
  lng               Decimal? @db.Decimal(11, 8)
  
  logo_url          String?  @db.VarChar(500)
  subscription_tier SubscriptionTier @default(free)
  
  user_id           String?  @unique
  user              User?    @relation(fields: [user_id], references: [id])
  
  created_at        DateTime @default(now()) @db.Timestamptz
  updated_at        DateTime @updatedAt @db.Timestamptz
  
  events            CanonicalEvent[]
  
  @@map("providers")
}

enum ProviderType {
  verein
  schule
  camp
  museum
  cafe
  other
}

enum SubscriptionTier {
  free
  basic
  pro
}

// ============================================
// USERS & AUTH
// ============================================

model User {
  id            String   @id @default(uuid())
  email         String   @unique @db.VarChar(255)
  password_hash String?  @db.VarChar(255)
  role          UserRole @default(parent)
  
  created_at    DateTime @default(now()) @db.Timestamptz
  updated_at    DateTime @updatedAt @db.Timestamptz
  
  provider      Provider?
  family_profile FamilyProfile?
  saved_events  SavedEvent[]
  plans         Plan[]
  
  @@map("users")
}

enum UserRole {
  parent
  provider
  admin
}

model FamilyProfile {
  id                   String   @id @default(uuid())
  user_id              String   @unique
  user                 User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  children_ages        Json?    @default("[]") // [{name, birthdate}]
  preferred_radius_km  Int?     @db.SmallInt
  preferred_categories Json?    @default("[]")
  
  home_lat             Decimal? @db.Decimal(10, 8)
  home_lng             Decimal? @db.Decimal(11, 8)
  
  updated_at           DateTime @updatedAt @db.Timestamptz
  
  @@map("family_profiles")
}

// ============================================
// USER FEATURES
// ============================================

model SavedEvent {
  user_id   String
  user      User   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  event_id  String
  event     CanonicalEvent @relation(fields: [event_id], references: [id], onDelete: Cascade)
  
  saved_at  DateTime @default(now()) @db.Timestamptz
  
  @@id([user_id, event_id])
  @@map("saved_events")
}

model Plan {
  id            String   @id @default(uuid())
  user_id       String?
  user          User?    @relation(fields: [user_id], references: [id], onDelete: SetNull)
  
  title         String?  @db.VarChar(200)
  date          DateTime @db.Date
  
  children_ages Json?    @default("[]")
  budget        Decimal? @db.Decimal(8, 2)
  preferences   Json?
  
  route_data    Json?
  
  created_at    DateTime @default(now()) @db.Timestamptz
  
  slots         PlanSlot[]
  plan_b_slots  PlanSlot[] @relation("PlanBSlots")
  
  @@index([user_id])
  @@map("plans")
}

model PlanSlot {
  id              String   @id @default(uuid())
  plan_id         String
  plan            Plan     @relation(fields: [plan_id], references: [id], onDelete: Cascade)
  plan_b_for_id   String?
  plan_b_for      Plan?    @relation("PlanBSlots", fields: [plan_b_for_id], references: [id])
  
  event_id        String?
  event           CanonicalEvent? @relation(fields: [event_id], references: [id])
  
  slot_type       SlotType @default(activity)
  start_time      DateTime @db.Timestamptz
  end_time        DateTime @db.Timestamptz
  duration_minutes Int
  
  notes           String?  @db.Text
  
  @@index([plan_id])
  @@map("plan_slots")
}

enum SlotType {
  activity
  break
  travel
}
