---
import BaseLayout from '../layouts/BaseLayout.astro';
import StickyHeader from '../components/layout/StickyHeader.astro';
import EventCardNew from '../components/feed/EventCardNew.astro';
import EventMap from '../components/map/EventMap.astro';

// Get search params from URL
const url = new URL(Astro.request.url);
const searchQuery = url.searchParams.get('q') || '';
const category = url.searchParams.get('category') || url.searchParams.get('categories') || '';
const categoriesParam = url.searchParams.getAll('category').length ? url.searchParams.getAll('category').join(',') : category;
const tab = url.searchParams.get('tab') || url.searchParams.get('date') || '';
const dateParam = url.searchParams.get('date'); // custom date when not using tab
const indoor = url.searchParams.get('indoor') === 'true';
const outdoor = url.searchParams.get('outdoor') === 'true';
const ageMin = url.searchParams.get('ageMin') ?? '';
const ageMax = url.searchParams.get('ageMax') ?? '';
const priceMax = url.searchParams.get('priceMax') ?? '';
const page = url.searchParams.get('page') || '1';
const sort = url.searchParams.get('sort') || 'soonest';
const lat = url.searchParams.get('lat') || '';
const lng = url.searchParams.get('lng') || '';
const radius = url.searchParams.get('radius') || '20';

// API Base URL
const API_BASE = import.meta.env.PUBLIC_API_URL || 'http://localhost:4000';

// Compute date for "morgen" when tab is morgen
const effectiveTab = tab === 'morgen' ? '' : (tab || '');
const tomorrowIso = (() => { const d = new Date(); d.setDate(d.getDate() + 1); return d.toISOString().slice(0, 10); })();

// Fetch events
let events: any[] = [];
let totalResults = 0;
let pagination: any = null;

try {
  const params = new URLSearchParams();
  if (searchQuery) params.set('q', searchQuery);
  if (categoriesParam) params.set('categories', categoriesParam);
  if (indoor) params.set('indoor', 'true');
  if (outdoor) params.set('outdoor', 'true');
  if (effectiveTab) params.set('tab', effectiveTab);
  if (tab === 'morgen') params.set('date', tomorrowIso);
  if (dateParam && tab !== 'morgen') params.set('date', dateParam);
  if (ageMin !== '') params.set('ageMin', ageMin);
  if (ageMax !== '') params.set('ageMax', ageMax);
  if (priceMax !== '') params.set('priceMax', priceMax);
  if (lat) params.set('lat', lat);
  if (lng) params.set('lng', lng);
  if (radius) params.set('radius', radius);
  params.set('page', page);
  params.set('limit', '24');
  params.set('sort', sort);

  const response = await fetch(`${API_BASE}/api/events?${params.toString()}`);
  if (response.ok) {
    const data = await response.json();
    events = data.data || [];
    totalResults = data.pagination?.total || events.length;
    pagination = data.pagination;
  }
} catch (error) {
  console.error('Error fetching events:', error);
}

// Keine Dummy-Daten: Nur echte API-Ergebnisse anzeigen.

// Format date helper (z.B. "Mo, 3. Feb")
const formatDate = (datetime: string | undefined) => {
  if (!datetime) return undefined;
  try {
    return new Date(datetime).toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'short' });
  } catch {
    return undefined;
  }
};

// Format time helper
const formatTime = (datetime: string | undefined) => {
  if (!datetime) return undefined;
  try {
    return new Date(datetime).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  } catch {
    return undefined;
  }
};

// Categories
const categories = [
  { id: 'museum', label: 'Museen', icon: 'ğŸ›ï¸' },
  { id: 'sport', label: 'Sport', icon: 'âš½' },
  { id: 'natur', label: 'Natur', icon: 'ğŸŒ³' },
  { id: 'musik', label: 'Musik', icon: 'ğŸµ' },
  { id: 'theater', label: 'Theater', icon: 'ğŸ­' },
  { id: 'workshop', label: 'Workshop', icon: 'ğŸ¨' },
  { id: 'ferienlager', label: 'Ferienlager', icon: 'â›º' },
];

// Filter events with coordinates for map view
const eventsWithCoords = events.filter(e => {
  const hasLat = e.location_lat != null && e.location_lat !== '';
  const hasLng = e.location_lng != null && e.location_lng !== '';
  return hasLat && hasLng;
});

// Calculate pagination page numbers
const paginationPages: (number | string)[] = [];
if (pagination && pagination.totalPages > 1) {
  const currentPage = pagination.page;
  const totalPages = pagination.totalPages;

  if (totalPages <= 7) {
    // Show all pages
    for (let i = 1; i <= totalPages; i++) {
      paginationPages.push(i);
    }
  } else {
    // Show with ellipsis
    if (currentPage <= 3) {
      paginationPages.push(1, 2, 3, 4, '...', totalPages);
    } else if (currentPage >= totalPages - 2) {
      paginationPages.push(1, '...', totalPages - 3, totalPages - 2, totalPages - 1, totalPages);
    } else {
      paginationPages.push(1, '...', currentPage - 1, currentPage, currentPage + 1, '...', totalPages);
    }
  }
}
---

<BaseLayout title="Events suchen - kiezling Karlsruhe">
  <StickyHeader />
  
  <main class="min-h-screen bg-gray-50">
    <!-- Search Header -->
    <section class="bg-white border-b border-gray-100 py-6">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Search Input -->
        <div class="max-w-2xl mx-auto mb-6">
          <form action="/suche" method="get" class="flex gap-2">
            <div class="flex-1 relative">
              <input 
                type="text" 
                name="q"
                value={searchQuery}
                placeholder="Suche nach Events, Orten, AktivitÃ¤ten..."
                class="input-field pr-12"
              />
              <button type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-primary-500">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </button>
            </div>
          </form>
        </div>

        <!-- Quick Filter Chips -->
        <div class="flex flex-wrap gap-2 justify-center">
          <a href="/suche?tab=heute" class:list={["chip", (tab || 'heute') === 'heute' && "chip-active"]}>
            ğŸ“… Heute
          </a>
          <a href="/suche?tab=wochenende" class:list={["chip", tab === 'wochenende' && "chip-active"]}>
            ğŸŒŸ Wochenende
          </a>
          <a href="/suche?indoor=true" class:list={["chip", indoor && "chip-active"]}>
            ğŸ  Indoor
          </a>
          <a href="/suche?outdoor=true" class:list={["chip", outdoor && "chip-active"]}>
            ğŸŒ³ Outdoor
          </a>
          <a href="/suche?priceMax=0" class:list={["chip", priceMax === '0' && "chip-active"]}>
            âœ¨ Kostenlos
          </a>
        </div>
      </div>
    </section>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="lg:grid lg:grid-cols-[280px_1fr] lg:gap-8">
        
        <!-- Sidebar Filters (Desktop) -->
        <aside class="hidden lg:block">
          <div class="bg-white rounded-2xl shadow-card p-6 sticky top-36">
            <div class="flex items-center justify-between mb-6">
              <h3 class="font-semibold text-gray-900">Filter</h3>
              <a href="/suche" class="text-sm text-primary-600 hover:text-primary-700">ZurÃ¼cksetzen</a>
            </div>

            <form id="sidebar-filters" class="space-y-0">
            <!-- Date Filter -->
            <div class="mb-6 pb-6 border-b border-gray-100">
              <h4 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Datum</h4>
              <div class="space-y-2">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="radio" name="tab" value="heute" class="accent-primary-500" checked={!tab || tab === 'heute'} />
                  <span class="text-sm">Heute</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="radio" name="tab" value="morgen" class="accent-primary-500" checked={tab === 'morgen'} />
                  <span class="text-sm">Morgen</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="radio" name="tab" value="wochenende" class="accent-primary-500" checked={tab === 'wochenende'} />
                  <span class="text-sm">Wochenende</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="radio" name="tab" value="ferien" class="accent-primary-500" checked={tab === 'ferien' || tab === 'woche'} />
                  <span class="text-sm">Diese Woche / Ferien</span>
                </label>
              </div>
            </div>

            <!-- Age Filter -->
            <div class="mb-6 pb-6 border-b border-gray-100">
              <h4 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Alter</h4>
              <div class="flex flex-wrap gap-2">
                <label class="cursor-pointer">
                  <input type="radio" name="ageRange" value="" class="hidden peer" checked={ageMin === '' && ageMax === ''} />
                  <span class="chip peer-checked:chip-active">Egal</span>
                </label>
                <label class="cursor-pointer">
                  <input type="radio" name="ageRange" value="0-2" class="hidden peer" checked={ageMin === '0' && ageMax === '2'} />
                  <span class="chip peer-checked:chip-active">0-2 J.</span>
                </label>
                <label class="cursor-pointer">
                  <input type="radio" name="ageRange" value="3-5" class="hidden peer" checked={ageMin === '3' && ageMax === '5'} />
                  <span class="chip peer-checked:chip-active">3-5 J.</span>
                </label>
                <label class="cursor-pointer">
                  <input type="radio" name="ageRange" value="6-9" class="hidden peer" checked={ageMin === '6' && ageMax === '9'} />
                  <span class="chip peer-checked:chip-active">6-9 J.</span>
                </label>
                <label class="cursor-pointer">
                  <input type="radio" name="ageRange" value="10-18" class="hidden peer" checked={ageMin === '10' && ageMax === '18'} />
                  <span class="chip peer-checked:chip-active">10+ J.</span>
                </label>
              </div>
            </div>

            <!-- Price Filter -->
            <div class="mb-6 pb-6 border-b border-gray-100">
              <h4 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Preis</h4>
              <div class="space-y-2">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="radio" name="priceMax" value="" class="accent-primary-500" checked={priceMax === ''} />
                  <span class="text-sm">Alle Preise</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="radio" name="priceMax" value="0" class="accent-primary-500" checked={priceMax === '0'} />
                  <span class="text-sm">Kostenlos</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="radio" name="priceMax" value="10" class="accent-primary-500" checked={priceMax === '10'} />
                  <span class="text-sm">Bis 10â‚¬</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="radio" name="priceMax" value="30" class="accent-primary-500" checked={priceMax === '30'} />
                  <span class="text-sm">Bis 30â‚¬</span>
                </label>
              </div>
            </div>

            <!-- Category Filter -->
            <div class="mb-6 pb-6 border-b border-gray-100">
              <h4 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Kategorie</h4>
              <div class="space-y-2">
                {categories.map(cat => (
                  <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" name="category" value={cat.id} class="accent-primary-500" checked={categoriesParam.split(',').includes(cat.id)} />
                    <span class="text-sm">{cat.icon} {cat.label}</span>
                  </label>
                ))}
              </div>
            </div>

            <!-- Indoor/Outdoor Filter -->
            <div class="mb-6 pb-6 border-b border-gray-100">
              <h4 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Drinnen/DrauÃŸen</h4>
              <div class="space-y-2">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="checkbox" name="indoor" value="true" class="accent-primary-500" checked={indoor} />
                  <span class="text-sm">ğŸ  Indoor</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="checkbox" name="outdoor" value="true" class="accent-primary-500" checked={outdoor} />
                  <span class="text-sm">ğŸŒ¤ï¸ Outdoor</span>
                </label>
              </div>
            </div>

            <!-- Family Extras Filter -->
            <div class="mb-6 pb-6 border-b border-gray-100">
              <h4 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Familien-Extras</h4>
              <div class="space-y-2">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="checkbox" name="hasSeating" value="true" class="accent-primary-500" checked={url.searchParams.get('hasSeating') === 'true'} />
                  <span class="text-sm">ğŸ’º Mit SitzplÃ¤tzen</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="checkbox" name="hasParking" value="true" class="accent-primary-500" checked={url.searchParams.get('hasParking') === 'true'} />
                  <span class="text-sm">ğŸ…¿ï¸ Mit Parkplatz</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="checkbox" name="siblingFriendly" value="true" class="accent-primary-500" checked={url.searchParams.get('siblingFriendly') === 'true'} />
                  <span class="text-sm">ğŸ‘¶ Geschwister willkommen</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="checkbox" name="isRecurring" value="true" class="accent-primary-500" checked={url.searchParams.get('isRecurring') === 'true'} />
                  <span class="text-sm">ğŸ”„ Wiederkehrend</span>
                </label>
              </div>
            </div>

            <!-- Noise Level Filter -->
            <div class="mb-6">
              <h4 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">LautstÃ¤rke</h4>
              <div class="space-y-2">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="radio" name="noiseLevel" value="" class="accent-primary-500" checked={!url.searchParams.get('noiseLevel')} />
                  <span class="text-sm">Egal</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="radio" name="noiseLevel" value="quiet" class="accent-primary-500" checked={url.searchParams.get('noiseLevel') === 'quiet'} />
                  <span class="text-sm">ğŸ”‡ Ruhig</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="radio" name="noiseLevel" value="moderate" class="accent-primary-500" checked={url.searchParams.get('noiseLevel') === 'moderate'} />
                  <span class="text-sm">ğŸ”‰ Normal</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="radio" name="noiseLevel" value="loud" class="accent-primary-500" checked={url.searchParams.get('noiseLevel') === 'loud'} />
                  <span class="text-sm">ğŸ”Š Laut</span>
                </label>
              </div>
            </div>
            <button type="submit" class="btn-primary w-full py-3">Anwenden</button>
            </form>
          </div>
        </aside>

        <!-- Results -->
        <div>
          <!-- Results Header -->
          <div class="flex items-center justify-between mb-4">
            <p class="text-gray-600">
              <span class="font-medium text-gray-900">{totalResults}</span> Events gefunden
              {searchQuery && <span> fÃ¼r â€{searchQuery}"</span>}
            </p>
            <div class="flex items-center gap-2">
              <button class="p-2 rounded-lg border transition-colors view-toggle" id="view-list" title="Listenansicht" data-active="true">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                </svg>
              </button>
              <button class="p-2 rounded-lg border transition-colors view-toggle" id="view-map" title="Kartenansicht" data-active="false">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Sort Dropdown -->
          <div class="flex items-center justify-end mb-6">
            <select id="sort-select" class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white">
              <option value="soonest" selected={sort === 'soonest'}>NÃ¤chste zuerst</option>
              <option value="newest" selected={sort === 'newest'}>Neueste zuerst</option>
              <option value="relevance" selected={sort === 'relevance'}>Beste Empfehlungen</option>
              <option value="nearest" selected={sort === 'nearest'}>In meiner NÃ¤he</option>
            </select>
          </div>

          <!-- Results Grid -->
          <div id="results-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4 md:gap-6">
            {events.map((event) => (
              <EventCardNew
                id={event.id}
                title={event.title}
                imageUrl={event.image_urls?.[0]}
                date={formatDate(event.start_datetime)}
                startTime={formatTime(event.start_datetime)}
                priceType={event.price_type}
                priceMin={event.price_min}
                ageMin={event.age_min}
                ageMax={event.age_max}
                isIndoor={event.is_indoor}
                isOutdoor={event.is_outdoor}
                stressfreeScore={event.scores?.stressfree_score}
              />
            ))}
          </div>

          <!-- Map View (hidden by default) -->
          <div id="results-map" class="hidden">
            {eventsWithCoords.length > 0 ? (
              <EventMap 
                events={eventsWithCoords}
                userLat={lat ? parseFloat(lat) : undefined}
                userLng={lng ? parseFloat(lng) : undefined}
                height="600px"
              />
            ) : (
              <div class="bg-white rounded-2xl shadow-card p-12 text-center">
                <span class="text-4xl mb-2 block">ğŸ“</span>
                <p class="text-gray-500">Keine Events mit Standort-Daten gefunden</p>
              </div>
            )}
          </div>

          <!-- Pagination -->
          {pagination && pagination.totalPages > 1 && (
            <div class="flex justify-center gap-2 mt-8 flex-wrap">
              <!-- Previous Button -->
              <a 
                href={pagination.hasPrev ? `?${new URLSearchParams({...Object.fromEntries(url.searchParams), page: String(pagination.page - 1)}).toString()}` : '#'}
                class={`px-4 py-2 rounded-lg border ${pagination.hasPrev ? 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50' : 'bg-gray-100 border-gray-200 text-gray-400 cursor-not-allowed'}`}
                aria-disabled={!pagination.hasPrev}
              >
                &larr; ZurÃ¼ck
              </a>

              <!-- Page Numbers -->
              {paginationPages.map((pageNum, idx) => {
                if (pageNum === '...') {
                  return <span class="px-3 py-2 text-gray-400">...</span>;
                }
                const isActive = pageNum === pagination.page;
                return (
                  <a
                    href={`?${new URLSearchParams({...Object.fromEntries(url.searchParams), page: String(pageNum)}).toString()}`}
                    class={`px-4 py-2 rounded-lg ${isActive ? 'bg-primary-500 text-white' : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-50'}`}
                  >
                    {pageNum}
                  </a>
                );
              })}

              <!-- Next Button -->
              <a 
                href={pagination.hasNext ? `?${new URLSearchParams({...Object.fromEntries(url.searchParams), page: String(pagination.page + 1)}).toString()}` : '#'}
                class={`px-4 py-2 rounded-lg border ${pagination.hasNext ? 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50' : 'bg-gray-100 border-gray-200 text-gray-400 cursor-not-allowed'}`}
                aria-disabled={!pagination.hasNext}
              >
                Weiter &rarr;
              </a>
            </div>
          )}
        </div>
      </div>
    </div>

    <!-- Mobile Filter Button -->
    <button 
      id="mobile-filter-btn"
      class="lg:hidden fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 bg-primary-500 text-white rounded-full shadow-lg font-medium flex items-center gap-2 z-40"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
      </svg>
      Filter
    </button>

    <!-- Mobile Filter Modal -->
    <div id="mobile-filter-modal" class="hidden fixed inset-0 z-50">
      <div class="absolute inset-0 bg-black/50" id="modal-backdrop"></div>
      <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl max-h-[80vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-100 px-4 py-4 flex items-center justify-between">
          <h3 class="font-semibold text-lg">Filter</h3>
          <button id="close-modal" class="p-2 hover:bg-gray-100 rounded-full">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <form id="mobile-filters" class="p-4 space-y-6">
          <div>
            <h4 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Datum</h4>
            <div class="flex flex-wrap gap-2">
              <label class="cursor-pointer"><input type="radio" name="tab" value="heute" class="sr-only peer" checked={!tab || tab === 'heute'} /><span class="chip peer-checked:chip-active">Heute</span></label>
              <label class="cursor-pointer"><input type="radio" name="tab" value="morgen" class="sr-only peer" checked={tab === 'morgen'} /><span class="chip peer-checked:chip-active">Morgen</span></label>
              <label class="cursor-pointer"><input type="radio" name="tab" value="wochenende" class="sr-only peer" checked={tab === 'wochenende'} /><span class="chip peer-checked:chip-active">Wochenende</span></label>
              <label class="cursor-pointer"><input type="radio" name="tab" value="ferien" class="sr-only peer" checked={tab === 'ferien' || tab === 'woche'} /><span class="chip peer-checked:chip-active">Woche</span></label>
            </div>
          </div>
          <div>
            <h4 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Alter</h4>
            <div class="flex flex-wrap gap-2">
              <label class="cursor-pointer"><input type="radio" name="ageRange" value="" class="sr-only peer" checked={ageMin === '' && ageMax === ''} /><span class="chip peer-checked:chip-active">Egal</span></label>
              <label class="cursor-pointer"><input type="radio" name="ageRange" value="0-2" class="sr-only peer" checked={ageMin === '0' && ageMax === '2'} /><span class="chip peer-checked:chip-active">0-2 J.</span></label>
              <label class="cursor-pointer"><input type="radio" name="ageRange" value="3-5" class="sr-only peer" checked={ageMin === '3' && ageMax === '5'} /><span class="chip peer-checked:chip-active">3-5 J.</span></label>
              <label class="cursor-pointer"><input type="radio" name="ageRange" value="6-9" class="sr-only peer" checked={ageMin === '6' && ageMax === '9'} /><span class="chip peer-checked:chip-active">6-9 J.</span></label>
              <label class="cursor-pointer"><input type="radio" name="ageRange" value="10-18" class="sr-only peer" checked={ageMin === '10' && ageMax === '18'} /><span class="chip peer-checked:chip-active">10+ J.</span></label>
            </div>
          </div>
          <div>
            <h4 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Preis</h4>
            <div class="flex flex-wrap gap-2">
              <label class="cursor-pointer"><input type="radio" name="priceMax" value="" class="sr-only peer" checked={priceMax === ''} /><span class="chip peer-checked:chip-active">Egal</span></label>
              <label class="cursor-pointer"><input type="radio" name="priceMax" value="0" class="sr-only peer" checked={priceMax === '0'} /><span class="chip peer-checked:chip-active">Kostenlos</span></label>
              <label class="cursor-pointer"><input type="radio" name="priceMax" value="10" class="sr-only peer" checked={priceMax === '10'} /><span class="chip peer-checked:chip-active">Bis 10â‚¬</span></label>
              <label class="cursor-pointer"><input type="radio" name="priceMax" value="30" class="sr-only peer" checked={priceMax === '30'} /><span class="chip peer-checked:chip-active">Bis 30â‚¬</span></label>
            </div>
          </div>
          <div>
            <h4 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Kategorien</h4>
            <div class="space-y-2">
              {categories.map((cat) => (
                <label class="flex items-center gap-2 cursor-pointer">
                  <input 
                    type="checkbox" 
                    name="category" 
                    value={cat.id}
                    checked={categoriesParam.split(',').includes(cat.id)}
                    class="rounded text-primary-500 focus:ring-primary-500"
                  />
                  <span class="text-sm">{cat.icon} {cat.label}</span>
                </label>
              ))}
            </div>
          </div>
          <div>
            <h4 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Drinnen/DrauÃŸen</h4>
            <div class="flex flex-wrap gap-2">
              <label class="cursor-pointer"><input type="checkbox" name="indoor" value="true" class="sr-only peer" checked={indoor} /><span class="chip peer-checked:chip-active">ğŸ  Indoor</span></label>
              <label class="cursor-pointer"><input type="checkbox" name="outdoor" value="true" class="sr-only peer" checked={outdoor} /><span class="chip peer-checked:chip-active">ğŸŒ¤ï¸ Outdoor</span></label>
            </div>
          </div>
          <div>
            <h4 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Familien-Extras</h4>
            <div class="flex flex-wrap gap-2">
              <label class="cursor-pointer"><input type="checkbox" name="hasSeating" value="true" class="sr-only peer" checked={url.searchParams.get('hasSeating') === 'true'} /><span class="chip peer-checked:chip-active">ğŸ’º SitzplÃ¤tze</span></label>
              <label class="cursor-pointer"><input type="checkbox" name="hasParking" value="true" class="sr-only peer" checked={url.searchParams.get('hasParking') === 'true'} /><span class="chip peer-checked:chip-active">ğŸ…¿ï¸ Parkplatz</span></label>
              <label class="cursor-pointer"><input type="checkbox" name="siblingFriendly" value="true" class="sr-only peer" checked={url.searchParams.get('siblingFriendly') === 'true'} /><span class="chip peer-checked:chip-active">ğŸ‘¶ Geschwister</span></label>
              <label class="cursor-pointer"><input type="checkbox" name="isRecurring" value="true" class="sr-only peer" checked={url.searchParams.get('isRecurring') === 'true'} /><span class="chip peer-checked:chip-active">ğŸ”„ Wiederkehrend</span></label>
            </div>
          </div>
          <div>
            <h4 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">LautstÃ¤rke</h4>
            <div class="flex flex-wrap gap-2">
              <label class="cursor-pointer"><input type="radio" name="noiseLevel" value="" class="sr-only peer" checked={!url.searchParams.get('noiseLevel')} /><span class="chip peer-checked:chip-active">Egal</span></label>
              <label class="cursor-pointer"><input type="radio" name="noiseLevel" value="quiet" class="sr-only peer" checked={url.searchParams.get('noiseLevel') === 'quiet'} /><span class="chip peer-checked:chip-active">ğŸ”‡ Ruhig</span></label>
              <label class="cursor-pointer"><input type="radio" name="noiseLevel" value="moderate" class="sr-only peer" checked={url.searchParams.get('noiseLevel') === 'moderate'} /><span class="chip peer-checked:chip-active">ğŸ”‰ Normal</span></label>
              <label class="cursor-pointer"><input type="radio" name="noiseLevel" value="loud" class="sr-only peer" checked={url.searchParams.get('noiseLevel') === 'loud'} /><span class="chip peer-checked:chip-active">ğŸ”Š Laut</span></label>
            </div>
          </div>
        </form>
        <div class="sticky bottom-0 bg-white border-t border-gray-100 p-4 flex gap-3">
          <a href="/suche" class="flex-1 btn-secondary text-center">ZurÃ¼cksetzen</a>
          <button type="button" class="flex-1 btn-primary" id="apply-filters">Anwenden</button>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<script>
  // View toggle
  const viewList = document.getElementById('view-list');
  const viewMap = document.getElementById('view-map');
  const resultsGrid = document.getElementById('results-grid');
  const resultsMap = document.getElementById('results-map');

  function updateViewToggle(activeView: 'list' | 'map') {
    const listBtn = document.getElementById('view-list');
    const mapBtn = document.getElementById('view-map');
    
    if (activeView === 'list') {
      listBtn?.classList.add('bg-primary-500', 'text-white', 'border-primary-500');
      listBtn?.classList.remove('bg-white', 'text-gray-600', 'border-gray-200');
      mapBtn?.classList.add('bg-white', 'text-gray-600', 'border-gray-200');
      mapBtn?.classList.remove('bg-primary-500', 'text-white', 'border-primary-500');
    } else {
      mapBtn?.classList.add('bg-primary-500', 'text-white', 'border-primary-500');
      mapBtn?.classList.remove('bg-white', 'text-gray-600', 'border-gray-200');
      listBtn?.classList.add('bg-white', 'text-gray-600', 'border-gray-200');
      listBtn?.classList.remove('bg-primary-500', 'text-white', 'border-primary-500');
    }
  }

  function showListView() {
    resultsGrid?.classList.remove('hidden');
    resultsMap?.classList.add('hidden');
    updateViewToggle('list');
  }
  
  function showMapView() {
    resultsGrid?.classList.add('hidden');
    resultsMap?.classList.remove('hidden');
    updateViewToggle('map');
  }

  viewList?.addEventListener('click', showListView);
  viewMap?.addEventListener('click', showMapView);

  // Initialize view toggle state
  updateViewToggle('list');

  // Von /entdecken weitergeleitet: Kartenansicht anzeigen
  if (new URLSearchParams(window.location.search).get('view') === 'map') {
    setTimeout(() => showMapView(), 100); // Delay to ensure map container is ready
  }

  // Sort dropdown handler
  const sortSelect = document.getElementById('sort-select');
  sortSelect?.addEventListener('change', (e) => {
    const selectedSort = (e.target as HTMLSelectElement).value;
    const urlParams = new URLSearchParams(window.location.search);
    
    // If "nearest" selected, request geolocation
    if (selectedSort === 'nearest') {
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            urlParams.set('sort', 'nearest');
            urlParams.set('lat', String(position.coords.latitude));
            urlParams.set('lng', String(position.coords.longitude));
            urlParams.set('page', '1'); // Reset to first page
            window.location.href = '/suche?' + urlParams.toString();
          },
          () => {
            alert('Standort-Zugriff erforderlich fÃ¼r "In meiner NÃ¤he"');
            // Reset to default
            (e.target as HTMLSelectElement).value = 'soonest';
          }
        );
      } else {
        alert('Geolocation wird nicht unterstÃ¼tzt');
        (e.target as HTMLSelectElement).value = 'soonest';
      }
    } else {
      urlParams.set('sort', selectedSort);
      urlParams.set('page', '1'); // Reset to first page
      // Remove geo params if not using nearest
      urlParams.delete('lat');
      urlParams.delete('lng');
      window.location.href = '/suche?' + urlParams.toString();
    }
  });

  // Filter â†’ URL (sidebar oder mobile form)
  function buildSearchParams(root?: HTMLElement | null) {
    const base = root || document;
    const q = new URLSearchParams(window.location.search).get('q') || '';
    const view = new URLSearchParams(window.location.search).get('view') || '';
    const tab = (base.querySelector('input[name="tab"]:checked') as HTMLInputElement)?.value || '';
    const ageRange = (base.querySelector('input[name="ageRange"]:checked') as HTMLInputElement)?.value || '';
    const priceMax = (base.querySelector('input[name="priceMax"]:checked') as HTMLInputElement)?.value ?? '';
    const cats = Array.from(base.querySelectorAll('input[name="category"]:checked')).map((el: Element) => (el as HTMLInputElement).value);
    const indoor = (base.querySelector('input[name="indoor"]') as HTMLInputElement)?.checked;
    const outdoor = (base.querySelector('input[name="outdoor"]') as HTMLInputElement)?.checked;
    // New filters
    const hasSeating = (base.querySelector('input[name="hasSeating"]') as HTMLInputElement)?.checked;
    const hasParking = (base.querySelector('input[name="hasParking"]') as HTMLInputElement)?.checked;
    const siblingFriendly = (base.querySelector('input[name="siblingFriendly"]') as HTMLInputElement)?.checked;
    const isRecurring = (base.querySelector('input[name="isRecurring"]') as HTMLInputElement)?.checked;
    const noiseLevel = (base.querySelector('input[name="noiseLevel"]:checked') as HTMLInputElement)?.value || '';
    
    const p = new URLSearchParams();
    if (q) p.set('q', q);
    if (view) p.set('view', view);
    if (tab) p.set('tab', tab);
    if (ageRange) {
      const [min, max] = ageRange.split('-').map(Number);
      if (!isNaN(min)) p.set('ageMin', String(min));
      if (!isNaN(max)) p.set('ageMax', String(max));
    }
    if (priceMax !== '') p.set('priceMax', priceMax);
    cats.forEach(c => p.append('category', c));
    if (indoor) p.set('indoor', 'true');
    if (outdoor) p.set('outdoor', 'true');
    // New filter params
    if (hasSeating) p.set('hasSeating', 'true');
    if (hasParking) p.set('hasParking', 'true');
    if (siblingFriendly) p.set('siblingFriendly', 'true');
    if (isRecurring) p.set('isRecurring', 'true');
    if (noiseLevel) p.set('noiseLevel', noiseLevel);
    return p;
  }
  document.getElementById('sidebar-filters')?.addEventListener('submit', (e) => {
    e.preventDefault();
    window.location.href = '/suche?' + buildSearchParams(document.getElementById('sidebar-filters')).toString();
  });
  document.getElementById('apply-filters')?.addEventListener('click', () => {
    document.getElementById('mobile-filter-modal')?.classList.add('hidden');
    document.body.style.overflow = '';
    window.location.href = '/suche?' + buildSearchParams(document.getElementById('mobile-filters')).toString();
  });

  const mobileFilterBtn = document.getElementById('mobile-filter-btn');
  const mobileFilterModal = document.getElementById('mobile-filter-modal');
  const modalBackdrop = document.getElementById('modal-backdrop');
  const closeModal = document.getElementById('close-modal');
  function closeFilterModal() {
    mobileFilterModal?.classList.add('hidden');
    document.body.style.overflow = '';
  }
  mobileFilterBtn?.addEventListener('click', () => {
    mobileFilterModal?.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  });
  modalBackdrop?.addEventListener('click', closeFilterModal);
  closeModal?.addEventListener('click', closeFilterModal);
</script>
