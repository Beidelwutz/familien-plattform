---
import BaseLayout from '../../layouts/BaseLayout.astro';
import StickyHeader from '../../components/layout/StickyHeader.astro';
import EventCardNew from '../../components/feed/EventCardNew.astro';

const { slug } = Astro.params;
const API_BASE = import.meta.env.PUBLIC_API_URL || 'http://localhost:4000';

let event: any = null;
let similarEvents: any[] = [];

if (slug) {
  try {
    const [eventRes, similarRes] = await Promise.all([
      fetch(`${API_BASE}/api/events/${slug}`),
      fetch(`${API_BASE}/api/events/${slug}/similar`),
    ]);
    if (eventRes.ok) {
      const data = await eventRes.json();
      event = data.data;
    }
    if (similarRes.ok) {
      const data = await similarRes.json();
      similarEvents = data.data || [];
    }
  } catch (err) {
    console.error('Error fetching event:', err);
  }
}

const formatDate = (d: string | undefined) =>
  d ? new Date(d).toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }) : '';
const formatTime = (d: string | undefined) =>
  d ? new Date(d).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : '';
const formatPrice = (e: any) => {
  if (e?.price_type === 'free') return 'Kostenlos';
  if (e?.price_min) return `ab ${e.price_min}â‚¬`;
  return 'Preis auf Anfrage';
};
---

<BaseLayout title={event ? `${event.title} - kiezling` : 'Event - kiezling'}>
  <StickyHeader />

  {!event ? (
    <main class="min-h-screen bg-gray-50 py-12">
      <div class="max-w-4xl mx-auto px-4 text-center">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Event nicht gefunden</h1>
        <p class="text-gray-500 mb-6">Das gesuchte Event existiert nicht oder wurde entfernt.</p>
        <a href="/suche" class="btn-primary">Zur Suche</a>
      </div>
    </main>
  ) : (
    <main class="min-h-screen bg-gray-50">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Breadcrumb -->
        <nav class="flex items-center gap-2 text-sm text-gray-500 mb-6">
          <a href="/" class="text-primary-600 hover:text-primary-700">Start</a>
          <span>/</span>
          <a href="/suche" class="text-primary-600 hover:text-primary-700">Events</a>
          <span>/</span>
          <span class="text-gray-700 truncate max-w-[200px]">{event.title}</span>
        </nav>

        <!-- Hero -->
        <div class="rounded-2xl overflow-hidden bg-gray-100 aspect-[21/9] mb-6">
          {event.image_urls?.[0] ? (
            <img
              src={event.image_urls[0]}
              alt={event.title}
              class="w-full h-full object-cover"
            />
          ) : (
            <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-primary-100 to-primary-50">
              <span class="text-6xl">ğŸˆ</span>
            </div>
          )}
        </div>

        <!-- Header Card -->
        <div class="bg-white rounded-2xl shadow-card p-6 mb-6">
          <div class="flex flex-wrap gap-2 mb-4">
            {event.is_indoor && <span class="badge badge-indoor">ğŸ  Indoor</span>}
            {event.is_outdoor && <span class="badge badge-outdoor">ğŸŒ³ Outdoor</span>}
            {event.price_type === 'free' && <span class="badge badge-free">Kostenlos</span>}
            {event.categories?.map((c: any) => (
              <span class="badge bg-primary-100 text-primary-700">
                {c.category?.icon || ''} {c.category?.name_de || c.category?.slug || ''}
              </span>
            ))}
          </div>
          <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-4">{event.title}</h1>

          <div class="flex flex-wrap gap-6 text-gray-600 mb-4">
            <span class="flex items-center gap-2">
              <span>ğŸ“…</span>
              {formatDate(event.start_datetime)}
            </span>
            <span class="flex items-center gap-2">
              <span>â°</span>
              {formatTime(event.start_datetime)} Uhr
            </span>
            <span class="flex items-center gap-2">
              <span>ğŸ“</span>
              {event.location_district || event.location_address || 'Karlsruhe'}
            </span>
            <span class="flex items-center gap-2">
              <span>ğŸ’°</span>
              {formatPrice(event)}
            </span>
          </div>

          {(event.scores?.stressfree_score || event.scores?.family_fit_score) && (
            <div class="flex gap-6 pt-4 border-t border-gray-100">
              {event.scores.family_fit_score != null && (
                <span class="flex items-center gap-2" title="Familienfreundlichkeit">
                  <span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>
                  <span class="font-semibold text-primary-600">{event.scores.family_fit_score}%</span>
                </span>
              )}
              {event.scores.stressfree_score != null && (
                <span class="flex items-center gap-2" title="Stressfrei-Score">
                  <span>ğŸ˜Œ</span>
                  <span class="font-semibold text-primary-600">{event.scores.stressfree_score}%</span>
                </span>
              )}
            </div>
          )}

          <div class="flex flex-wrap gap-3 mt-6">
            {event.booking_url && (
              <a href={event.booking_url} target="_blank" rel="noopener noreferrer" class="btn-primary">
                Jetzt buchen
              </a>
            )}
            <button type="button" class="btn-secondary" id="add-to-plan-btn">
              ğŸ“‹ Zum Plan hinzufÃ¼gen
            </button>
            <button type="button" class="btn-secondary" id="save-btn" data-event-id={event.id}>
              â¤ï¸ Merken
            </button>
          </div>
        </div>

        <div class="lg:grid lg:grid-cols-[1fr_340px] lg:gap-8">
          <!-- Main -->
          <div class="space-y-6">
            <section class="bg-white rounded-2xl shadow-card p-6">
              <h2 class="text-lg font-semibold text-gray-900 mb-3">Beschreibung</h2>
              <div class="prose prose-gray max-w-none text-gray-600" set:html={event.description_long || event.description_short || '<p>Keine Beschreibung verfÃ¼gbar.</p>'}></div>
            </section>

            {((event.age_min != null) || (event.age_max != null)) && (
              <section class="bg-white rounded-2xl shadow-card p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-3">Altersempfehlung</h2>
                <span class="inline-block px-4 py-2 bg-gray-100 rounded-xl font-medium">
                  {event.age_min != null && event.age_max != null && `${event.age_min}â€“${event.age_max} Jahre`}
                  {event.age_min != null && event.age_max == null && `Ab ${event.age_min} Jahren`}
                  {event.age_min == null && event.age_max != null && `Bis ${event.age_max} Jahre`}
                </span>
              </section>
            )}

            {event.amenities?.length > 0 && (
              <section class="bg-white rounded-2xl shadow-card p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-3">Ausstattung</h2>
                <div class="flex flex-wrap gap-2">
                  {event.amenities.map((a: any) => (
                    <span class="inline-flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg text-sm">
                      {a.amenity?.icon || 'âœ“'} {a.amenity?.name_de || a.amenity?.slug || ''}
                    </span>
                  ))}
                </div>
              </section>
            )}
          </div>

          <!-- Sidebar -->
          <aside class="space-y-6 lg:pt-0">
            <div class="bg-white rounded-2xl shadow-card p-6">
              <h3 class="font-semibold text-gray-900 mb-3">Anfahrt</h3>
              <div class="aspect-[4/3] bg-gray-100 rounded-xl mb-3 flex items-center justify-center">
                {event.location_lat && event.location_lng ? (
                  <a
                    href={`https://www.google.com/maps/dir/?api=1&destination=${event.location_lat},${event.location_lng}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-primary-600 hover:underline"
                  >
                    ğŸ—ºï¸ Karte Ã¶ffnen
                  </a>
                ) : (
                  <span class="text-gray-400">Keine Koordinaten</span>
                )}
              </div>
              {event.location_address && <p class="text-sm text-gray-600">{event.location_address}</p>}
              {event.location_lat && event.location_lng && (
                <a
                  href={`https://www.google.com/maps/dir/?api=1&destination=${event.location_lat},${event.location_lng}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-sm text-primary-600 hover:text-primary-700 mt-2 inline-block"
                >
                  Route berechnen
                </a>
              )}
            </div>

            {(event.contact_email || event.contact_phone || event.booking_url) && (
              <div class="bg-white rounded-2xl shadow-card p-6">
                <h3 class="font-semibold text-gray-900 mb-3">Kontakt</h3>
                <ul class="space-y-2 text-sm text-gray-600">
                  {event.contact_email && <li><a href={`mailto:${event.contact_email}`} class="text-primary-600 hover:underline">{event.contact_email}</a></li>}
                  {event.contact_phone && <li><a href={`tel:${event.contact_phone}`} class="text-primary-600 hover:underline">{event.contact_phone}</a></li>}
                  {event.booking_url && <li><a href={event.booking_url} target="_blank" rel="noopener noreferrer" class="text-primary-600 hover:underline">Zur Buchung</a></li>}
                </ul>
              </div>
            )}

            <div class="bg-gray-50 rounded-2xl p-6">
              <h3 class="font-semibold text-gray-900 mb-2">Quelle</h3>
              {event.primary_source?.source?.name && <p class="text-sm text-gray-600">{event.primary_source.source.name}</p>}
              {event.primary_source?.source_url && (
                <a href={event.primary_source.source_url} target="_blank" rel="noopener noreferrer" class="text-sm text-primary-600 hover:underline">
                  Originalquelle
                </a>
              )}
              {event.last_verified_at && (
                <p class="text-xs text-gray-500 mt-2">Stand: {new Date(event.last_verified_at).toLocaleDateString('de-DE')}</p>
              )}
            </div>
          </aside>
        </div>

        <!-- Similar Events -->
        {similarEvents.length > 0 && (
          <section class="mt-12" id="similar">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Ã„hnliche Events</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
              {similarEvents.map((e: any) => (
                <EventCardNew
                  id={e.id}
                  title={e.title}
                  imageUrl={e.image_urls?.[0]}
                  date={e.start_datetime ? new Date(e.start_datetime).toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'short' }) : undefined}
                  startTime={e.start_datetime ? new Date(e.start_datetime).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : undefined}
                  priceType={e.price_type || 'unknown'}
                  priceMin={e.price_min}
                  ageMin={e.age_min}
                  ageMax={e.age_max}
                  isIndoor={e.is_indoor}
                  isOutdoor={e.is_outdoor}
                  stressfreeScore={e.scores?.stressfree_score}
                />
              ))}
            </div>
          </section>
        )}
      </div>
    </main>
  )}
</BaseLayout>

<script>
  const saveBtn = document.getElementById('save-btn');
  saveBtn?.addEventListener('click', () => {
    const id = saveBtn.getAttribute('data-event-id');
    if (!id) return;
    try {
      const raw = localStorage.getItem('saved_events') || '[]';
      const arr = JSON.parse(raw);
      const idx = arr.indexOf(id);
      if (idx >= 0) arr.splice(idx, 1);
      else arr.push(id);
      localStorage.setItem('saved_events', JSON.stringify(arr));
      (saveBtn as HTMLButtonElement).textContent = arr.includes(id) ? 'â¤ï¸ Gespeichert' : 'â¤ï¸ Merken';
    } catch (_) {}
  });
</script>
