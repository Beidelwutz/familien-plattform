---
import BaseLayout from '../../layouts/BaseLayout.astro';
import StickyHeader from '../../components/layout/StickyHeader.astro';
import EventCardNew from '../../components/feed/EventCardNew.astro';

const { slug } = Astro.params;
const API_BASE = import.meta.env.PUBLIC_API_URL || 'http://localhost:4000';

let event: any = null;
let similarEvents: any[] = [];

if (slug) {
  try {
    const [eventRes, similarRes] = await Promise.all([
      fetch(`${API_BASE}/api/events/${slug}`),
      fetch(`${API_BASE}/api/events/${slug}/similar`),
    ]);
    if (eventRes.ok) {
      const data = await eventRes.json();
      event = data.data;
    }
    if (similarRes.ok) {
      const data = await similarRes.json();
      similarEvents = data.data || [];
    }
  } catch (err) {
    console.error('Error fetching event:', err);
  }
}

// Formatierung Funktionen
const formatDateShort = (d: string | undefined) =>
  d ? new Date(d).toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'short' }) : '';

const formatDate = (d: string | undefined) =>
  d ? new Date(d).toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }) : '';

const formatTime = (d: string | undefined) =>
  d ? new Date(d).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : '';

const formatDateTimeCompact = (start: string | undefined, end: string | undefined) => {
  if (!start) return '';
  const startDate = new Date(start);
  const dateStr = startDate.toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'short' });
  const startTime = startDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  if (end) {
    const endTime = new Date(end).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
    return `${dateStr} â€¢ ${startTime}â€“${endTime}`;
  }
  return `${dateStr} â€¢ ${startTime} Uhr`;
};

const calculateDuration = (start: string | undefined, end: string | undefined) => {
  if (!start || !end) return null;
  const diff = new Date(end).getTime() - new Date(start).getTime();
  const minutes = Math.round(diff / (1000 * 60));
  if (minutes < 60) return `ca. ${minutes} Min.`;
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  if (mins === 0) return `ca. ${hours} Std.`;
  return `ca. ${hours} Std. ${mins} Min.`;
};

const formatPrice = (e: any) => {
  if (e?.price_type === 'free') return 'Kostenlos';
  if (e?.price_min && e?.price_max && e.price_min !== e.price_max) return `${e.price_min}â€“${e.price_max}â‚¬`;
  if (e?.price_min) return `ab ${e.price_min}â‚¬`;
  return 'Preis auf Anfrage';
};

const formatPriceDetails = (details: any) => {
  if (!details) return null;
  const parts = [];
  if (details.adult?.min) parts.push(`Erwachsene: ${details.adult.min}â‚¬`);
  if (details.child?.min) parts.push(`Kinder: ${details.child.min}â‚¬`);
  if (details.family?.min) parts.push(`Familie: ${details.family.min}â‚¬`);
  return parts.length > 0 ? parts : null;
};

const getAvailabilityBadge = (status: string | undefined) => {
  const badges: Record<string, { text: string; class: string }> = {
    available: { text: 'Tickets verfÃ¼gbar', class: 'bg-green-100 text-green-700' },
    sold_out: { text: 'Ausverkauft', class: 'bg-red-100 text-red-700' },
    waitlist: { text: 'Warteliste', class: 'bg-yellow-100 text-yellow-700' },
    registration_required: { text: 'Anmeldung nÃ¶tig', class: 'bg-blue-100 text-blue-700' },
  };
  return status ? badges[status] : null;
};

const getNoiseLevelText = (level: string | undefined) => {
  const levels: Record<string, string> = {
    quiet: 'Ruhig',
    moderate: 'Normal',
    loud: 'Laut',
  };
  return level ? levels[level] : null;
};

const getComplexityText = (level: string | undefined) => {
  const levels: Record<string, string> = {
    simple: 'Leicht verstÃ¤ndlich',
    moderate: 'Normal',
    advanced: 'Mit Fachbegriffen',
  };
  return level ? levels[level] : null;
};

const getCompletenessMessage = (score: number | undefined) => {
  if (score == null) return null;
  if (score >= 80) return { text: 'VollstÃ¤ndige Infos', class: 'text-green-600' };
  if (score >= 50) return { text: 'Einige Infos fehlen noch', class: 'text-yellow-600' };
  return { text: 'Viele Infos fehlen noch', class: 'text-orange-600' };
};

// Berechne Dauer
const duration = event ? calculateDuration(event.start_datetime, event.end_datetime) : null;
const availabilityBadge = event ? getAvailabilityBadge(event.availability_status) : null;
const priceDetailsList = event ? formatPriceDetails(event.price_details) : null;
const completenessMsg = event ? getCompletenessMessage(event.completeness_score) : null;
---

<BaseLayout title={event ? `${event.title} - kiezling` : 'Event - kiezling'}>
  <StickyHeader />

  {!event ? (
    <main class="min-h-screen bg-gray-50 py-12">
      <div class="max-w-4xl mx-auto px-4 text-center">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Event nicht gefunden</h1>
        <p class="text-gray-500 mb-6">Das gesuchte Event existiert nicht oder wurde entfernt.</p>
        <a href="/suche" class="btn-primary">Zur Suche</a>
      </div>
    </main>
  ) : (
    <main class="min-h-screen bg-gray-50">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Breadcrumb -->
        <nav class="flex items-center gap-2 text-sm text-gray-500 mb-6">
          <a href="/" class="text-primary-600 hover:text-primary-700">Start</a>
          <span>/</span>
          <a href="/suche" class="text-primary-600 hover:text-primary-700">Events</a>
          <span>/</span>
          <span class="text-gray-700 truncate max-w-[200px]">{event.title}</span>
        </nav>

        <!-- Hero -->
        <div class="rounded-2xl overflow-hidden bg-gray-100 aspect-[21/9] mb-6">
          {event.image_urls?.[0] ? (
            <img
              src={event.image_urls[0]}
              alt={event.title}
              class="w-full h-full object-cover"
            />
          ) : (
            <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-primary-100 to-primary-50">
              <span class="text-6xl">ğŸˆ</span>
            </div>
          )}
        </div>

        <!-- Header Card -->
        <div class="bg-white rounded-2xl shadow-card p-6 mb-6">
          <div class="flex flex-wrap gap-2 mb-4">
            {availabilityBadge && (
              <span class={`badge ${availabilityBadge.class}`}>{availabilityBadge.text}</span>
            )}
            {event.is_indoor && <span class="badge badge-indoor">ğŸ  Indoor</span>}
            {event.is_outdoor && <span class="badge badge-outdoor">ğŸŒ³ Outdoor</span>}
            {event.price_type === 'free' && <span class="badge badge-free">Kostenlos</span>}
            {event.sibling_friendly && <span class="badge bg-purple-100 text-purple-700">ğŸ‘¶ Geschwister willkommen</span>}
            {event.categories?.map((c: any) => (
              <span class="badge bg-primary-100 text-primary-700">
                {c.category?.icon || ''} {c.category?.name_de || c.category?.slug || ''}
              </span>
            ))}
          </div>
          
          <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">{event.title}</h1>
          
          {/* Venue Name prominent */}
          {event.venue_name && (
            <p class="text-lg text-gray-600 mb-4">ğŸ“ {event.venue_name}</p>
          )}

          <div class="flex flex-wrap gap-x-6 gap-y-2 text-gray-600 mb-4">
            {/* Formatiertes Datum + Zeit + Dauer */}
            <span class="flex items-center gap-2">
              <span>ğŸ“…</span>
              <span class="font-medium">{formatDateTimeCompact(event.start_datetime, event.end_datetime)}</span>
            </span>
            {duration && (
              <span class="flex items-center gap-2">
                <span>â±ï¸</span>
                {duration}
              </span>
            )}
            {/* VollstÃ¤ndige Adresse */}
            <span class="flex items-center gap-2">
              <span>ğŸ“</span>
              {event.location_address 
                ? `${event.location_address}${event.postal_code ? `, ${event.postal_code}` : ''}${event.city ? ` ${event.city}` : ''}`
                : event.location_district || 'Karlsruhe'}
            </span>
            {/* Preis */}
            <span class="flex items-center gap-2">
              <span>ğŸ’°</span>
              {formatPrice(event)}
            </span>
          </div>

          {/* Strukturierte Preise */}
          {priceDetailsList && (
            <div class="flex flex-wrap gap-3 mb-4 text-sm">
              {priceDetailsList.map((price: string) => (
                <span class="bg-gray-100 px-3 py-1 rounded-full">{price}</span>
              ))}
            </div>
          )}

          {/* Scores */}
          {(event.scores?.stressfree_score || event.scores?.family_fit_score || event.save_count) && (
            <div class="flex flex-wrap gap-6 pt-4 border-t border-gray-100">
              {event.scores?.family_fit_score != null && (
                <span class="flex items-center gap-2" title="Familienfreundlichkeit">
                  <span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>
                  <span class="font-semibold text-primary-600">{event.scores.family_fit_score}%</span>
                </span>
              )}
              {event.scores?.stressfree_score != null && (
                <span class="flex items-center gap-2" title="Stressfrei-Score">
                  <span>ğŸ˜Œ</span>
                  <span class="font-semibold text-primary-600">{event.scores.stressfree_score}%</span>
                </span>
              )}
              {event.save_count != null && event.save_count > 0 && (
                <span class="flex items-center gap-2 text-gray-500" title="Gemerkt von Familien">
                  <span>â¤ï¸</span>
                  <span>von {event.save_count} Familie{event.save_count !== 1 ? 'n' : ''} gemerkt</span>
                </span>
              )}
            </div>
          )}

          <div class="flex flex-wrap gap-3 mt-6">
            {event.booking_url && (
              <a href={event.booking_url} target="_blank" rel="noopener noreferrer" class="btn-primary">
                {event.availability_status === 'registration_required' ? 'Jetzt anmelden' : 'Jetzt buchen'}
              </a>
            )}
            <button type="button" class="btn-secondary" id="add-to-plan-btn">
              ğŸ“‹ Zum Plan hinzufÃ¼gen
            </button>
            <button type="button" class="btn-secondary" id="save-btn" data-event-id={event.id}>
              â¤ï¸ Merken
            </button>
            <a href={`${API_BASE}/api/events/${event.id}/ical`} class="btn-secondary" download>
              ğŸ“† Kalender
            </a>
          </div>
        </div>

        <div class="lg:grid lg:grid-cols-[1fr_340px] lg:gap-8">
          <!-- Main -->
          <div class="space-y-6">
            {/* AI Summary Block - displayed above original description */}
            {event.ai_summary_short && (
              <section class="bg-gradient-to-br from-primary-50 to-white rounded-2xl shadow-card p-6 border border-primary-100">
                <div class="flex items-start gap-3 mb-3">
                  <span class="text-2xl">âœ¨</span>
                  <div>
                    <h2 class="text-lg font-semibold text-gray-900">Auf einen Blick</h2>
                    <p class="text-sm text-gray-500">KI-generierte Zusammenfassung</p>
                  </div>
                </div>
                
                <p class="text-gray-700 leading-relaxed mb-4">{event.ai_summary_short}</p>
                
                {event.ai_summary_highlights && event.ai_summary_highlights.length > 0 && (
                  <ul class="space-y-2 mb-4">
                    {event.ai_summary_highlights.map((highlight: string) => (
                      <li class="flex items-center gap-2 text-gray-600">
                        <span class="text-primary-500 flex-shrink-0">âœ“</span>
                        <span>{highlight}</span>
                      </li>
                    ))}
                  </ul>
                )}
                
                {event.ai_fit_blurb && (
                  <p class="text-sm font-medium text-primary-700 bg-primary-100/50 rounded-lg px-3 py-2 inline-block">
                    ğŸ’¡ {event.ai_fit_blurb}
                  </p>
                )}
              </section>
            )}

            <section class="bg-white rounded-2xl shadow-card p-6">
              <h2 class="text-lg font-semibold text-gray-900 mb-3">Beschreibung</h2>
              <div class="prose prose-gray max-w-none text-gray-600" set:html={event.description_long || event.description_short || '<p>Keine Beschreibung verfÃ¼gbar.</p>'}></div>
            </section>

            {/* Altersempfehlung - erweitert */}
            {((event.age_min != null) || (event.age_max != null) || event.age_recommendation_text) && (
              <section class="bg-white rounded-2xl shadow-card p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-3">Altersempfehlung</h2>
                <div class="space-y-3">
                  {event.age_recommendation_text ? (
                    <p class="text-gray-700 font-medium">{event.age_recommendation_text}</p>
                  ) : (
                    <span class="inline-block px-4 py-2 bg-gray-100 rounded-xl font-medium">
                      {event.age_min != null && event.age_max != null && `${event.age_min}â€“${event.age_max} Jahre`}
                      {event.age_min != null && event.age_max == null && `Ab ${event.age_min} Jahren`}
                      {event.age_min == null && event.age_max != null && `Bis ${event.age_max} Jahre`}
                    </span>
                  )}
                  {event.sibling_friendly && (
                    <p class="text-sm text-purple-600 flex items-center gap-2">
                      <span>ğŸ‘¶</span> Auch fÃ¼r jÃ¼ngere Geschwister geeignet
                    </p>
                  )}
                  {event.age_rating && (
                    <p class="text-sm text-gray-500">Altersfreigabe: {event.age_rating}</p>
                  )}
                </div>
              </section>
            )}

            {/* Sprache & VerstÃ¤ndlichkeit */}
            {(event.language || event.complexity_level) && (
              <section class="bg-white rounded-2xl shadow-card p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-3">Sprache & VerstÃ¤ndlichkeit</h2>
                <div class="flex flex-wrap gap-4">
                  {event.language && (
                    <span class="flex items-center gap-2 text-gray-600">
                      <span>ğŸ—£ï¸</span> {event.language}
                    </span>
                  )}
                  {event.complexity_level && (
                    <span class="flex items-center gap-2 text-gray-600">
                      <span>ğŸ“–</span> {getComplexityText(event.complexity_level)}
                    </span>
                  )}
                </div>
              </section>
            )}

            {/* Stressfrei-Infos */}
            {(event.noise_level || event.has_seating != null || event.typical_wait_minutes || event.food_drink_allowed != null) && (
              <section class="bg-white rounded-2xl shadow-card p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-3">Gut zu wissen fÃ¼r Familien</h2>
                <div class="grid grid-cols-2 gap-4">
                  {event.noise_level && (
                    <div class="flex items-center gap-2 text-gray-600">
                      <span>{event.noise_level === 'quiet' ? 'ğŸ”‡' : event.noise_level === 'loud' ? 'ğŸ”Š' : 'ğŸ”‰'}</span>
                      <span>LautstÃ¤rke: {getNoiseLevelText(event.noise_level)}</span>
                    </div>
                  )}
                  {event.has_seating != null && (
                    <div class="flex items-center gap-2 text-gray-600">
                      <span>{event.has_seating ? 'ğŸ’º' : 'ğŸš¶'}</span>
                      <span>{event.has_seating ? 'SitzplÃ¤tze vorhanden' : 'Keine SitzplÃ¤tze'}</span>
                    </div>
                  )}
                  {event.typical_wait_minutes != null && (
                    <div class="flex items-center gap-2 text-gray-600">
                      <span>â³</span>
                      <span>Wartezeit: ca. {event.typical_wait_minutes} Min.</span>
                    </div>
                  )}
                  {event.food_drink_allowed != null && (
                    <div class="flex items-center gap-2 text-gray-600">
                      <span>{event.food_drink_allowed ? 'ğŸ”' : 'ğŸš«'}</span>
                      <span>{event.food_drink_allowed ? 'Essen/Trinken erlaubt' : 'Kein Essen/Trinken'}</span>
                    </div>
                  )}
                </div>
                {event.early_arrival_hint && (
                  <p class="mt-3 text-sm text-amber-600 bg-amber-50 px-3 py-2 rounded-lg">
                    ğŸ’¡ {event.early_arrival_hint}
                  </p>
                )}
              </section>
            )}

            {/* KapazitÃ¤t */}
            {(event.capacity || event.spots_limited) && (
              <section class="bg-white rounded-2xl shadow-card p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-3">KapazitÃ¤t</h2>
                <div class="space-y-2">
                  {event.capacity && (
                    <p class="text-gray-600">Max. {event.capacity} Teilnehmer</p>
                  )}
                  {event.spots_limited && (
                    <p class="text-amber-600 flex items-center gap-2">
                      <span>âš ï¸</span> Begrenzte PlÃ¤tze â€“ frÃ¼hzeitig buchen empfohlen
                    </p>
                  )}
                </div>
              </section>
            )}

            {/* Wiederkehrende Termine */}
            {(event.recurrence_rule || event.next_occurrences?.length > 0) && (
              <section class="bg-white rounded-2xl shadow-card p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-3">Termine</h2>
                {event.recurrence_rule && (
                  <p class="text-gray-600 mb-3">ğŸ”„ {event.recurrence_rule}</p>
                )}
                {event.next_occurrences?.length > 0 && (
                  <div class="space-y-2">
                    <p class="text-sm text-gray-500">NÃ¤chste Termine:</p>
                    <ul class="space-y-1">
                      {event.next_occurrences.slice(0, 3).map((date: string) => (
                        <li class="text-gray-600">
                          ğŸ“… {new Date(date).toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}
                        </li>
                      ))}
                    </ul>
                  </div>
                )}
              </section>
            )}

            {event.amenities?.length > 0 && (
              <section class="bg-white rounded-2xl shadow-card p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-3">Ausstattung</h2>
                <div class="flex flex-wrap gap-2">
                  {event.amenities.map((a: any) => (
                    <span class="inline-flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg text-sm">
                      {a.amenity?.icon || 'âœ“'} {a.amenity?.name_de || a.amenity?.slug || ''}
                    </span>
                  ))}
                </div>
              </section>
            )}
          </div>

          <!-- Sidebar -->
          <aside class="space-y-6 lg:pt-0">
            {/* Anfahrt */}
            <div class="bg-white rounded-2xl shadow-card p-6">
              <h3 class="font-semibold text-gray-900 mb-3">Anfahrt</h3>
              <div class="aspect-[4/3] bg-gray-100 rounded-xl mb-3 flex items-center justify-center">
                {event.location_lat && event.location_lng ? (
                  <a
                    href={`https://www.google.com/maps/dir/?api=1&destination=${event.location_lat},${event.location_lng}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-primary-600 hover:underline"
                  >
                    ğŸ—ºï¸ Karte Ã¶ffnen
                  </a>
                ) : (
                  <span class="text-gray-400">Keine Koordinaten</span>
                )}
              </div>
              
              {/* Adresse */}
              {event.venue_name && (
                <p class="font-medium text-gray-900">{event.venue_name}</p>
              )}
              {event.location_address && (
                <p class="text-sm text-gray-600">
                  {event.location_address}
                  {event.postal_code && `, ${event.postal_code}`}
                  {event.city && ` ${event.city}`}
                </p>
              )}
              
              {/* Ã–PNV & Parken */}
              {(event.transit_stop || event.has_parking != null) && (
                <div class="mt-4 pt-4 border-t border-gray-100 space-y-2">
                  {event.transit_stop && (
                    <p class="text-sm text-gray-600 flex items-center gap-2">
                      <span>ğŸš‡</span>
                      {event.transit_stop}
                      {event.transit_walk_minutes && ` (${event.transit_walk_minutes} Min. FuÃŸweg)`}
                    </p>
                  )}
                  {event.has_parking != null && (
                    <p class="text-sm text-gray-600 flex items-center gap-2">
                      <span>{event.has_parking ? 'ğŸ…¿ï¸' : 'ğŸš«'}</span>
                      {event.has_parking ? 'ParkplÃ¤tze vorhanden' : 'Keine ParkplÃ¤tze'}
                    </p>
                  )}
                </div>
              )}
              
              {event.location_lat && event.location_lng && (
                <a
                  href={`https://www.google.com/maps/dir/?api=1&destination=${event.location_lat},${event.location_lng}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-sm text-primary-600 hover:text-primary-700 mt-3 inline-block"
                >
                  ğŸš— Route berechnen
                </a>
              )}
            </div>

            {/* Veranstalter & Kontakt â€“ alle vorhandenen Infos als mehrere EintrÃ¤ge */}
            {(event.provider || event.organizer_website || event.contact_email || event.contact_phone || event.booking_url || event.organizer_directions) && (
              <div class="bg-white rounded-2xl shadow-card p-6">
                <h3 class="font-semibold text-gray-900 mb-3">Veranstalter & Kontakt</h3>
                
                {event.provider && (
                  <div class="mb-3 pb-3 border-b border-gray-100">
                    <p class="font-medium text-gray-900">{event.provider.name}</p>
                    {event.provider.type && (
                      <p class="text-xs text-gray-500 capitalize">{event.provider.type}</p>
                    )}
                  </div>
                )}
                
                <ul class="space-y-2 text-sm text-gray-600">
                  {event.organizer_website && (
                    <li class="flex items-center gap-2">
                      <span>ğŸŒ</span>
                      <a href={event.organizer_website} target="_blank" rel="noopener noreferrer" class="text-primary-600 hover:underline">Zur Website</a>
                    </li>
                  )}
                  {event.contact_email && (
                    <li class="flex items-center gap-2">
                      <span>âœ‰ï¸</span>
                      <a href={`mailto:${event.contact_email}`} class="text-primary-600 hover:underline">{event.contact_email}</a>
                    </li>
                  )}
                  {event.contact_phone && (
                    <li class="flex items-center gap-2">
                      <span>ğŸ“</span>
                      <a href={`tel:${event.contact_phone}`} class="text-primary-600 hover:underline">{event.contact_phone}</a>
                    </li>
                  )}
                  {event.booking_url && (
                    <li class="flex items-center gap-2">
                      <span>ğŸ”—</span>
                      <a href={event.booking_url} target="_blank" rel="noopener noreferrer" class="text-primary-600 hover:underline">Zur Buchung</a>
                    </li>
                  )}
                </ul>
                {event.organizer_directions && (
                  <div class="mt-3 pt-3 border-t border-gray-100">
                    <h4 class="font-medium text-gray-900 mb-1 text-sm">Wegbeschreibung vom Veranstalter</h4>
                    <p class="text-sm text-gray-600 whitespace-pre-line">{event.organizer_directions}</p>
                  </div>
                )}
              </div>
            )}

            {/* Quelle & DatenqualitÃ¤t */}
            <div class="bg-gray-50 rounded-2xl p-6">
              <h3 class="font-semibold text-gray-900 mb-3">Quelle & DatenqualitÃ¤t</h3>
              
              {event.primary_source?.source?.name && (
                <p class="text-sm text-gray-600 mb-1">
                  <span class="font-medium">Quelle:</span> {event.primary_source.source.name}
                </p>
              )}
              
              {event.primary_source?.source?.url && (
                <a 
                  href={event.primary_source.source.url} 
                  target="_blank" 
                  rel="noopener noreferrer" 
                  class="text-sm text-primary-600 hover:underline block mb-3"
                >
                  Zur Originalquelle â†’
                </a>
              )}
              
              {event.last_verified_at && (
                <p class="text-xs text-gray-500 mb-2">
                  Zuletzt geprÃ¼ft: {new Date(event.last_verified_at).toLocaleDateString('de-DE', { day: 'numeric', month: 'short', year: 'numeric' })}
                </p>
              )}
              
              {completenessMsg && (
                <p class={`text-sm ${completenessMsg.class} mt-2`}>
                  {completenessMsg.text}
                </p>
              )}
            </div>
          </aside>
        </div>

        <!-- Similar Events -->
        {similarEvents.length > 0 && (
          <section class="mt-12" id="similar">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Ã„hnliche Events</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
              {similarEvents.map((e: any) => (
                <EventCardNew
                  id={e.id}
                  title={e.title}
                  imageUrl={e.image_urls?.[0]}
                  date={e.start_datetime ? new Date(e.start_datetime).toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'short' }) : undefined}
                  startTime={e.start_datetime ? new Date(e.start_datetime).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : undefined}
                  priceType={e.price_type || 'unknown'}
                  priceMin={e.price_min}
                  ageMin={e.age_min}
                  ageMax={e.age_max}
                  isIndoor={e.is_indoor}
                  isOutdoor={e.is_outdoor}
                  stressfreeScore={e.scores?.stressfree_score}
                />
              ))}
            </div>
          </section>
        )}
      </div>
    </main>
  )}
</BaseLayout>

<script>
  const saveBtn = document.getElementById('save-btn');
  saveBtn?.addEventListener('click', () => {
    const id = saveBtn.getAttribute('data-event-id');
    if (!id) return;
    try {
      const raw = localStorage.getItem('saved_events') || '[]';
      const arr = JSON.parse(raw);
      const idx = arr.indexOf(id);
      if (idx >= 0) arr.splice(idx, 1);
      else arr.push(id);
      localStorage.setItem('saved_events', JSON.stringify(arr));
      (saveBtn as HTMLButtonElement).textContent = arr.includes(id) ? 'â¤ï¸ Gespeichert' : 'â¤ï¸ Merken';
    } catch (_) {}
  });
</script>
