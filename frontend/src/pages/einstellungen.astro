---
import BaseLayout from '../layouts/BaseLayout.astro';
import StickyHeader from '../components/layout/StickyHeader.astro';
const API_BASE = import.meta.env.PUBLIC_API_URL || 'http://localhost:4000';
---

<BaseLayout title="Einstellungen - familienlokal">
  <StickyHeader />
  <main class="min-h-screen bg-gray-50 py-8 px-4">
    <div class="max-w-2xl mx-auto">
      <!-- Loading State -->
      <div id="loading-state" class="flex items-center justify-center min-h-[40vh]">
        <div class="text-center">
          <div class="w-12 h-12 border-4 border-primary-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p class="text-gray-500">Wird geladen...</p>
        </div>
      </div>

      <!-- Auth Required -->
      <div id="auth-required" class="hidden">
        <div class="bg-white rounded-2xl shadow-card p-8 text-center">
          <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
          </div>
          <h1 class="text-xl font-bold text-gray-900 mb-2">Anmeldung erforderlich</h1>
          <p class="text-gray-500 mb-6">Bitte melde dich an, um deine Einstellungen zu sehen.</p>
          <a href="/login?redirect=/einstellungen" class="btn-primary inline-block px-6 py-3">Zur Anmeldung</a>
        </div>
      </div>

      <!-- Settings Content -->
      <div id="settings-content" class="hidden space-y-6">
        <!-- Header -->
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Einstellungen</h1>
          <p class="text-gray-500 mt-1">Verwalte dein Konto und deine Präferenzen</p>
        </div>

        <!-- Account Info -->
        <div class="bg-white rounded-2xl shadow-card p-6">
          <h2 class="font-semibold text-gray-900 mb-4">Kontoinformationen</h2>
          <div class="space-y-4">
            <div class="flex items-center justify-between py-3 border-b border-gray-100">
              <div>
                <span class="text-sm text-gray-500">E-Mail</span>
                <p class="font-medium text-gray-900" id="user-email-display">-</p>
              </div>
            </div>
            <div class="flex items-center justify-between py-3 border-b border-gray-100">
              <div>
                <span class="text-sm text-gray-500">Kontotyp</span>
                <p class="font-medium text-gray-900" id="user-role-display">-</p>
              </div>
            </div>
            <div class="flex items-center justify-between py-3">
              <div>
                <span class="text-sm text-gray-500">Mitglied seit</span>
                <p class="font-medium text-gray-900" id="user-created-display">-</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Change Password -->
        <div class="bg-white rounded-2xl shadow-card p-6">
          <h2 class="font-semibold text-gray-900 mb-4">Passwort ändern</h2>
          <p class="text-sm text-gray-500 mb-4">Aus Sicherheitsgründen solltest du ein starkes Passwort verwenden, das du nirgendwo anders benutzt.</p>
          
          <form id="change-password-form" class="space-y-4">
            <div class="flex flex-col gap-2">
              <label for="current-password" class="font-medium text-sm text-gray-700">Aktuelles Passwort</label>
              <input 
                type="password" 
                id="current-password" 
                name="currentPassword" 
                required
                autocomplete="current-password"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary-500 transition-colors" 
              />
            </div>

            <div class="flex flex-col gap-2">
              <label for="new-password" class="font-medium text-sm text-gray-700">Neues Passwort</label>
              <input 
                type="password" 
                id="new-password" 
                name="newPassword" 
                required
                minlength="8"
                placeholder="Mindestens 8 Zeichen"
                autocomplete="new-password"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary-500 transition-colors" 
              />
            </div>

            <div class="flex flex-col gap-2">
              <label for="confirm-password" class="font-medium text-sm text-gray-700">Neues Passwort bestätigen</label>
              <input 
                type="password" 
                id="confirm-password" 
                name="confirmPassword" 
                required
                minlength="8"
                placeholder="Passwort wiederholen"
                autocomplete="new-password"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary-500 transition-colors" 
              />
            </div>

            <!-- Messages -->
            <div id="password-error" class="hidden rounded-xl bg-red-50 text-red-700 px-4 py-3 text-sm"></div>
            <div id="password-success" class="hidden rounded-xl bg-green-50 text-green-700 px-4 py-3 text-sm"></div>

            <button type="submit" id="change-password-btn" class="btn-primary py-3 px-6">
              Passwort ändern
            </button>
          </form>
        </div>

        <!-- Danger Zone -->
        <div class="bg-white rounded-2xl shadow-card p-6 border-2 border-red-100">
          <h2 class="font-semibold text-red-700 mb-4">Gefahrenzone</h2>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <div>
                <p class="font-medium text-gray-900">Abmelden</p>
                <p class="text-sm text-gray-500">Von diesem Gerät abmelden</p>
              </div>
              <button id="logout-settings-btn" class="px-4 py-2 border-2 border-gray-200 rounded-xl text-gray-700 hover:bg-gray-50 transition-colors">
                Abmelden
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<script define:vars={{ API_BASE }}>
  const loadingState = document.getElementById('loading-state');
  const authRequired = document.getElementById('auth-required');
  const settingsContent = document.getElementById('settings-content');

  async function initSettings() {
    const token = localStorage.getItem('auth_token');

    if (!token) {
      loadingState?.classList.add('hidden');
      authRequired?.classList.remove('hidden');
      return;
    }

    try {
      // Get user info
      const response = await fetch(`${API_BASE}/api/auth/me`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!response.ok) {
        localStorage.removeItem('auth_token');
        loadingState?.classList.add('hidden');
        authRequired?.classList.remove('hidden');
        return;
      }

      const data = await response.json();
      const user = data.data;

      // Update display
      const roleLabels = {
        'admin': 'Administrator',
        'provider': 'Anbieter',
        'parent': 'Familie'
      };

      document.getElementById('user-email-display').textContent = user.email;
      document.getElementById('user-role-display').textContent = roleLabels[user.role] || user.role;
      document.getElementById('user-created-display').textContent = new Date(user.created_at).toLocaleDateString('de-DE', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });

      // Show content
      loadingState?.classList.add('hidden');
      settingsContent?.classList.remove('hidden');

    } catch (error) {
      console.error('Settings init error:', error);
      loadingState?.classList.add('hidden');
      authRequired?.classList.remove('hidden');
    }
  }

  // Change password form
  const changePasswordForm = document.getElementById('change-password-form');
  const passwordError = document.getElementById('password-error');
  const passwordSuccess = document.getElementById('password-success');

  changePasswordForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const currentPassword = document.getElementById('current-password')?.value;
    const newPassword = document.getElementById('new-password')?.value;
    const confirmPassword = document.getElementById('confirm-password')?.value;
    const submitBtn = document.getElementById('change-password-btn');

    // Reset messages
    passwordError?.classList.add('hidden');
    passwordSuccess?.classList.add('hidden');

    // Validate
    if (newPassword !== confirmPassword) {
      passwordError.textContent = 'Die neuen Passwörter stimmen nicht überein.';
      passwordError?.classList.remove('hidden');
      return;
    }

    if (newPassword.length < 8) {
      passwordError.textContent = 'Das neue Passwort muss mindestens 8 Zeichen lang sein.';
      passwordError?.classList.remove('hidden');
      return;
    }

    const token = localStorage.getItem('auth_token');
    if (!token) {
      passwordError.textContent = 'Nicht angemeldet. Bitte lade die Seite neu.';
      passwordError?.classList.remove('hidden');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Wird geändert...';

    try {
      const response = await fetch(`${API_BASE}/api/auth/change-password`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ currentPassword, newPassword })
      });

      const data = await response.json();

      if (response.ok) {
        // Update token if new one was returned
        if (data.data?.token) {
          localStorage.setItem('auth_token', data.data.token);
        }

        passwordSuccess.textContent = 'Passwort wurde erfolgreich geändert.';
        passwordSuccess?.classList.remove('hidden');

        // Clear form
        changePasswordForm.reset();
      } else {
        const errorMessages = {
          'INVALID_PASSWORD': 'Das aktuelle Passwort ist falsch.',
          'SAME_PASSWORD': 'Das neue Passwort muss sich vom aktuellen unterscheiden.',
          'NO_PASSWORD': 'Für OAuth-Konten kann das Passwort nicht geändert werden.',
          'VALIDATION_ERROR': data.error?.message || 'Ungültige Eingabe.'
        };

        passwordError.textContent = errorMessages[data.error?.code] || data.error?.message || 'Ein Fehler ist aufgetreten.';
        passwordError?.classList.remove('hidden');
      }
    } catch (error) {
      passwordError.textContent = 'Verbindungsfehler. Bitte versuche es später erneut.';
      passwordError?.classList.remove('hidden');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Passwort ändern';
    }
  });

  // Logout button
  document.getElementById('logout-settings-btn')?.addEventListener('click', async () => {
    try {
      localStorage.removeItem('auth_token');
      
      // Try to sign out from Supabase if available on window
      if (typeof window !== 'undefined' && window.supabase?.auth) {
        await window.supabase.auth.signOut();
      }

      window.location.href = '/';
    } catch (error) {
      localStorage.removeItem('auth_token');
      window.location.href = '/';
    }
  });

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSettings);
  } else {
    initSettings();
  }
</script>
