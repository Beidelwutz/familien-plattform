---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import StickyHeader from '../../../components/layout/StickyHeader.astro';
const API_BASE = import.meta.env.PUBLIC_API_URL || 'http://localhost:4000';
---

<BaseLayout title="Meine Events - kiezling Anbieter">
  <StickyHeader />
  <main class="min-h-screen bg-gray-50 py-8 px-4">
    <div class="max-w-5xl mx-auto">
      <!-- Loading State -->
      <div id="loading-state" class="flex items-center justify-center min-h-[40vh]">
        <div class="text-center">
          <div class="w-12 h-12 border-4 border-primary-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p class="text-gray-500">Events werden geladen...</p>
        </div>
      </div>

      <!-- Auth Required -->
      <div id="auth-required" class="hidden">
        <div class="bg-white rounded-2xl shadow-card p-8 text-center max-w-md mx-auto">
          <h1 class="text-xl font-bold text-gray-900 mb-2">Anmeldung erforderlich</h1>
          <p class="text-gray-500 mb-6">Bitte melde dich als Anbieter an.</p>
          <a href="/anbieter/login" class="btn-primary inline-block px-6 py-3">Zur Anmeldung</a>
        </div>
      </div>

      <!-- Events Content -->
      <div id="events-content" class="hidden">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
          <div>
            <a href="/anbieter/dashboard" class="text-gray-500 hover:text-gray-700 text-sm mb-2 inline-flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
              Dashboard
            </a>
            <h1 class="text-2xl font-bold text-gray-900">Meine Events</h1>
          </div>
          <a href="/anbieter/events/neu" class="btn-primary inline-flex items-center gap-2 px-6 py-3">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Neues Event
          </a>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-card p-4 mb-6">
          <div class="flex flex-wrap gap-2">
            <button class="filter-btn active px-4 py-2 rounded-lg text-sm font-medium bg-primary-100 text-primary-700" data-status="all">
              Alle
            </button>
            <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200" data-status="published">
              Veröffentlicht
            </button>
            <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200" data-status="pending_review">
              In Prüfung
            </button>
            <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200" data-status="incomplete">
              Unvollständig
            </button>
          </div>
        </div>

        <!-- Events List -->
        <div id="events-list" class="space-y-4">
          <!-- Events will be loaded here -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden bg-white rounded-2xl shadow-card p-8 text-center">
          <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
          </div>
          <h2 class="text-lg font-bold text-gray-900 mb-2">Noch keine Events</h2>
          <p class="text-gray-500 mb-6">Erstelle dein erstes Event und erreiche Familien in deiner Region.</p>
          <a href="/anbieter/events/neu" class="btn-primary inline-block px-6 py-3">Erstes Event erstellen</a>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="hidden flex justify-center gap-2 mt-6">
          <button id="prev-btn" class="px-4 py-2 rounded-lg bg-white shadow border border-gray-200 text-gray-600 disabled:opacity-50" disabled>Zurück</button>
          <span id="page-info" class="px-4 py-2 text-gray-600">Seite 1</span>
          <button id="next-btn" class="px-4 py-2 rounded-lg bg-white shadow border border-gray-200 text-gray-600 disabled:opacity-50">Weiter</button>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<script is:inline define:vars={{ API_BASE }}>
  let currentPage = 1;
  let currentStatus = 'all';
  let totalEvents = 0;
  const limit = 10;

  async function loadEvents() {
    const token = localStorage.getItem('auth_token');
    const eventsList = document.getElementById('events-list');
    const emptyState = document.getElementById('empty-state');
    const pagination = document.getElementById('pagination');
    
    try {
      let url = `${API_BASE}/api/providers/me/events?limit=${limit}&offset=${(currentPage - 1) * limit}`;
      if (currentStatus !== 'all') {
        url += `&status=${currentStatus}`;
      }

      const response = await fetch(url, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!response.ok) {
        throw new Error('Failed to load events');
      }

      const data = await response.json();
      const events = data.data || [];
      totalEvents = data.pagination?.total || events.length;

      if (events.length === 0) {
        eventsList?.classList.add('hidden');
        emptyState?.classList.remove('hidden');
        pagination?.classList.add('hidden');
      } else {
        eventsList?.classList.remove('hidden');
        emptyState?.classList.add('hidden');
        renderEvents(events);
        updatePagination();
      }

    } catch (error) {
      eventsList.innerHTML = '<div class="bg-red-50 text-red-700 p-4 rounded-xl">Fehler beim Laden der Events.</div>';
    }
  }

  function renderEvents(events) {
    const eventsList = document.getElementById('events-list');
    if (!eventsList) return;

    const statusLabels = {
      'published': { label: 'Veröffentlicht', class: 'bg-green-100 text-green-700' },
      'pending_review': { label: 'In Prüfung', class: 'bg-yellow-100 text-yellow-700' },
      'incomplete': { label: 'Unvollständig', class: 'bg-gray-100 text-gray-600' },
      'raw': { label: 'Entwurf', class: 'bg-gray-100 text-gray-600' },
      'rejected': { label: 'Abgelehnt', class: 'bg-red-100 text-red-700' },
      'cancelled': { label: 'Abgesagt', class: 'bg-red-100 text-red-700' }
    };

    eventsList.innerHTML = events.map(event => {
      const status = statusLabels[event.status] || { label: event.status, class: 'bg-gray-100 text-gray-600' };
      const date = new Date(event.start_datetime).toLocaleDateString('de-DE', {
        weekday: 'short',
        day: 'numeric',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      return `
        <div class="bg-white rounded-xl shadow-card p-4 sm:p-6">
          <div class="flex flex-col sm:flex-row sm:items-center gap-4">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="px-2 py-0.5 rounded-full text-xs font-medium ${status.class}">${status.label}</span>
                ${event.is_cancelled ? '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">Abgesagt</span>' : ''}
              </div>
              <h3 class="font-semibold text-gray-900 truncate">${event.title}</h3>
              <p class="text-sm text-gray-500">${date}</p>
              ${event.location_address ? `<p class="text-sm text-gray-400 truncate">${event.location_address}</p>` : ''}
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm text-gray-500">${event.view_count || 0} Aufrufe</span>
              <a href="/anbieter/events/${event.id}" class="btn-secondary px-4 py-2 text-sm">Bearbeiten</a>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function updatePagination() {
    const pagination = document.getElementById('pagination');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageInfo = document.getElementById('page-info');

    const totalPages = Math.ceil(totalEvents / limit);

    if (totalPages <= 1) {
      pagination?.classList.add('hidden');
      return;
    }

    pagination?.classList.remove('hidden');
    pageInfo.textContent = `Seite ${currentPage} von ${totalPages}`;
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage >= totalPages;
  }

  // Filter buttons
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-btn').forEach(b => {
        b.classList.remove('active', 'bg-primary-100', 'text-primary-700');
        b.classList.add('bg-gray-100', 'text-gray-600');
      });
      btn.classList.add('active', 'bg-primary-100', 'text-primary-700');
      btn.classList.remove('bg-gray-100', 'text-gray-600');
      
      currentStatus = btn.dataset.status;
      currentPage = 1;
      loadEvents();
    });
  });

  // Pagination
  document.getElementById('prev-btn')?.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      loadEvents();
    }
  });

  document.getElementById('next-btn')?.addEventListener('click', () => {
    currentPage++;
    loadEvents();
  });

  // Init
  async function init() {
    const loadingState = document.getElementById('loading-state');
    const authRequired = document.getElementById('auth-required');
    const eventsContent = document.getElementById('events-content');

    const token = localStorage.getItem('auth_token');
    
    if (!token) {
      loadingState?.classList.add('hidden');
      authRequired?.classList.remove('hidden');
      return;
    }

    try {
      const providerResponse = await fetch(`${API_BASE}/api/providers/me`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!providerResponse.ok) {
        loadingState?.classList.add('hidden');
        authRequired?.classList.remove('hidden');
        return;
      }

      const providerData = await providerResponse.json();
      
      if (!providerData.data) {
        loadingState?.classList.add('hidden');
        authRequired?.classList.remove('hidden');
        return;
      }

      loadingState?.classList.add('hidden');
      eventsContent?.classList.remove('hidden');
      await loadEvents();

    } catch (error) {
      loadingState?.classList.add('hidden');
      authRequired?.classList.remove('hidden');
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>
