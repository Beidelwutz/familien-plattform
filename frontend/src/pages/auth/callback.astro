---
/**
 * OAuth Callback Page
 * Handles the redirect from Supabase OAuth (Google, etc.)
 * Exchanges the code for a session and redirects to the appropriate page
 */
---

<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anmeldung wird verarbeitet...</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    }
    .container {
      text-align: center;
      padding: 2rem;
      max-width: 500px;
    }
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e5e7eb;
      border-top-color: #10b981;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    h1 {
      color: #1f2937;
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }
    p {
      color: #6b7280;
      font-size: 0.875rem;
    }
    .error {
      color: #dc2626;
      background: #fef2f2;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
      display: none;
      text-align: left;
    }
    .error-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .error-details {
      font-size: 0.75rem;
      color: #991b1b;
      word-break: break-word;
    }
    .error-hint {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #fecaca;
      font-size: 0.75rem;
      color: #b91c1c;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="spinner" id="spinner"></div>
    <h1 id="title">Anmeldung wird verarbeitet...</h1>
    <p id="message">Bitte warten Sie einen Moment.</p>
    <div class="error" id="error"></div>
  </div>

  <script>
    import { supabase } from '../../lib/supabase';

    const API_BASE = import.meta.env.PUBLIC_API_URL || (import.meta.env.DEV ? 'http://localhost:4000' : window.location.origin);

    /**
     * Extract error code from error message
     */
    function getErrorCode(message: string): string {
      const lowerMessage = message.toLowerCase();
      
      if (lowerMessage.includes('redirect_uri_mismatch') || lowerMessage.includes('redirect uri')) {
        return 'redirect_uri_mismatch';
      }
      if (lowerMessage.includes('invalid_grant') || lowerMessage.includes('invalid grant')) {
        return 'invalid_grant';
      }
      if (lowerMessage.includes('access_denied') || lowerMessage.includes('access denied')) {
        return 'access_denied';
      }
      if (lowerMessage.includes('unauthorized_client')) {
        return 'unauthorized_client';
      }
      if (lowerMessage.includes('invalid_client') || lowerMessage.includes('client id')) {
        return 'invalid_client';
      }
      if (lowerMessage.includes('keine session') || lowerMessage.includes('no session')) {
        return 'no_session';
      }
      if (lowerMessage.includes('pkce') || lowerMessage.includes('code verifier')) {
        return 'pkce_error';
      }
      
      return 'unknown';
    }

    /**
     * Get user-friendly error title
     */
    function getErrorTitle(code: string): string {
      const titles: Record<string, string> = {
        'redirect_uri_mismatch': 'Konfigurationsfehler: Redirect-URI',
        'invalid_grant': 'Ungültiger oder abgelaufener Code',
        'access_denied': 'Zugriff verweigert',
        'unauthorized_client': 'OAuth-Client nicht autorisiert',
        'invalid_client': 'Ungültige Client-ID',
        'no_session': 'Keine Session erhalten',
        'pkce_error': 'Authentifizierungs-Fehler (PKCE)',
        'ACCOUNT_SYNC_FAILED': 'Konto konnte nicht angelegt werden',
        'EMAIL_MISSING': 'Keine E-Mail-Adresse',
        'AUTH_INVALID': 'Authentifizierung ungültig',
        'unknown': 'Authentifizierung fehlgeschlagen',
      };
      return titles[code] || titles['unknown'];
    }

    /**
     * Get helpful hint for common errors
     */
    function getErrorHint(code: string): string | null {
      const hints: Record<string, string> = {
        'redirect_uri_mismatch': 
          'Die Redirect-URI in der Google Cloud Console stimmt nicht mit der Supabase-Callback-URL überein. ' +
          'Prüfe: Google Cloud → Credentials → OAuth Client → Authorized redirect URIs muss die Supabase-Callback-URL enthalten.',
        'invalid_grant': 
          'Der Authentifizierungscode ist abgelaufen oder wurde bereits verwendet. Bitte versuche es erneut.',
        'access_denied': 
          'Du hast die Anmeldung abgebrochen oder der Zugriff wurde verweigert.',
        'unauthorized_client': 
          'Der OAuth-Client ist nicht korrekt in der Google Cloud Console konfiguriert.',
        'invalid_client': 
          'Die Client-ID in Supabase stimmt nicht mit der in der Google Cloud Console überein.',
        'no_session': 
          'Nach der Anmeldung wurde keine Session erstellt. Prüfe die Supabase-Konfiguration (Providers → Google).',
        'pkce_error': 
          'Fehler beim Code-Austausch. Bitte versuche es erneut oder lösche die Browser-Cookies für diese Seite.',
        'ACCOUNT_SYNC_FAILED': 
          'Dein Konto konnte nicht in der Datenbank angelegt werden. Bitte versuche es erneut.',
        'EMAIL_MISSING': 
          'Google hat keine E-Mail-Adresse übermittelt. Bitte nutze den E-Mail-Login oder prüfe deine Google-Kontoeinstellungen.',
      };
      return hints[code] || null;
    }

    /**
     * Check if error is a configuration error (needs longer display time)
     */
    function isConfigError(err: unknown): boolean {
      if (!(err instanceof Error)) return false;
      const code = getErrorCode(err.message);
      return ['redirect_uri_mismatch', 'unauthorized_client', 'invalid_client', 'no_session'].includes(code);
    }

    /**
     * Clean up auth state on error
     */
    async function cleanupAuthState() {
      localStorage.removeItem('auth_token');
      sessionStorage.removeItem('auth_token');
      try {
        await supabase.auth.signOut();
      } catch {
        // Ignore signOut errors
      }
    }

    async function handleCallback() {
      const titleEl = document.getElementById('title') as HTMLElement | null;
      const messageEl = document.getElementById('message') as HTMLElement | null;
      const spinnerEl = document.getElementById('spinner') as HTMLElement | null;
      const errorEl = document.getElementById('error') as HTMLElement | null;

      // For redirect after error
      let errorCode = 'auth_failed';

      try {
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const queryParams = new URLSearchParams(window.location.search);
        
        // #region agent log
        fetch('http://127.0.0.1:7245/ingest/5d9bb467-7a30-458e-a7a6-30ea6b541c63',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'callback.astro:handleCallback:entry',message:'Callback started',data:{hash:window.location.hash,search:window.location.search,hasCode:!!queryParams.get('code')},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'A,B'})}).catch(()=>{});
        // #endregion
        
        // Check for error in URL
        const error = hashParams.get('error') || queryParams.get('error');
        const errorDescription = hashParams.get('error_description') || queryParams.get('error_description');
        
        if (error) {
          throw new Error(errorDescription || error);
        }

        // PKCE Flow: Exchange code for session first
        const code = queryParams.get('code');
        if (code) {
          // #region agent log
          fetch('http://127.0.0.1:7245/ingest/5d9bb467-7a30-458e-a7a6-30ea6b541c63',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'callback.astro:exchangeCode:before',message:'Exchanging code for session',data:{codeLength:code.length},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'B'})}).catch(()=>{});
          // #endregion
          const { error: exchangeError } = await supabase.auth.exchangeCodeForSession(code);
          // #region agent log
          fetch('http://127.0.0.1:7245/ingest/5d9bb467-7a30-458e-a7a6-30ea6b541c63',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'callback.astro:exchangeCode:after',message:'Exchange result',data:{success:!exchangeError,error:exchangeError?.message},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'B'})}).catch(()=>{});
          // #endregion
          if (exchangeError) {
            throw exchangeError;
          }
        }

        // Now get the session (should exist after exchange or from hash)
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        
        // #region agent log
        fetch('http://127.0.0.1:7245/ingest/5d9bb467-7a30-458e-a7a6-30ea6b541c63',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'callback.astro:getSession',message:'Session retrieved',data:{hasSession:!!session,hasToken:!!session?.access_token,sessionError:sessionError?.message},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'A,B'})}).catch(()=>{});
        // #endregion
        
        if (sessionError) {
          throw sessionError;
        }

        if (!session) {
          throw new Error('Keine Session nach OAuth-Callback erhalten');
        }

        // Check if "remember me" was selected (stored before OAuth redirect)
        const remember = localStorage.getItem('auth_remember') !== 'false';
        localStorage.removeItem('auth_remember');

        // Store token based on "remember me" preference
        if (remember) {
          localStorage.setItem('auth_token', session.access_token);
        } else {
          sessionStorage.setItem('auth_token', session.access_token);
        }
        
        // #region agent log
        fetch('http://127.0.0.1:7245/ingest/5d9bb467-7a30-458e-a7a6-30ea6b541c63',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'callback.astro:tokenStored',message:'Token stored in storage',data:{remember,tokenInLocalStorage:!!localStorage.getItem('auth_token'),tokenInSessionStorage:!!sessionStorage.getItem('auth_token')},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'A'})}).catch(()=>{});
        // #endregion

        // Update UI - syncing
        if (messageEl) messageEl.textContent = 'Konto wird synchronisiert...';

        // ============================================
        // CRITICAL: Sync user to backend database
        // This ensures the Prisma user exists before we consider the login successful
        // ============================================
        // #region agent log
        fetch('http://127.0.0.1:7245/ingest/5d9bb467-7a30-458e-a7a6-30ea6b541c63',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'callback.astro:sync:before',message:'Calling backend sync',data:{apiBase:API_BASE},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'C'})}).catch(()=>{});
        // #endregion
        const syncResponse = await fetch(`${API_BASE}/api/auth/sync`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${session.access_token}` }
        });

        // #region agent log
        fetch('http://127.0.0.1:7245/ingest/5d9bb467-7a30-458e-a7a6-30ea6b541c63',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'callback.astro:sync:after',message:'Backend sync response',data:{status:syncResponse.status,ok:syncResponse.ok},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'C'})}).catch(()=>{});
        // #endregion

        if (!syncResponse.ok) {
          const syncData = await syncResponse.json().catch(() => ({}));
          errorCode = syncData.error?.code || 'ACCOUNT_SYNC_FAILED';
          
          // Clean up - user is in Supabase but not synced to our DB
          await cleanupAuthState();
          
          throw new Error(syncData.error?.message || 'Konto konnte nicht synchronisiert werden');
        }

        // Debug logging in dev mode
        if (import.meta.env.DEV) {
          const syncData = await syncResponse.clone().json();
          console.log('[Auth Callback] Sync successful:', syncData);
        }

        // Update UI - success
        if (titleEl) titleEl.textContent = 'Anmeldung erfolgreich!';
        if (messageEl) messageEl.textContent = 'Du wirst weitergeleitet...';
        if (spinnerEl) spinnerEl.style.borderTopColor = '#10b981';

        // Redirect
        const redirectTo = localStorage.getItem('auth_redirect') || '/';
        localStorage.removeItem('auth_redirect');
        
        // #region agent log
        fetch('http://127.0.0.1:7245/ingest/5d9bb467-7a30-458e-a7a6-30ea6b541c63',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'callback.astro:success',message:'Login successful, redirecting',data:{redirectTo,tokenStillInLocalStorage:!!localStorage.getItem('auth_token')},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'A'})}).catch(()=>{});
        // #endregion

        setTimeout(() => {
          window.location.href = redirectTo;
        }, 1000);

      } catch (err) {
        if (spinnerEl) spinnerEl.style.display = 'none';
        if (titleEl) titleEl.textContent = 'Anmeldung fehlgeschlagen';
        if (messageEl) messageEl.textContent = 'Es gab ein Problem bei der Anmeldung.';
        
        if (errorEl) {
          const errorMessage = err instanceof Error ? err.message : 'Unbekannter Fehler';
          const displayCode = getErrorCode(errorMessage) !== 'unknown' ? getErrorCode(errorMessage) : errorCode;
          const errorHint = getErrorHint(displayCode);
          
          errorEl.style.display = 'block';
          errorEl.innerHTML = `
            <div class="error-title">${getErrorTitle(displayCode)}</div>
            <div class="error-details">${errorMessage}</div>
            ${errorHint ? `<div class="error-hint">${errorHint}</div>` : ''}
          `;
        }

        // Clean up auth state on any error
        await cleanupAuthState();

        // Redirect to login after delay (longer for config errors)
        const redirectDelay = isConfigError(err) ? 8000 : 3000;
        setTimeout(() => {
          window.location.href = `/login?error=${errorCode}`;
        }, redirectDelay);
      }
    }

    // Run on page load
    handleCallback();
  </script>
</body>
</html>
