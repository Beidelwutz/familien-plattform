---
import AdminLayout from '../../layouts/AdminLayout.astro';
const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:4000';
---

<AdminLayout title="Review Queue - kiezling Admin" currentPage="review">
  <div class="flex gap-6 min-h-[calc(100vh-120px)]">
    <!-- Filter Sidebar (Desktop) -->
    <aside id="filter-sidebar" class="hidden lg:block w-60 flex-shrink-0">
      <div class="bg-white rounded-xl border border-gray-200 p-4 sticky top-4">
        <h2 class="font-semibold text-gray-900 mb-4">Filter</h2>
        
        <!-- Status Filter -->
        <div class="mb-6">
          <h3 class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-3">Status</h3>
          
          <!-- Aktiv Group -->
          <div class="mb-3">
            <span class="text-xs text-gray-400 block mb-1">Aktiv</span>
            <div class="space-y-1">
              <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 rounded px-2 py-1.5">
                <input type="radio" name="status" value="pending_review" class="status-radio text-primary-500 focus:ring-primary-500" checked>
                <span class="text-sm text-gray-700">Ausstehend</span>
                <span id="count-pending_review" class="ml-auto text-xs text-gray-400"></span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 rounded px-2 py-1.5">
                <input type="radio" name="status" value="pending_ai" class="status-radio text-primary-500 focus:ring-primary-500">
                <span class="text-sm text-gray-700">Warte auf AI</span>
                <span id="count-pending_ai" class="ml-auto text-xs text-gray-400"></span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 rounded px-2 py-1.5">
                <input type="radio" name="status" value="incomplete" class="status-radio text-primary-500 focus:ring-primary-500">
                <span class="text-sm text-gray-700">Unvollst√§ndig</span>
                <span id="count-incomplete" class="ml-auto text-xs text-gray-400"></span>
              </label>
            </div>
          </div>

          <!-- Entschieden Group -->
          <div class="mb-3">
            <span class="text-xs text-gray-400 block mb-1">Entschieden</span>
            <div class="space-y-1">
              <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 rounded px-2 py-1.5">
                <input type="radio" name="status" value="published" class="status-radio text-primary-500 focus:ring-primary-500">
                <span class="text-sm text-gray-700">Ver√∂ffentlicht</span>
                <span id="count-published" class="ml-auto text-xs text-gray-400"></span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 rounded px-2 py-1.5">
                <input type="radio" name="status" value="rejected" class="status-radio text-primary-500 focus:ring-primary-500">
                <span class="text-sm text-gray-700">Abgelehnt</span>
                <span id="count-rejected" class="ml-auto text-xs text-gray-400"></span>
              </label>
            </div>
          </div>

          <!-- Archiv Group -->
          <div class="mb-3">
            <span class="text-xs text-gray-400 block mb-1">Archiv</span>
            <div class="space-y-1">
              <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 rounded px-2 py-1.5">
                <input type="radio" name="status" value="archived" class="status-radio text-primary-500 focus:ring-primary-500">
                <span class="text-sm text-gray-700">Archiviert</span>
                <span id="count-archived" class="ml-auto text-xs text-gray-400"></span>
              </label>
            </div>
          </div>

          <!-- All -->
          <div>
            <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 rounded px-2 py-1.5 border-t border-gray-100 pt-2">
              <input type="radio" name="status" value="all" class="status-radio text-primary-500 focus:ring-primary-500">
              <span class="text-sm text-gray-700 font-medium">Alle Events</span>
            </label>
          </div>
        </div>

        <!-- Source Filter -->
        <div class="mb-6">
          <h3 class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Quelle</h3>
          <select id="source-filter" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
            <option value="">Alle Quellen</option>
          </select>
        </div>

        <!-- Score Filter -->
        <div class="mb-6">
          <h3 class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Family Fit Score</h3>
          <div class="px-2">
            <input type="range" id="score-filter" min="0" max="100" value="0" class="w-full accent-primary-500">
            <div class="flex justify-between text-xs text-gray-400 mt-1">
              <span>0</span>
              <span id="score-value" class="font-medium text-gray-600">0+</span>
              <span>100</span>
            </div>
          </div>
        </div>

        <!-- Clear Filters -->
        <button id="clear-filters" class="w-full px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
          Filter zur√ºcksetzen
        </button>
      </div>
    </aside>

    <!-- Mobile Filter Toggle -->
    <button id="mobile-filter-btn" class="lg:hidden fixed bottom-4 left-4 z-40 bg-primary-500 text-white px-4 py-3 rounded-full shadow-lg flex items-center gap-2 hover:bg-primary-600 transition-colors">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
      </svg>
      <span>Filter</span>
    </button>

    <!-- Mobile Filter Overlay -->
    <div id="mobile-filter-overlay" class="lg:hidden fixed inset-0 bg-black/50 z-40 hidden">
      <div id="mobile-filter-panel" class="absolute left-0 top-0 bottom-0 w-72 bg-white p-4 overflow-y-auto transform -translate-x-full transition-transform duration-300">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold text-gray-900">Filter</h2>
          <button id="close-mobile-filter" class="p-2 hover:bg-gray-100 rounded-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        
        <!-- Mobile Filter Content (cloned from desktop) -->
        <div id="mobile-filter-content"></div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 min-w-0">
      <!-- Header Row -->
      <div class="bg-white rounded-xl border border-gray-200 p-4 mb-4">
        <div class="flex flex-col sm:flex-row sm:items-center gap-4">
          <div class="flex-1">
            <h1 class="text-xl font-bold text-gray-900">Review Queue</h1>
            <p id="event-count" class="text-sm text-gray-500">Lade Events...</p>
          </div>
          
          <div class="flex flex-col sm:flex-row gap-3">
            <!-- Search Input -->
            <div class="relative">
              <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <input type="text" id="search-input" placeholder="Events durchsuchen..." class="w-full sm:w-64 pl-9 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
            </div>
            
            <!-- Sort Dropdown -->
            <select id="sort-select" class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
              <option value="date_desc">Datum (neueste)</option>
              <option value="date_asc">Datum (√§lteste)</option>
              <option value="score_desc">Score (h√∂chste)</option>
              <option value="score_asc">Score (niedrigste)</option>
              <option value="title_asc">Titel (A-Z)</option>
              <option value="title_desc">Titel (Z-A)</option>
            </select>
            
            <!-- Refresh Button -->
            <button id="refresh-btn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium text-gray-700 transition-colors flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              Aktualisieren
            </button>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loading-state" class="bg-white rounded-xl border border-gray-200 p-12 text-center">
        <div class="animate-spin inline-block w-8 h-8 border-4 border-primary-500 border-t-transparent rounded-full"></div>
        <p class="text-gray-500 mt-4">Lade Events...</p>
      </div>

      <!-- Event List -->
      <div id="review-list" class="hidden space-y-3"></div>

      <!-- Empty State -->
      <div id="empty-state" class="hidden bg-white rounded-xl border border-gray-200 p-12 text-center">
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
          </svg>
        </div>
        <p class="text-gray-500 text-lg">Keine Events gefunden</p>
        <p class="text-gray-400 text-sm mt-1">Versuche andere Filter oder Suchbegriffe</p>
      </div>

      <!-- Pagination / Load More -->
      <div id="pagination" class="hidden mt-4 flex justify-center">
        <button id="load-more-btn" class="px-6 py-3 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors flex items-center gap-2">
          <span>Mehr laden</span>
          <span id="remaining-count" class="text-gray-400"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- Reject Modal -->
  <div class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4" id="reject-modal">
    <div class="bg-white rounded-2xl max-w-md w-full p-6 shadow-xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Event ablehnen</h3>
        <button class="modal-close p-1 hover:bg-gray-100 rounded-lg">
          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Grund</label>
          <select id="reject-reason-code" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
            <option value="">-- Bitte w√§hlen --</option>
            <option value="spam">Spam / Werbung</option>
            <option value="incomplete">Unvollst√§ndig</option>
            <option value="wrong_date">Falsches Datum</option>
            <option value="duplicate">Duplikat</option>
            <option value="not_relevant">Nicht relevant</option>
            <option value="other">Sonstiges</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Kommentar (optional)</label>
          <textarea id="reject-reason-text" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500" placeholder="Zus√§tzliche Details..."></textarea>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button id="reject-cancel" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium transition-colors">Abbrechen</button>
        <button id="reject-confirm" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-medium transition-colors">Ablehnen</button>
      </div>
    </div>
  </div>

  <!-- Quick Edit Modal -->
  <div class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4" id="edit-modal">
    <div class="bg-white rounded-2xl max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto shadow-xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Event bearbeiten & genehmigen</h3>
        <button class="modal-close p-1 hover:bg-gray-100 rounded-lg">
          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="space-y-4">
        <div>
          <div class="flex items-center justify-between mb-1">
            <label class="text-sm font-medium text-gray-700">Titel</label>
            <label class="flex items-center gap-1 text-xs text-gray-500 cursor-pointer">
              <input type="checkbox" id="lock-title" class="lock-checkbox rounded text-primary-500 focus:ring-primary-500"> Sperren
            </label>
          </div>
          <input type="text" id="edit-title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
        </div>
        <div>
          <div class="flex items-center justify-between mb-1">
            <label class="text-sm font-medium text-gray-700">Startdatum</label>
            <label class="flex items-center gap-1 text-xs text-gray-500 cursor-pointer">
              <input type="checkbox" id="lock-start" class="lock-checkbox rounded text-primary-500 focus:ring-primary-500"> Sperren
            </label>
          </div>
          <input type="datetime-local" id="edit-start" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
        </div>
        <div>
          <div class="flex items-center justify-between mb-1">
            <label class="text-sm font-medium text-gray-700">Enddatum</label>
            <label class="flex items-center gap-1 text-xs text-gray-500 cursor-pointer">
              <input type="checkbox" id="lock-end" class="lock-checkbox rounded text-primary-500 focus:ring-primary-500"> Sperren
            </label>
          </div>
          <input type="datetime-local" id="edit-end" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
        </div>
        <div>
          <div class="flex items-center justify-between mb-1">
            <label class="text-sm font-medium text-gray-700">Adresse</label>
            <label class="flex items-center gap-1 text-xs text-gray-500 cursor-pointer">
              <input type="checkbox" id="lock-address" class="lock-checkbox rounded text-primary-500 focus:ring-primary-500"> Sperren
            </label>
          </div>
          <input type="text" id="edit-address" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
        </div>
      </div>
      <p class="text-xs text-gray-500 mt-4 bg-gray-50 p-3 rounded-lg">
        <span class="font-medium">Hinweis:</span> Gesperrte Felder werden nicht durch automatische Updates √ºberschrieben.
      </p>
      <div class="flex gap-3 mt-6">
        <button id="edit-cancel" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium transition-colors">Abbrechen</button>
        <button id="edit-confirm" class="flex-1 px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 font-medium transition-colors">Speichern & Genehmigen</button>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4" id="detail-modal">
    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-xl">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-start justify-between">
          <h2 id="detail-title" class="text-xl font-semibold pr-8">Event Details</h2>
          <button id="detail-close" class="p-1 hover:bg-gray-100 rounded-lg">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div id="detail-badges" class="flex flex-wrap gap-2 mt-3"></div>
      </div>
      <div class="p-6 space-y-6">
        <div>
          <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Details</h3>
          <div id="detail-info" class="grid grid-cols-2 gap-3"></div>
        </div>
        <div>
          <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Beschreibungen</h3>
          <div id="detail-descriptions" class="space-y-4"></div>
        </div>
        <div>
          <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">AI-Scores</h3>
          <div id="detail-scores" class="bg-gray-50 rounded-lg p-4"></div>
        </div>
        <div>
          <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Quelle</h3>
          <div id="detail-source" class="bg-gray-50 rounded-lg p-4"></div>
        </div>
        <div>
          <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">RAW-Daten / Import</h3>
          <p class="text-xs text-gray-500 mb-2">Rohdaten von der Quelle und vom AI-Worker (womit am Anfang gearbeitet wurde)</p>
          <div id="detail-raw-loading" class="hidden py-4 text-center text-gray-500 text-sm">Lade Rohdaten‚Ä¶</div>
          <div id="detail-raw-content" class="space-y-4"></div>
        </div>
      </div>
      <div class="p-6 border-t border-gray-200 flex flex-wrap gap-3 justify-end bg-gray-50 rounded-b-2xl">
        <button id="detail-approve" class="px-5 py-2.5 bg-green-500 text-white rounded-lg hover:bg-green-600 font-medium transition-colors flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          Genehmigen
        </button>
        <button id="detail-edit" class="px-5 py-2.5 bg-primary-500 text-white rounded-lg hover:bg-primary-600 font-medium transition-colors flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
          Bearbeiten
        </button>
        <button id="detail-reject" class="px-5 py-2.5 bg-red-500 text-white rounded-lg hover:bg-red-600 font-medium transition-colors flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          Ablehnen
        </button>
        <button id="detail-delete" class="px-5 py-2.5 bg-gray-800 text-white rounded-lg hover:bg-gray-900 font-medium transition-colors flex items-center gap-2" title="Event dauerhaft l√∂schen">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          L√∂schen
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4" id="delete-modal">
    <div class="bg-white rounded-2xl max-w-md w-full p-6 shadow-xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-red-600">Event dauerhaft l√∂schen</h3>
        <button class="modal-close p-1 hover:bg-gray-100 rounded-lg">
          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
        <div class="flex items-start gap-3">
          <svg class="w-6 h-6 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <div>
            <p class="text-sm text-red-700 font-medium">Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!</p>
            <p class="text-sm text-red-600 mt-1">Das Event und alle zugeh√∂rigen Daten (Scores, Kategorien, Quellen-Verkn√ºpfungen) werden permanent gel√∂scht.</p>
          </div>
        </div>
      </div>
      <div class="mb-4">
        <p class="text-sm text-gray-600 mb-2">Event das gel√∂scht wird:</p>
        <p id="delete-event-title" class="font-medium text-gray-900 bg-gray-50 p-3 rounded-lg"></p>
      </div>
      <div class="flex gap-3">
        <button id="delete-cancel" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium transition-colors">Abbrechen</button>
        <button id="delete-confirm" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium transition-colors flex items-center justify-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          Endg√ºltig l√∂schen
        </button>
      </div>
    </div>
  </div>
</AdminLayout>

<script is:inline define:vars={{ API_URL }}>
  // State
  let events = [];
  let allEvents = []; // For client-side filtering/search
  let currentEventId = null;
  let currentPage = 1;
  let totalEvents = 0;
  let hasMore = false;
  const PAGE_SIZE = 50;
  
  // Filters state
  let filters = {
    status: 'pending_review',
    source: '',
    minScore: 0,
    search: '',
    sort: 'date_desc'
  };

  // Get auth token
  const token = localStorage.getItem('auth_token');

  // API Fetch helper
  async function apiFetch(endpoint, options = {}) {
    const res = await fetch(`${API_URL}${endpoint}`, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
        ...options.headers,
      },
    });
    if (res.status === 401 || res.status === 403) {
      throw new Error('Unauthorized');
    }
    return res.json();
  }

  // Load sources for filter dropdown
  async function loadSources() {
    try {
      const data = await apiFetch('/api/admin/sources?limit=100');
      const sources = data.data || [];
      const select = document.getElementById('source-filter');
      
      sources.forEach(source => {
        const option = document.createElement('option');
        option.value = source.id;
        option.textContent = source.name;
        select.appendChild(option);
      });
    } catch (e) {
      console.error('Failed to load sources:', e);
    }
  }

  // Load status counts
  async function loadStatusCounts() {
    try {
      const data = await apiFetch('/api/admin/stats');
      const stats = data.data?.events || {};
      
      const countMap = {
        'pending_review': stats.pending_review || 0,
        'pending_ai': stats.pending_ai || 0,
        'incomplete': stats.incomplete || 0,
        'published': stats.published || 0,
        'rejected': stats.rejected || 0,
        'archived': stats.archived || 0,
      };
      
      Object.entries(countMap).forEach(([status, count]) => {
        const el = document.getElementById(`count-${status}`);
        if (el) el.textContent = count > 0 ? count : '';
      });
    } catch (e) {
      console.error('Failed to load status counts:', e);
    }
  }

  // Build query string from filters
  function buildQueryString() {
    const params = new URLSearchParams();
    params.set('status', filters.status);
    params.set('limit', PAGE_SIZE.toString());
    params.set('offset', ((currentPage - 1) * PAGE_SIZE).toString());
    
    if (filters.source) params.set('source_id', filters.source);
    if (filters.minScore > 0) params.set('min_score', filters.minScore.toString());
    
    return params.toString();
  }

  // Load events
  async function loadEvents(append = false) {
    if (!append) {
      currentPage = 1;
      document.getElementById('loading-state').classList.remove('hidden');
      document.getElementById('review-list').classList.add('hidden');
      document.getElementById('empty-state').classList.add('hidden');
      document.getElementById('pagination').classList.add('hidden');
    }

    try {
      const queryString = buildQueryString();
      const data = await apiFetch(`/api/admin/review-queue?${queryString}`);
      
      const newEvents = data.data || [];
      totalEvents = data.pagination?.total || newEvents.length;
      
      if (append) {
        allEvents = [...allEvents, ...newEvents];
      } else {
        allEvents = newEvents;
      }
      
      // Apply client-side search filter
      filterAndRenderEvents();
      
      // Check if there are more
      hasMore = allEvents.length < totalEvents;
      updatePagination();
      
    } catch (e) {
      console.error('Load error:', e);
      document.getElementById('empty-state').classList.remove('hidden');
      document.getElementById('empty-state').innerHTML = `
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
        <p class="text-red-500 text-lg">Fehler beim Laden</p>
        <p class="text-gray-400 text-sm mt-1">${e.message}</p>
      `;
    } finally {
      document.getElementById('loading-state').classList.add('hidden');
    }
  }

  // Filter events client-side and render
  function filterAndRenderEvents() {
    let filtered = [...allEvents];
    
    // Search filter
    if (filters.search) {
      const searchLower = filters.search.toLowerCase();
      filtered = filtered.filter(event => 
        event.title?.toLowerCase().includes(searchLower) ||
        event.location_address?.toLowerCase().includes(searchLower) ||
        event.description_short?.toLowerCase().includes(searchLower)
      );
    }
    
    // Score filter (client-side additional filtering)
    if (filters.minScore > 0) {
      filtered = filtered.filter(event => {
        const score = event.scores?.family_fit_score;
        return score !== null && score !== undefined && score >= filters.minScore;
      });
    }
    
    // Sort
    filtered = sortEvents(filtered);
    
    events = filtered;
    
    // Update count
    document.getElementById('event-count').textContent = `${events.length} von ${totalEvents} Events`;
    
    if (events.length === 0) {
      document.getElementById('empty-state').classList.remove('hidden');
      document.getElementById('review-list').classList.add('hidden');
    } else {
      document.getElementById('empty-state').classList.add('hidden');
      document.getElementById('review-list').classList.remove('hidden');
      renderEvents();
    }
  }

  // Sort events
  function sortEvents(eventList) {
    return eventList.sort((a, b) => {
      switch (filters.sort) {
        case 'date_desc':
          return new Date(b.start_datetime || 0) - new Date(a.start_datetime || 0);
        case 'date_asc':
          return new Date(a.start_datetime || 0) - new Date(b.start_datetime || 0);
        case 'score_desc':
          return (b.scores?.family_fit_score || 0) - (a.scores?.family_fit_score || 0);
        case 'score_asc':
          return (a.scores?.family_fit_score || 0) - (b.scores?.family_fit_score || 0);
        case 'title_asc':
          return (a.title || '').localeCompare(b.title || '');
        case 'title_desc':
          return (b.title || '').localeCompare(a.title || '');
        default:
          return 0;
      }
    });
  }

  // Update pagination
  function updatePagination() {
    const paginationEl = document.getElementById('pagination');
    const remainingCount = document.getElementById('remaining-count');
    
    if (hasMore) {
      paginationEl.classList.remove('hidden');
      const remaining = totalEvents - allEvents.length;
      remainingCount.textContent = `(${remaining} weitere)`;
    } else {
      paginationEl.classList.add('hidden');
    }
  }

  // Helper functions
  function getStatusBadge(status) {
    const styles = {
      pending_review: 'bg-amber-100 text-amber-700',
      pending_ai: 'bg-blue-100 text-blue-700',
      incomplete: 'bg-gray-100 text-gray-600',
      published: 'bg-green-100 text-green-700',
      rejected: 'bg-red-100 text-red-700',
      archived: 'bg-gray-100 text-gray-500',
      cancelled: 'bg-orange-100 text-orange-700',
      stale: 'bg-yellow-100 text-yellow-700',
    };
    const labels = {
      pending_review: 'Ausstehend',
      pending_ai: 'Warte auf AI',
      incomplete: 'Unvollst√§ndig',
      published: 'Ver√∂ffentlicht',
      rejected: 'Abgelehnt',
      archived: 'Archiviert',
      cancelled: 'Abgesagt',
      stale: 'Veraltet',
    };
    return { style: styles[status] || 'bg-gray-100 text-gray-600', label: labels[status] || status };
  }

  function getScoreBadge(score) {
    if (score === null || score === undefined) return { style: 'bg-gray-100 text-gray-400', color: 'gray' };
    if (score >= 80) return { style: 'bg-green-100 text-green-700', color: 'green' };
    if (score >= 60) return { style: 'bg-yellow-100 text-yellow-700', color: 'yellow' };
    return { style: 'bg-red-100 text-red-700', color: 'red' };
  }

  function getReviewReasonBadge(event) {
    if (event.status === 'rejected') {
      const label = event.rejection_label || 'Abgelehnt';
      const isAI = event.rejection_type === 'AI_REJECTED';
      return `<span class="px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-700" title="${label}">${isAI ? 'ü§ñ ' : ''}${label}</span>`;
    }
    if (event.status === 'pending_review' && event.review_reason_label) {
      const reasonStyles = {
        'AI unsicher': 'bg-yellow-100 text-yellow-700',
        'Grenzfall Familie': 'bg-orange-100 text-orange-700',
        'Unvollst√§ndig': 'bg-gray-100 text-gray-600',
        'Manuelle Pr√ºfung': 'bg-blue-100 text-blue-700',
        'Keine Scores': 'bg-gray-100 text-gray-500',
        'Warte auf AI': 'bg-blue-100 text-blue-700',
      };
      const style = reasonStyles[event.review_reason_label] || 'bg-gray-100 text-gray-600';
      return `<span class="px-2 py-0.5 text-xs rounded-full ${style}">${event.review_reason_label}</span>`;
    }
    return '';
  }

  /** Relative Zeit f√ºr "Von KI √ºberpr√ºft vor X" (z.B. vor 2 Min., vor 2 Std., vor 3 Tagen) */
  function formatRelativeTime(isoString) {
    if (!isoString) return '';
    const date = new Date(isoString);
    if (Number.isNaN(date.getTime())) return '';
    const now = new Date();
    const diffMs = now - date;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHours = Math.floor(diffMin / 60);
    const diffDays = Math.floor(diffHours / 24);
    if (diffSec < 60) return 'vor wenigen Sek.';
    if (diffMin < 60) return diffMin === 1 ? 'vor 1 Min.' : `vor ${diffMin} Min.`;
    if (diffHours < 24) return diffHours === 1 ? 'vor 1 Std.' : `vor ${diffHours} Std.`;
    if (diffDays < 7) return diffDays === 1 ? 'vor 1 Tag' : `vor ${diffDays} Tagen`;
    return date.toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' });
  }

  // Render event list
  function renderEvents() {
    const list = document.getElementById('review-list');
    list.innerHTML = events.map(event => {
      // Format date
      let date = 'Kein Datum';
      try {
        if (event.start_datetime) {
          date = new Date(event.start_datetime).toLocaleDateString('de-DE', { 
            weekday: 'short',
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
          });
        }
      } catch (e) {}
      
      const sourceName = event.primary_source?.source?.name || 'Unbekannt';
      const completenessScore = event.completeness_score || 0;
      const statusBadge = getStatusBadge(event.status);
      const scores = event.scores || {};
      const familyFitScore = scores.family_fit_score;
      const scoreBadge = getScoreBadge(familyFitScore);
      const reasonBadge = getReviewReasonBadge(event);
      const showActions = ['pending_review', 'pending_ai', 'incomplete'].includes(event.status);
      const confidence = scores.confidence ? Math.round(Number(scores.confidence) * 100) : null;
      
      return `
        <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md hover:border-gray-300 transition-all cursor-pointer group" data-id="${event.id}">
          <div class="flex items-start gap-4">
            <!-- Score Badge (left) -->
            <div class="flex-shrink-0 hidden sm:block">
              <div class="w-14 h-14 rounded-xl ${scoreBadge.style} flex flex-col items-center justify-center">
                <span class="text-lg font-bold">${familyFitScore !== null && familyFitScore !== undefined ? familyFitScore : '?'}</span>
                <span class="text-[10px] uppercase tracking-wide opacity-75">Score</span>
              </div>
            </div>
            
            <!-- Content -->
            <div class="flex-1 min-w-0">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <h3 class="font-semibold text-gray-900 group-hover:text-primary-600 transition-colors truncate">${event.title}</h3>
                  <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-sm text-gray-500 mt-1">
                    <span class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      ${date}
                    </span>
                    ${event.location_address ? `
                      <span class="flex items-center gap-1 truncate max-w-[200px]">
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        ${event.location_address}
                      </span>
                    ` : ''}
                  </div>
                </div>
                
                <!-- Mobile Score Badge -->
                <div class="sm:hidden flex-shrink-0">
                  <div class="w-10 h-10 rounded-lg ${scoreBadge.style} flex items-center justify-center">
                    <span class="text-sm font-bold">${familyFitScore !== null && familyFitScore !== undefined ? familyFitScore : '?'}</span>
                  </div>
                </div>
              </div>
              
              <!-- Badges Row -->
              <div class="flex flex-wrap items-center gap-2 mt-3">
                <span class="px-2 py-0.5 text-xs rounded-full ${statusBadge.style}">${statusBadge.label}</span>
                ${reasonBadge}
                ${scores.scored_at ? `
                  <span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-800 inline-flex items-center gap-1" title="Von KI √ºberpr√ºft">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Von KI √ºberpr√ºft ${formatRelativeTime(scores.scored_at)}
                  </span>
                ` : ''}
                <span class="px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-600">${sourceName}</span>
                <span class="px-2 py-0.5 text-xs rounded-full ${completenessScore < 50 ? 'bg-red-100 text-red-600' : completenessScore < 80 ? 'bg-yellow-100 text-yellow-600' : 'bg-green-100 text-green-600'}">
                  ${completenessScore}% vollst√§ndig
                </span>
                ${confidence !== null ? `
                  <span class="px-2 py-0.5 text-xs rounded-full bg-primary-50 text-primary-600" title="AI Konfidenz">
                    üéØ ${confidence}%
                  </span>
                ` : ''}
              </div>
            </div>
            
            <!-- Actions -->
            ${showActions ? `
              <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0">
                <button class="action-btn w-10 h-10 rounded-lg bg-green-100 text-green-600 hover:bg-green-200 transition-colors flex items-center justify-center" data-action="approve" data-id="${event.id}" title="Genehmigen">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                </button>
                <button class="action-btn w-10 h-10 rounded-lg bg-primary-100 text-primary-600 hover:bg-primary-200 transition-colors flex items-center justify-center" data-action="edit" data-id="${event.id}" title="Bearbeiten & Genehmigen">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                </button>
                <button class="action-btn w-10 h-10 rounded-lg bg-red-100 text-red-600 hover:bg-red-200 transition-colors flex items-center justify-center" data-action="reject" data-id="${event.id}" title="Ablehnen">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
                <button class="action-btn w-10 h-10 rounded-lg bg-gray-800 text-white hover:bg-gray-900 transition-colors flex items-center justify-center" data-action="delete" data-id="${event.id}" title="Dauerhaft l√∂schen">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
            ` : `
              <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0">
                <button class="action-btn w-10 h-10 rounded-lg bg-gray-100 text-gray-500 hover:bg-gray-200 transition-colors flex items-center justify-center" data-action="view" data-id="${event.id}" title="Details anzeigen">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                </button>
                <button class="action-btn w-10 h-10 rounded-lg bg-gray-800 text-white hover:bg-gray-900 transition-colors flex items-center justify-center" data-action="delete" data-id="${event.id}" title="Dauerhaft l√∂schen">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
            `}
          </div>
        </div>
      `;
    }).join('');

    // Event handlers
    list.querySelectorAll('[data-id]').forEach(el => {
      el.addEventListener('click', (e) => {
        if (!e.target.closest('.action-btn')) {
          openDetailModal(el.dataset.id);
        }
      });
    });

    list.querySelectorAll('.action-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const action = btn.dataset.action;
        const id = btn.dataset.id;
        if (action === 'approve') handleApprove(id, btn);
        else if (action === 'edit') openEditModal(id);
        else if (action === 'reject') openRejectModal(id);
        else if (action === 'view') openDetailModal(id);
        else if (action === 'delete') openDeleteModal(id);
      });
    });
  }

  // Load raw/import data for event and render in detail modal
  async function loadAndShowRawData(eventId) {
    const loadingEl = document.getElementById('detail-raw-loading');
    const contentEl = document.getElementById('detail-raw-content');
    loadingEl.classList.remove('hidden');
    contentEl.innerHTML = '';
    try {
      const res = await apiFetch(`/api/admin/events/${eventId}/raw-data`);
      if (!res.success || !res.data) {
        contentEl.innerHTML = '<p class="text-sm text-gray-500">Keine Rohdaten verf√ºgbar</p>';
        return;
      }
      contentEl.innerHTML = renderRawDataSection(res.data);
    } catch (e) {
      contentEl.innerHTML = '<p class="text-sm text-red-500">Rohdaten konnten nicht geladen werden: ' + (e.message || 'Unbekannter Fehler') + '</p>';
    } finally {
      loadingEl.classList.add('hidden');
    }
  }

  function renderRawDataSection(data) {
    const items = data.raw_event_items || [];
    const sources = data.event_sources || [];
    if (items.length === 0 && sources.length === 0) {
      return '<p class="text-sm text-gray-500">Keine Rohdaten f√ºr dieses Event gespeichert.</p>';
    }
    let html = '';
    if (items.length > 0) {
      html += '<div class="space-y-3">';
      html += '<p class="text-xs font-semibold text-gray-600 uppercase">Import-Batch (RawEventItem)</p>';
      items.forEach((item, i) => {
        const sourceName = item.source?.name || 'Unbekannt';
        const fetchedAt = item.fetched_at ? new Date(item.fetched_at).toLocaleString('de-DE') : '-';
        html += '<div class="border border-gray-200 rounded-lg overflow-hidden">';
        const isFirst = i === 0;
        html += '<button type="button" class="raw-toggle w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 text-left text-sm font-medium text-gray-700 flex items-center justify-between" data-target="raw-item-' + i + '">';
        html += '<span>' + sourceName + ' ¬∑ ' + fetchedAt + (item.ingest_status ? ' ¬∑ ' + item.ingest_status : '') + '</span>';
        html += '<svg class="raw-chevron w-4 h-4 text-gray-500 transition-transform" data-target="raw-item-' + i + '" style="' + (isFirst ? 'transform: rotate(180deg)' : '') + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>';
        html += '</button>';
        html += '<div id="raw-item-' + i + '" class="raw-panel px-4 py-3 bg-gray-50 border-t border-gray-200 text-xs overflow-x-auto' + (isFirst ? '' : ' hidden') + '">';
        if (item.extracted_fields && Object.keys(item.extracted_fields).length) {
          html += '<p class="font-semibold text-gray-600 mb-1">Extrahierte Felder (vom Parser)</p>';
          html += '<pre class="whitespace-pre-wrap break-words text-gray-700">' + escapeHtml(JSON.stringify(item.extracted_fields, null, 2)) + '</pre>';
        }
        if (item.raw_payload && Object.keys(item.raw_payload).length) {
          html += '<p class="font-semibold text-gray-600 mb-1 mt-2">Raw Payload</p>';
          html += '<pre class="whitespace-pre-wrap break-words text-gray-700">' + escapeHtml(JSON.stringify(item.raw_payload, null, 2)) + '</pre>';
        }
        if (item.ai_suggestions && Object.keys(item.ai_suggestions).length) {
          html += '<p class="font-semibold text-gray-600 mb-1 mt-2">AI-Vorschl√§ge</p>';
          html += '<pre class="whitespace-pre-wrap break-words text-gray-700">' + escapeHtml(JSON.stringify(item.ai_suggestions, null, 2)) + '</pre>';
        }
        const hasExtracted = item.extracted_fields && Object.keys(item.extracted_fields).length > 0;
        const hasPayload = item.raw_payload && Object.keys(item.raw_payload).length > 0;
        const hasAi = item.ai_suggestions && Object.keys(item.ai_suggestions).length > 0;
        if (!hasExtracted && !hasPayload && !hasAi) {
          html += '<p class="text-gray-500">Keine weiteren Daten</p>';
        }
        html += '</div></div>';
      });
      html += '</div>';
    }
    if (sources.length > 0) {
      html += '<div class="space-y-3 mt-4">';
      html += '<p class="text-xs font-semibold text-gray-600 uppercase">Event-Quellen (EventSource)</p>';
      sources.forEach((es, i) => {
        const sourceName = es.source?.name || 'Unbekannt';
        const fetchedAt = es.fetched_at ? new Date(es.fetched_at).toLocaleString('de-DE') : '-';
        html += '<div class="border border-gray-200 rounded-lg overflow-hidden">';
        const isFirstSrc = items.length === 0 && i === 0;
        html += '<button type="button" class="raw-toggle w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 text-left text-sm font-medium text-gray-700 flex items-center justify-between" data-target="raw-src-' + i + '">';
        html += '<span>' + sourceName + ' ¬∑ ' + fetchedAt + '</span>';
        html += '<svg class="raw-chevron w-4 h-4 text-gray-500 transition-transform" data-target="raw-src-' + i + '" style="' + (isFirstSrc ? 'transform: rotate(180deg)' : '') + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>';
        html += '</button>';
        html += '<div id="raw-src-' + i + '" class="raw-panel px-4 py-3 bg-gray-50 border-t border-gray-200 text-xs overflow-x-auto' + (isFirstSrc ? '' : ' hidden') + '">';
        if (es.raw_data && Object.keys(es.raw_data).length) {
          html += '<p class="font-semibold text-gray-600 mb-1">Raw Data</p>';
          html += '<pre class="whitespace-pre-wrap break-words text-gray-700">' + escapeHtml(JSON.stringify(es.raw_data, null, 2)) + '</pre>';
        }
        if (es.normalized_data && Object.keys(es.normalized_data).length) {
          html += '<p class="font-semibold text-gray-600 mb-1 mt-2">Normalized Data</p>';
          html += '<pre class="whitespace-pre-wrap break-words text-gray-700">' + escapeHtml(JSON.stringify(es.normalized_data, null, 2)) + '</pre>';
        }
        if (!es.raw_data && !es.normalized_data) {
          html += '<p class="text-gray-500">Keine Rohdaten in dieser Quelle</p>';
        }
        html += '</div></div>';
      });
      html += '</div>';
    }
    setTimeout(() => {
      document.querySelectorAll('.raw-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetId = btn.dataset.target;
          const panel = document.getElementById(targetId);
          const chevron = document.querySelector('.raw-chevron[data-target="' + targetId + '"]');
          if (panel && panel.classList.contains('hidden')) {
            panel.classList.remove('hidden');
            if (chevron) chevron.style.transform = 'rotate(180deg)';
          } else if (panel) {
            panel.classList.add('hidden');
            if (chevron) chevron.style.transform = '';
          }
        });
      });
    }, 0);
    return html;
  }

  function escapeHtml(str) {
    if (str == null) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // Detail Modal
  function openDetailModal(id) {
    currentEventId = id;
    const event = events.find(e => e.id === id) || allEvents.find(e => e.id === id);
    if (!event) return;

    document.getElementById('detail-title').textContent = event.title;
    
    const statusBadge = getStatusBadge(event.status);
    const reasonBadge = getReviewReasonBadge(event);
    const scores = event.scores || {};
    const scoreBadge = getScoreBadge(scores.family_fit_score);
    
    const scoredAtRel = scores.scored_at ? formatRelativeTime(scores.scored_at) : '';
    const scoredAtFormatted = scores.scored_at ? new Date(scores.scored_at).toLocaleString('de-DE') : '';
    document.getElementById('detail-badges').innerHTML = `
      <span class="px-2.5 py-1 text-xs rounded-full ${statusBadge.style} font-medium">${statusBadge.label}</span>
      ${scores.family_fit_score !== null && scores.family_fit_score !== undefined ? `
        <span class="px-2.5 py-1 text-xs rounded-full ${scoreBadge.style} font-medium">
          Family Fit: ${scores.family_fit_score}%
        </span>
      ` : ''}
      ${scores.scored_at ? `
        <span class="px-2.5 py-1 text-xs rounded-full bg-green-100 text-green-800 font-medium inline-flex items-center gap-1">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          Von KI √ºberpr√ºft ${scoredAtRel}
        </span>
      ` : ''}
      ${event.completeness_score ? `
        <span class="px-2.5 py-1 text-xs rounded-full ${event.completeness_score < 50 ? 'bg-red-100 text-red-700' : event.completeness_score < 80 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'} font-medium">
          ${event.completeness_score}% vollst√§ndig
        </span>
      ` : ''}
      ${reasonBadge}
    `;

    const formatDate = (d) => d ? new Date(d).toLocaleString('de-DE') : '-';
    const provenance = event.field_provenance && typeof event.field_provenance === 'object' ? event.field_provenance : {};
    const provLabel = (src) => src ? (src === 'ai' ? 'AI' : src.toUpperCase()) : '';
    const provBadge = (field) => {
      const src = provenance[field];
      if (!src) return '';
      const c = src === 'ai' ? 'bg-primary-100 text-primary-700' : 'bg-gray-200 text-gray-700';
      return `<span class="ml-1 text-xs px-1.5 py-0.5 rounded ${c}">${provLabel(src)}</span>`;
    };
    const confPct = event.ai_summary_confidence != null ? Math.round(Number(event.ai_summary_confidence) * 100) : null;
    const confClass = confPct != null ? (confPct >= 80 ? 'text-green-600' : confPct >= 60 ? 'text-yellow-600' : 'text-red-600') : '';
    document.getElementById('detail-info').innerHTML = `
      <div class="bg-gray-50 p-3 rounded-lg"><span class="text-xs text-gray-500 block mb-1">Start ${provBadge('start_datetime')}</span><span class="font-medium text-gray-900">${formatDate(event.start_datetime)}</span></div>
      <div class="bg-gray-50 p-3 rounded-lg"><span class="text-xs text-gray-500 block mb-1">Ende ${provBadge('end_datetime')}</span><span class="font-medium text-gray-900">${formatDate(event.end_datetime)}</span></div>
      <div class="bg-gray-50 p-3 rounded-lg col-span-2"><span class="text-xs text-gray-500 block mb-1">Adresse ${provBadge('location_address')}</span><span class="font-medium text-gray-900">${event.location_address || '-'}</span></div>
      <div class="bg-gray-50 p-3 rounded-lg"><span class="text-xs text-gray-500 block mb-1">Preis</span><span class="font-medium text-gray-900">${event.price_type || '-'}</span></div>
      <div class="bg-gray-50 p-3 rounded-lg"><span class="text-xs text-gray-500 block mb-1">Alter</span><span class="font-medium text-gray-900">${event.age_min || '?'} - ${event.age_max || '?'} Jahre</span></div>
      ${confPct != null ? `<div class="col-span-2 text-xs ${confClass}">Zusammenfassung-Konfidenz: <strong>${confPct}%</strong></div>` : ''}
    `;

    document.getElementById('detail-descriptions').innerHTML = `
      <div>
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xs font-semibold text-primary-600 uppercase tracking-wide">KI-Zusammenfassung</span>
        </div>
        <div class="bg-primary-50 border border-primary-100 p-4 rounded-lg text-sm text-gray-700">
          ${event.ai_summary_short ? `
            <p>${event.ai_summary_short}</p>
            ${event.ai_fit_blurb ? `<p class="text-primary-600 text-sm font-medium mt-2">üí° ${event.ai_fit_blurb}</p>` : ''}
          ` : '<em class="text-gray-400">Keine KI-Zusammenfassung vorhanden</em>'}
        </div>
      </div>
      <div>
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xs font-semibold text-gray-600 uppercase tracking-wide">Original-Beschreibung</span>
        </div>
        <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg text-sm text-gray-700 max-h-48 overflow-y-auto">
          ${event.description_long || event.description_short || '<em class="text-gray-400">Keine Beschreibung aus Quelle</em>'}
        </div>
      </div>
    `;

    const confidence = scores.confidence ? Math.round(Number(scores.confidence) * 100) : null;
    document.getElementById('detail-scores').innerHTML = scores && (scores.family_fit_score !== null || scores.relevance_score !== null) ? `
      <div class="grid grid-cols-2 gap-3 text-sm">
        <div class="p-3 rounded-lg ${scores.family_fit_score >= 60 ? 'bg-green-50 border border-green-100' : scores.family_fit_score >= 40 ? 'bg-yellow-50 border border-yellow-100' : 'bg-red-50 border border-red-100'}">
          <span class="text-gray-500 block text-xs mb-1">Family Fit</span>
          <strong class="text-lg">${scores.family_fit_score !== null ? scores.family_fit_score + '%' : '-'}</strong>
        </div>
        <div class="p-3 rounded-lg bg-white border border-gray-100">
          <span class="text-gray-500 block text-xs mb-1">Relevanz</span>
          <strong class="text-lg">${scores.relevance_score !== null ? scores.relevance_score + '%' : '-'}</strong>
        </div>
        <div class="p-3 rounded-lg bg-white border border-gray-100">
          <span class="text-gray-500 block text-xs mb-1">Qualit√§t</span>
          <strong class="text-lg">${scores.quality_score !== null ? scores.quality_score + '%' : '-'}</strong>
        </div>
        <div class="p-3 rounded-lg bg-white border border-gray-100">
          <span class="text-gray-500 block text-xs mb-1">Stressfrei</span>
          <strong class="text-lg">${scores.stressfree_score !== null ? scores.stressfree_score + '%' : '-'}</strong>
        </div>
      </div>
      ${scores.scored_at ? `<div class="mt-3 text-sm text-gray-600 flex items-center gap-2"><span class="text-green-600">‚úì</span> Von KI √ºberpr√ºft am <strong>${scoredAtFormatted}</strong> (${scoredAtRel})</div>` : ''}
      ${confidence !== null ? `<div class="mt-3 text-sm text-gray-600 flex items-center gap-2"><span class="text-primary-500">üéØ</span> AI-Konfidenz (Scores): <strong>${confidence}%</strong></div>` : ''}
      ${Object.keys(event.field_provenance || {}).length ? `<div class="mt-3 text-xs text-gray-500">Provenance: ${Object.entries(event.field_provenance).map(([k, v]) => k + ': ' + v).join(', ')}</div>` : ''}
      ${event.review_reason_label && event.status === 'pending_review' ? `<div class="mt-3 text-sm bg-amber-50 border border-amber-100 p-3 rounded-lg"><span class="text-amber-600 font-medium">üìã Review-Grund:</span> ${event.review_reason_label}</div>` : ''}
      ${event.rejection_label && event.status === 'rejected' ? `<div class="mt-3 text-sm bg-red-50 border border-red-100 p-3 rounded-lg"><span class="text-red-600 font-medium">‚ùå Ablehnungsgrund:</span> ${event.rejection_label}</div>` : ''}
    ` : '<p class="text-sm text-gray-500">Keine AI-Scores verf√ºgbar</p>';

    document.getElementById('detail-source').innerHTML = event.primary_source?.source ? `
      <div class="flex items-center justify-between">
        <div>
          <p class="font-medium text-gray-900">${event.primary_source.source.name}</p>
          <p class="text-sm text-gray-500">${event.primary_source.source.type}</p>
        </div>
        ${event.primary_source.source_url ? `
          <a href="${event.primary_source.source_url}" target="_blank" class="px-3 py-1.5 bg-primary-50 text-primary-600 rounded-lg text-sm hover:bg-primary-100 transition-colors">
            Quelle √∂ffnen ‚Üí
          </a>
        ` : ''}
      </div>
    ` : '<p class="text-sm text-gray-500">Keine Quellinformation</p>';

    // Load and show raw/import data
    loadAndShowRawData(id);

    // Show/hide action buttons based on status
    const showActions = ['pending_review', 'pending_ai', 'incomplete'].includes(event.status);
    document.getElementById('detail-approve').style.display = showActions ? 'flex' : 'none';
    document.getElementById('detail-edit').style.display = showActions ? 'flex' : 'none';
    document.getElementById('detail-reject').style.display = showActions ? 'flex' : 'none';

    document.getElementById('detail-modal').classList.remove('hidden');
    document.getElementById('detail-modal').classList.add('flex');
  }

  // Edit Modal
  function openEditModal(id) {
    currentEventId = id;
    const event = events.find(e => e.id === id) || allEvents.find(e => e.id === id);
    if (!event) return;

    document.getElementById('edit-title').value = event.title || '';
    document.getElementById('edit-address').value = event.location_address || '';
    
    if (event.start_datetime) {
      document.getElementById('edit-start').value = new Date(event.start_datetime).toISOString().slice(0, 16);
    } else {
      document.getElementById('edit-start').value = '';
    }
    if (event.end_datetime) {
      document.getElementById('edit-end').value = new Date(event.end_datetime).toISOString().slice(0, 16);
    } else {
      document.getElementById('edit-end').value = '';
    }

    const lockedFields = event.locked_fields || [];
    document.getElementById('lock-title').checked = lockedFields.includes('title');
    document.getElementById('lock-start').checked = lockedFields.includes('start_datetime');
    document.getElementById('lock-end').checked = lockedFields.includes('end_datetime');
    document.getElementById('lock-address').checked = lockedFields.includes('location_address');

    closeDetailModal();
    document.getElementById('edit-modal').classList.remove('hidden');
    document.getElementById('edit-modal').classList.add('flex');
  }

  // Reject Modal
  function openRejectModal(id) {
    currentEventId = id;
    document.getElementById('reject-reason-code').value = '';
    document.getElementById('reject-reason-text').value = '';
    closeDetailModal();
    document.getElementById('reject-modal').classList.remove('hidden');
    document.getElementById('reject-modal').classList.add('flex');
  }

  // Close modals
  function closeDetailModal() {
    document.getElementById('detail-modal').classList.add('hidden');
    document.getElementById('detail-modal').classList.remove('flex');
  }
  function closeEditModal() {
    document.getElementById('edit-modal').classList.add('hidden');
    document.getElementById('edit-modal').classList.remove('flex');
  }
  function closeRejectModal() {
    document.getElementById('reject-modal').classList.add('hidden');
    document.getElementById('reject-modal').classList.remove('flex');
  }

  // Delete Modal
  function openDeleteModal(id) {
    currentEventId = id;
    const event = events.find(e => e.id === id) || allEvents.find(e => e.id === id);
    if (!event) return;

    document.getElementById('delete-event-title').textContent = event.title || 'Unbekanntes Event';
    closeDetailModal();
    document.getElementById('delete-modal').classList.remove('hidden');
    document.getElementById('delete-modal').classList.add('flex');
  }

  function closeDeleteModal() {
    document.getElementById('delete-modal').classList.add('hidden');
    document.getElementById('delete-modal').classList.remove('flex');
  }

  async function handleDelete() {
    const btn = document.getElementById('delete-confirm');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> Wird gel√∂scht...';

    try {
      const res = await apiFetch(`/api/admin/events/${currentEventId}`, { method: 'DELETE' });
      if (res.success) {
        allEvents = allEvents.filter(e => e.id !== currentEventId);
        filterAndRenderEvents();
        closeDeleteModal();
        loadStatusCounts();
      } else {
        throw new Error(res.message || 'L√∂schen fehlgeschlagen');
      }
    } catch (e) {
      alert('Fehler beim L√∂schen: ' + e.message);
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalHTML;
    }
  }

  // Action handlers
  async function handleApprove(id, btn) {
    if (!confirm('Event wirklich genehmigen?')) return;
    
    const originalHTML = btn?.innerHTML;
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = '<div class="w-4 h-4 border-2 border-green-600 border-t-transparent rounded-full animate-spin"></div>';
    }

    try {
      await apiFetch(`/api/admin/review/${id}/approve`, { method: 'POST' });
      allEvents = allEvents.filter(e => e.id !== id);
      filterAndRenderEvents();
      closeDetailModal();
      loadStatusCounts();
    } catch (e) {
      alert('Fehler: ' + e.message);
    } finally {
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
      }
    }
  }

  async function handleReject() {
    const reasonCode = document.getElementById('reject-reason-code').value;
    const reasonText = document.getElementById('reject-reason-text').value;
    
    if (!reasonCode) {
      alert('Bitte w√§hle einen Grund');
      return;
    }

    const btn = document.getElementById('reject-confirm');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Wird abgelehnt...';

    try {
      await apiFetch(`/api/admin/review/${currentEventId}/reject`, {
        method: 'POST',
        body: JSON.stringify({ reason_code: reasonCode, reason: reasonText }),
      });
      allEvents = allEvents.filter(e => e.id !== currentEventId);
      filterAndRenderEvents();
      closeRejectModal();
      loadStatusCounts();
    } catch (e) {
      alert('Fehler: ' + e.message);
    } finally {
      btn.disabled = false;
      btn.textContent = originalText;
    }
  }

  async function handleQuickEdit() {
    const lockedFields = [];
    if (document.getElementById('lock-title').checked) lockedFields.push('title');
    if (document.getElementById('lock-start').checked) lockedFields.push('start_datetime');
    if (document.getElementById('lock-end').checked) lockedFields.push('end_datetime');
    if (document.getElementById('lock-address').checked) lockedFields.push('location_address');

    const btn = document.getElementById('edit-confirm');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Wird gespeichert...';

    try {
      await apiFetch(`/api/admin/review/${currentEventId}/quick-edit`, {
        method: 'POST',
        body: JSON.stringify({
          title: document.getElementById('edit-title').value,
          start_datetime: document.getElementById('edit-start').value,
          end_datetime: document.getElementById('edit-end').value || undefined,
          location_address: document.getElementById('edit-address').value,
          locked_fields: lockedFields,
        }),
      });
      allEvents = allEvents.filter(e => e.id !== currentEventId);
      filterAndRenderEvents();
      closeEditModal();
      loadStatusCounts();
    } catch (e) {
      alert('Fehler: ' + e.message);
    } finally {
      btn.disabled = false;
      btn.textContent = originalText;
    }
  }

  // Mobile filter sidebar
  function openMobileFilter() {
    const overlay = document.getElementById('mobile-filter-overlay');
    const panel = document.getElementById('mobile-filter-panel');
    overlay.classList.remove('hidden');
    setTimeout(() => {
      panel.style.transform = 'translateX(0)';
    }, 10);
  }

  function closeMobileFilter() {
    const overlay = document.getElementById('mobile-filter-overlay');
    const panel = document.getElementById('mobile-filter-panel');
    panel.style.transform = 'translateX(-100%)';
    setTimeout(() => {
      overlay.classList.add('hidden');
    }, 300);
  }

  // Clone desktop filters to mobile
  function setupMobileFilters() {
    const desktopSidebar = document.getElementById('filter-sidebar');
    const mobileContent = document.getElementById('mobile-filter-content');
    
    if (desktopSidebar && mobileContent) {
      // Clone the inner content
      const content = desktopSidebar.querySelector('.bg-white');
      if (content) {
        mobileContent.innerHTML = content.innerHTML;
        
        // Update IDs to avoid conflicts and sync state
        const mobileRadios = mobileContent.querySelectorAll('.status-radio');
        mobileRadios.forEach(radio => {
          radio.name = 'status-mobile';
          radio.addEventListener('change', () => {
            filters.status = radio.value;
            // Sync with desktop
            document.querySelectorAll('.status-radio').forEach(r => {
              r.checked = r.value === filters.status;
            });
            loadEvents();
            closeMobileFilter();
          });
        });
        
        // Source filter
        const mobileSourceFilter = mobileContent.querySelector('#source-filter');
        if (mobileSourceFilter) {
          mobileSourceFilter.id = 'source-filter-mobile';
          mobileSourceFilter.addEventListener('change', () => {
            filters.source = mobileSourceFilter.value;
            document.getElementById('source-filter').value = filters.source;
            loadEvents();
          });
        }
        
        // Score filter
        const mobileScoreFilter = mobileContent.querySelector('#score-filter');
        if (mobileScoreFilter) {
          mobileScoreFilter.id = 'score-filter-mobile';
          const mobileScoreValue = mobileContent.querySelector('#score-value');
          if (mobileScoreValue) mobileScoreValue.id = 'score-value-mobile';
          
          mobileScoreFilter.addEventListener('input', () => {
            filters.minScore = parseInt(mobileScoreFilter.value);
            document.getElementById('score-filter').value = mobileScoreFilter.value;
            document.getElementById('score-value').textContent = filters.minScore + '+';
            if (mobileScoreValue) mobileScoreValue.textContent = filters.minScore + '+';
            filterAndRenderEvents();
          });
        }
        
        // Clear filters button
        const mobileClearBtn = mobileContent.querySelector('#clear-filters');
        if (mobileClearBtn) {
          mobileClearBtn.id = 'clear-filters-mobile';
          mobileClearBtn.addEventListener('click', () => {
            clearFilters();
            closeMobileFilter();
          });
        }
      }
    }
  }

  // Clear all filters
  function clearFilters() {
    filters = {
      status: 'pending_review',
      source: '',
      minScore: 0,
      search: '',
      sort: 'date_desc'
    };
    
    // Update UI
    document.querySelectorAll('.status-radio').forEach(r => {
      r.checked = r.value === 'pending_review';
    });
    document.getElementById('source-filter').value = '';
    document.getElementById('score-filter').value = '0';
    document.getElementById('score-value').textContent = '0+';
    document.getElementById('search-input').value = '';
    document.getElementById('sort-select').value = 'date_desc';
    
    // Update mobile too
    const mobileSource = document.getElementById('source-filter-mobile');
    const mobileScore = document.getElementById('score-filter-mobile');
    const mobileScoreValue = document.getElementById('score-value-mobile');
    if (mobileSource) mobileSource.value = '';
    if (mobileScore) mobileScore.value = '0';
    if (mobileScoreValue) mobileScoreValue.textContent = '0+';
    
    loadEvents();
  }

  // Debounce helper
  function debounce(fn, delay) {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn(...args), delay);
    };
  }

  // Event listeners
  document.querySelectorAll('.status-radio').forEach(radio => {
    radio.addEventListener('change', () => {
      filters.status = radio.value;
      loadEvents();
    });
  });

  document.getElementById('source-filter').addEventListener('change', (e) => {
    filters.source = e.target.value;
    loadEvents();
  });

  document.getElementById('score-filter').addEventListener('input', (e) => {
    filters.minScore = parseInt(e.target.value);
    document.getElementById('score-value').textContent = filters.minScore + '+';
    filterAndRenderEvents();
  });

  document.getElementById('search-input').addEventListener('input', debounce((e) => {
    filters.search = e.target.value;
    filterAndRenderEvents();
  }, 300));

  document.getElementById('sort-select').addEventListener('change', (e) => {
    filters.sort = e.target.value;
    filterAndRenderEvents();
  });

  document.getElementById('refresh-btn').addEventListener('click', () => loadEvents());
  document.getElementById('clear-filters').addEventListener('click', clearFilters);
  
  document.getElementById('load-more-btn').addEventListener('click', () => {
    currentPage++;
    loadEvents(true);
  });

  // Mobile filter controls
  document.getElementById('mobile-filter-btn').addEventListener('click', openMobileFilter);
  document.getElementById('close-mobile-filter').addEventListener('click', closeMobileFilter);
  document.getElementById('mobile-filter-overlay').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closeMobileFilter();
  });

  // Modal event listeners
  document.getElementById('detail-close').addEventListener('click', closeDetailModal);
  document.getElementById('detail-approve').addEventListener('click', () => handleApprove(currentEventId));
  document.getElementById('detail-edit').addEventListener('click', () => openEditModal(currentEventId));
  document.getElementById('detail-reject').addEventListener('click', () => openRejectModal(currentEventId));
  document.getElementById('detail-delete').addEventListener('click', () => openDeleteModal(currentEventId));

  document.getElementById('reject-cancel').addEventListener('click', closeRejectModal);
  document.getElementById('reject-confirm').addEventListener('click', handleReject);

  document.getElementById('edit-cancel').addEventListener('click', closeEditModal);
  document.getElementById('edit-confirm').addEventListener('click', handleQuickEdit);

  document.getElementById('delete-cancel').addEventListener('click', closeDeleteModal);
  document.getElementById('delete-confirm').addEventListener('click', handleDelete);

  // Close modals on backdrop click
  ['detail-modal', 'reject-modal', 'edit-modal', 'delete-modal'].forEach(id => {
    document.getElementById(id).addEventListener('click', (e) => {
      if (e.target.id === id) {
        document.getElementById(id).classList.add('hidden');
        document.getElementById(id).classList.remove('flex');
      }
    });
  });

  // Modal close buttons
  document.querySelectorAll('.modal-close').forEach(btn => {
    btn.addEventListener('click', () => {
      btn.closest('[id$="-modal"]').classList.add('hidden');
      btn.closest('[id$="-modal"]').classList.remove('flex');
    });
  });

  // Escape key to close modals
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeDetailModal();
      closeEditModal();
      closeRejectModal();
      closeDeleteModal();
      closeMobileFilter();
    }
  });

  // Initial load
  const urlParams = new URLSearchParams(window.location.search);
  const urlStatus = urlParams.get('status');
  const urlSearch = urlParams.get('search');

  if (urlStatus && ['pending_review', 'pending_ai', 'incomplete', 'published', 'rejected', 'archived', 'all'].includes(urlStatus)) {
    filters.status = urlStatus;
    document.querySelectorAll('.status-radio').forEach(r => {
      r.checked = r.value === urlStatus;
    });
  }

  if (urlSearch) {
    filters.search = urlSearch;
    document.getElementById('search-input').value = urlSearch;
  }

  // Initialize
  setupMobileFilters();
  loadSources();
  loadStatusCounts();
  loadEvents();
</script>
</AdminLayout>