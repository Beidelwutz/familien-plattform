---
import BaseLayout from '../../layouts/BaseLayout.astro';
import StickyHeader from '../../components/layout/StickyHeader.astro';

const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:4000';
---

<BaseLayout title="Review Queue - Admin - kiezling">
  <StickyHeader />
  <main class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <header class="mb-6">
        <a href="/admin" class="text-sm text-primary-500 hover:text-primary-600 font-medium mb-2 inline-block">&larr; Zur√ºck zum Dashboard</a>
        <h1 class="text-2xl font-bold text-gray-900">Review Queue</h1>
        <p class="text-gray-500">Events mit niedriger Konfidenz zur manuellen Pr√ºfung</p>
      </header>

      <!-- Filters -->
      <div class="flex flex-wrap gap-3 mb-6">
        <select id="status-filter" class="px-4 py-2 border-2 border-gray-200 rounded-lg bg-white text-sm">
          <option value="pending_review">Ausstehend</option>
          <option value="pending_ai">Warte auf AI</option>
          <option value="incomplete">Unvollst√§ndig</option>
          <option value="published">Ver√∂ffentlicht</option>
          <option value="all">Alle (nicht ver√∂ffentlicht)</option>
        </select>
        <button class="px-4 py-2 bg-white border-2 border-gray-200 rounded-lg text-sm hover:bg-gray-50" id="refresh-btn">
          üîÑ Aktualisieren
        </button>
        <span id="event-count" class="ml-auto text-sm text-gray-500 self-center"></span>
      </div>

      <!-- Loading State -->
      <div id="loading-state" class="text-center py-12">
        <div class="animate-spin inline-block w-8 h-8 border-4 border-primary-500 border-t-transparent rounded-full"></div>
        <p class="text-gray-500 mt-4">Lade Events...</p>
      </div>

      <!-- Review List -->
      <div class="hidden space-y-4" id="review-list"></div>

      <!-- Empty State -->
      <div id="empty-state" class="hidden text-center py-12">
        <p class="text-gray-500 text-lg">Keine Events zur Pr√ºfung</p>
      </div>

      <!-- Reject Modal -->
      <div class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4" id="reject-modal">
        <div class="bg-white rounded-2xl max-w-md w-full p-6">
          <h3 class="text-lg font-semibold mb-4">Event ablehnen</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Grund</label>
              <select id="reject-reason-code" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <option value="">-- Bitte w√§hlen --</option>
                <option value="spam">Spam / Werbung</option>
                <option value="incomplete">Unvollst√§ndig</option>
                <option value="wrong_date">Falsches Datum</option>
                <option value="duplicate">Duplikat</option>
                <option value="not_relevant">Nicht relevant</option>
                <option value="other">Sonstiges</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Kommentar (optional)</label>
              <textarea id="reject-reason-text" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Zus√§tzliche Details..."></textarea>
            </div>
          </div>
          <div class="flex gap-3 mt-6">
            <button id="reject-cancel" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Abbrechen</button>
            <button id="reject-confirm" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Ablehnen</button>
          </div>
        </div>
      </div>

      <!-- Quick Edit Modal -->
      <div class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4" id="edit-modal">
        <div class="bg-white rounded-2xl max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto">
          <h3 class="text-lg font-semibold mb-4">Event bearbeiten & genehmigen</h3>
          <div class="space-y-4">
            <div>
              <div class="flex items-center justify-between mb-1">
                <label class="text-sm font-medium text-gray-700">Titel</label>
                <label class="flex items-center gap-1 text-xs text-gray-500">
                  <input type="checkbox" id="lock-title" class="lock-checkbox"> Sperren
                </label>
              </div>
              <input type="text" id="edit-title" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <div class="flex items-center justify-between mb-1">
                <label class="text-sm font-medium text-gray-700">Startdatum</label>
                <label class="flex items-center gap-1 text-xs text-gray-500">
                  <input type="checkbox" id="lock-start" class="lock-checkbox"> Sperren
                </label>
              </div>
              <input type="datetime-local" id="edit-start" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <div class="flex items-center justify-between mb-1">
                <label class="text-sm font-medium text-gray-700">Enddatum</label>
                <label class="flex items-center gap-1 text-xs text-gray-500">
                  <input type="checkbox" id="lock-end" class="lock-checkbox"> Sperren
                </label>
              </div>
              <input type="datetime-local" id="edit-end" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <div class="flex items-center justify-between mb-1">
                <label class="text-sm font-medium text-gray-700">Adresse</label>
                <label class="flex items-center gap-1 text-xs text-gray-500">
                  <input type="checkbox" id="lock-address" class="lock-checkbox"> Sperren
                </label>
              </div>
              <input type="text" id="edit-address" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-4">Gesperrte Felder werden nicht durch automatische Updates √ºberschrieben.</p>
          <div class="flex gap-3 mt-6">
            <button id="edit-cancel" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Abbrechen</button>
            <button id="edit-confirm" class="flex-1 px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600">Speichern & Genehmigen</button>
          </div>
        </div>
      </div>

      <!-- Detail Modal -->
      <div class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4" id="detail-modal">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div class="p-6 border-b border-gray-200">
            <div class="flex items-start justify-between">
              <h2 id="detail-title" class="text-xl font-semibold pr-8">Event Details</h2>
              <button id="detail-close" class="text-2xl text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="detail-badges" class="flex flex-wrap gap-2 mt-2"></div>
          </div>
          <div class="p-6 space-y-6">
            <div>
              <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Details</h3>
              <div id="detail-info" class="grid grid-cols-2 gap-3"></div>
            </div>
            <div>
              <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">AI-Scores</h3>
              <div id="detail-scores" class="bg-gray-50 rounded-lg p-4"></div>
            </div>
            <div>
              <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Quelle</h3>
              <div id="detail-source" class="bg-gray-50 rounded-lg p-4"></div>
            </div>
          </div>
          <div class="p-6 border-t border-gray-200 flex gap-3 justify-end">
            <button id="detail-approve" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">‚úì Genehmigen</button>
            <button id="detail-edit" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">‚úèÔ∏è Bearbeiten</button>
            <button id="detail-reject" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">‚úó Ablehnen</button>
          </div>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<script define:vars={{ API_URL }}>
  let events = [];
  let currentEventId = null;
  const token = localStorage.getItem('auth_token');

  // Auth check
  if (!token) {
    window.location.href = '/login?redirect=/admin/review';
  }

  // Fetch helper
  async function apiFetch(endpoint, options = {}) {
    const res = await fetch(`${API_URL}${endpoint}`, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
        ...options.headers,
      },
    });
    if (res.status === 401 || res.status === 403) {
      localStorage.removeItem('auth_token');
      window.location.href = '/login?redirect=/admin/review';
      throw new Error('Unauthorized');
    }
    return res.json();
  }

  // Load events
  async function loadEvents() {
    const status = document.getElementById('status-filter').value;
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('review-list').classList.add('hidden');
    document.getElementById('empty-state').classList.add('hidden');

    try {
      const data = await apiFetch(`/api/admin/review-queue?status=${status}&limit=50`);
      events = data.data || [];
      
      document.getElementById('event-count').textContent = `${events.length} Events`;
      
      if (events.length === 0) {
        document.getElementById('empty-state').classList.remove('hidden');
      } else {
        renderEvents();
        document.getElementById('review-list').classList.remove('hidden');
      }
    } catch (e) {
      console.error('Load error:', e);
      document.getElementById('empty-state').classList.remove('hidden');
      document.getElementById('empty-state').innerHTML = '<p class="text-red-500">Fehler beim Laden</p>';
    } finally {
      document.getElementById('loading-state').classList.add('hidden');
    }
  }

  // Render event list
  function renderEvents() {
    const list = document.getElementById('review-list');
    list.innerHTML = events.map(event => {
      const date = new Date(event.start_datetime).toLocaleDateString('de-DE', { 
        day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' 
      });
      const sourceName = event.primary_source?.source?.name || 'Unbekannt';
      const score = event.completeness_score || 0;
      
      return `
        <div class="bg-white rounded-xl p-4 border border-gray-100 hover:shadow-md transition-shadow cursor-pointer" data-id="${event.id}">
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1 min-w-0">
              <h3 class="font-semibold text-gray-900 truncate">${event.title}</h3>
              <div class="flex flex-wrap gap-3 text-sm text-gray-500 mt-1">
                <span>üìÖ ${date}</span>
                <span>üì° ${sourceName}</span>
                ${event.location_address ? `<span class="truncate max-w-[200px]">üìç ${event.location_address}</span>` : ''}
              </div>
              <div class="flex flex-wrap gap-2 mt-2">
                <span class="px-2 py-0.5 text-xs rounded-full ${score < 50 ? 'bg-red-100 text-red-700' : score < 80 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}">
                  Vollst√§ndigkeit: ${score}%
                </span>
                <span class="px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-600">${event.status}</span>
              </div>
            </div>
            <div class="flex gap-2 shrink-0">
              <button class="action-btn w-10 h-10 rounded-lg bg-green-100 text-green-600 hover:bg-green-200" data-action="approve" data-id="${event.id}" title="Genehmigen">‚úì</button>
              <button class="action-btn w-10 h-10 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200" data-action="edit" data-id="${event.id}" title="Bearbeiten">‚úèÔ∏è</button>
              <button class="action-btn w-10 h-10 rounded-lg bg-red-100 text-red-600 hover:bg-red-200" data-action="reject" data-id="${event.id}" title="Ablehnen">‚úó</button>
            </div>
          </div>
        </div>
      `;
    }).join('');

    // Event handlers
    list.querySelectorAll('[data-id]').forEach(el => {
      el.addEventListener('click', (e) => {
        if (!e.target.closest('.action-btn')) {
          openDetailModal(el.dataset.id);
        }
      });
    });

    list.querySelectorAll('.action-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const action = btn.dataset.action;
        const id = btn.dataset.id;
        if (action === 'approve') handleApprove(id, btn);
        else if (action === 'edit') openEditModal(id);
        else if (action === 'reject') openRejectModal(id);
      });
    });
  }

  // Detail Modal
  function openDetailModal(id) {
    currentEventId = id;
    const event = events.find(e => e.id === id);
    if (!event) return;

    document.getElementById('detail-title').textContent = event.title;
    
    document.getElementById('detail-badges').innerHTML = `
      <span class="px-2 py-1 text-xs rounded-full bg-gray-100">${event.status}</span>
      ${event.completeness_score ? `<span class="px-2 py-1 text-xs rounded-full ${event.completeness_score < 50 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">Vollst√§ndigkeit: ${event.completeness_score}%</span>` : ''}
    `;

    const formatDate = (d) => d ? new Date(d).toLocaleString('de-DE') : '-';
    document.getElementById('detail-info').innerHTML = `
      <div class="bg-gray-50 p-3 rounded-lg"><span class="text-xs text-gray-500 block">Start</span><span class="font-medium">${formatDate(event.start_datetime)}</span></div>
      <div class="bg-gray-50 p-3 rounded-lg"><span class="text-xs text-gray-500 block">Ende</span><span class="font-medium">${formatDate(event.end_datetime)}</span></div>
      <div class="bg-gray-50 p-3 rounded-lg col-span-2"><span class="text-xs text-gray-500 block">Adresse</span><span class="font-medium">${event.location_address || '-'}</span></div>
      <div class="bg-gray-50 p-3 rounded-lg"><span class="text-xs text-gray-500 block">Preis</span><span class="font-medium">${event.price_type || '-'}</span></div>
      <div class="bg-gray-50 p-3 rounded-lg"><span class="text-xs text-gray-500 block">Alter</span><span class="font-medium">${event.age_min || '?'} - ${event.age_max || '?'} Jahre</span></div>
    `;

    const scores = event.scores;
    document.getElementById('detail-scores').innerHTML = scores ? `
      <div class="grid grid-cols-2 gap-2 text-sm">
        <div>Relevanz: <strong>${scores.relevance_score || '-'}</strong></div>
        <div>Qualit√§t: <strong>${scores.quality_score || '-'}</strong></div>
        <div>Family Fit: <strong>${scores.family_fit_score || '-'}</strong></div>
        <div>Stressfrei: <strong>${scores.stressfree_score || '-'}</strong></div>
      </div>
    ` : '<p class="text-sm text-gray-500">Keine Scores verf√ºgbar</p>';

    document.getElementById('detail-source').innerHTML = event.primary_source?.source ? `
      <p><strong>${event.primary_source.source.name}</strong> (${event.primary_source.source.type})</p>
      ${event.primary_source.source_url ? `<a href="${event.primary_source.source_url}" target="_blank" class="text-primary-500 text-sm">Quelle √∂ffnen ‚Üí</a>` : ''}
    ` : '<p class="text-sm text-gray-500">Keine Quellinformation</p>';

    document.getElementById('detail-modal').classList.remove('hidden');
    document.getElementById('detail-modal').classList.add('flex');
  }

  // Edit Modal
  function openEditModal(id) {
    currentEventId = id;
    const event = events.find(e => e.id === id);
    if (!event) return;

    document.getElementById('edit-title').value = event.title || '';
    document.getElementById('edit-address').value = event.location_address || '';
    
    if (event.start_datetime) {
      document.getElementById('edit-start').value = new Date(event.start_datetime).toISOString().slice(0, 16);
    }
    if (event.end_datetime) {
      document.getElementById('edit-end').value = new Date(event.end_datetime).toISOString().slice(0, 16);
    }

    // Reset lock checkboxes
    const lockedFields = event.locked_fields || [];
    document.getElementById('lock-title').checked = lockedFields.includes('title');
    document.getElementById('lock-start').checked = lockedFields.includes('start_datetime');
    document.getElementById('lock-end').checked = lockedFields.includes('end_datetime');
    document.getElementById('lock-address').checked = lockedFields.includes('location_address');

    closeDetailModal();
    document.getElementById('edit-modal').classList.remove('hidden');
    document.getElementById('edit-modal').classList.add('flex');
  }

  // Reject Modal
  function openRejectModal(id) {
    currentEventId = id;
    document.getElementById('reject-reason-code').value = '';
    document.getElementById('reject-reason-text').value = '';
    closeDetailModal();
    document.getElementById('reject-modal').classList.remove('hidden');
    document.getElementById('reject-modal').classList.add('flex');
  }

  // Close modals
  function closeDetailModal() {
    document.getElementById('detail-modal').classList.add('hidden');
    document.getElementById('detail-modal').classList.remove('flex');
  }
  function closeEditModal() {
    document.getElementById('edit-modal').classList.add('hidden');
    document.getElementById('edit-modal').classList.remove('flex');
  }
  function closeRejectModal() {
    document.getElementById('reject-modal').classList.add('hidden');
    document.getElementById('reject-modal').classList.remove('flex');
  }

  // Action handlers
  async function handleApprove(id, btn) {
    if (!confirm('Event wirklich genehmigen?')) return;
    
    const originalText = btn?.innerHTML;
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = '...';
    }

    try {
      await apiFetch(`/api/admin/review/${id}/approve`, { method: 'POST' });
      events = events.filter(e => e.id !== id);
      renderEvents();
      closeDetailModal();
    } catch (e) {
      alert('Fehler: ' + e.message);
    } finally {
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }
  }

  async function handleReject() {
    const reasonCode = document.getElementById('reject-reason-code').value;
    const reasonText = document.getElementById('reject-reason-text').value;
    
    if (!reasonCode) {
      alert('Bitte w√§hle einen Grund');
      return;
    }

    const btn = document.getElementById('reject-confirm');
    btn.disabled = true;
    btn.textContent = 'Wird abgelehnt...';

    try {
      await apiFetch(`/api/admin/review/${currentEventId}/reject`, {
        method: 'POST',
        body: JSON.stringify({ reason_code: reasonCode, reason: reasonText }),
      });
      events = events.filter(e => e.id !== currentEventId);
      renderEvents();
      closeRejectModal();
    } catch (e) {
      alert('Fehler: ' + e.message);
    } finally {
      btn.disabled = false;
      btn.textContent = 'Ablehnen';
    }
  }

  async function handleQuickEdit() {
    const lockedFields = [];
    if (document.getElementById('lock-title').checked) lockedFields.push('title');
    if (document.getElementById('lock-start').checked) lockedFields.push('start_datetime');
    if (document.getElementById('lock-end').checked) lockedFields.push('end_datetime');
    if (document.getElementById('lock-address').checked) lockedFields.push('location_address');

    const btn = document.getElementById('edit-confirm');
    btn.disabled = true;
    btn.textContent = 'Wird gespeichert...';

    try {
      await apiFetch(`/api/admin/review/${currentEventId}/quick-edit`, {
        method: 'POST',
        body: JSON.stringify({
          title: document.getElementById('edit-title').value,
          start_datetime: document.getElementById('edit-start').value,
          end_datetime: document.getElementById('edit-end').value || undefined,
          location_address: document.getElementById('edit-address').value,
          locked_fields: lockedFields,
        }),
      });
      events = events.filter(e => e.id !== currentEventId);
      renderEvents();
      closeEditModal();
    } catch (e) {
      alert('Fehler: ' + e.message);
    } finally {
      btn.disabled = false;
      btn.textContent = 'Speichern & Genehmigen';
    }
  }

  // Event listeners
  document.getElementById('status-filter').addEventListener('change', loadEvents);
  document.getElementById('refresh-btn').addEventListener('click', loadEvents);
  
  document.getElementById('detail-close').addEventListener('click', closeDetailModal);
  document.getElementById('detail-approve').addEventListener('click', () => handleApprove(currentEventId));
  document.getElementById('detail-edit').addEventListener('click', () => openEditModal(currentEventId));
  document.getElementById('detail-reject').addEventListener('click', () => openRejectModal(currentEventId));

  document.getElementById('reject-cancel').addEventListener('click', closeRejectModal);
  document.getElementById('reject-confirm').addEventListener('click', handleReject);

  document.getElementById('edit-cancel').addEventListener('click', closeEditModal);
  document.getElementById('edit-confirm').addEventListener('click', handleQuickEdit);

  // Close modals on backdrop click
  ['detail-modal', 'reject-modal', 'edit-modal'].forEach(id => {
    document.getElementById(id).addEventListener('click', (e) => {
      if (e.target.id === id) {
        document.getElementById(id).classList.add('hidden');
        document.getElementById(id).classList.remove('flex');
      }
    });
  });

  // Initial load: set filter from URL if present
  const urlStatus = new URLSearchParams(window.location.search).get('status');
  const statusSelect = document.getElementById('status-filter');
  if (urlStatus && statusSelect && ['pending_review', 'pending_ai', 'incomplete', 'published', 'all'].includes(urlStatus)) {
    statusSelect.value = urlStatus;
  }
  loadEvents();
</script>
