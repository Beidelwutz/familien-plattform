---
import BaseLayout from '../../layouts/BaseLayout.astro';
import StickyHeader from '../../components/layout/StickyHeader.astro';

const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:4000';
---

<BaseLayout title="Quellen-Status - Admin - familienlokal">
  <StickyHeader />
  <main class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <header class="mb-6">
        <a href="/admin" class="text-sm text-primary-500 hover:text-primary-600 font-medium mb-2 inline-block">&larr; Zur√ºck zum Dashboard</a>
        <h1 class="text-2xl font-bold text-gray-900">Quellen-Status</h1>
        <p class="text-gray-500">√úbersicht und Gesundheit aller Datenquellen</p>
      </header>

      <!-- Summary Cards -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
        <div class="bg-white rounded-xl p-4 border-l-4 border-green-500">
          <span id="healthy-count" class="block text-2xl font-bold text-green-600">--</span>
          <span class="text-sm text-gray-500">Gesund</span>
        </div>
        <div class="bg-white rounded-xl p-4 border-l-4 border-yellow-500">
          <span id="degraded-count" class="block text-2xl font-bold text-yellow-600">--</span>
          <span class="text-sm text-gray-500">Eingeschr√§nkt</span>
        </div>
        <div class="bg-white rounded-xl p-4 border-l-4 border-orange-500">
          <span id="failing-count" class="block text-2xl font-bold text-orange-600">--</span>
          <span class="text-sm text-gray-500">Fehlerhaft</span>
        </div>
        <div class="bg-white rounded-xl p-4 border-l-4 border-red-500">
          <span id="dead-count" class="block text-2xl font-bold text-red-600">--</span>
          <span class="text-sm text-gray-500">Tot</span>
        </div>
        <div class="bg-white rounded-xl p-4 border-l-4 border-gray-400">
          <span id="unknown-count" class="block text-2xl font-bold text-gray-500">--</span>
          <span class="text-sm text-gray-500">Unbekannt</span>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loading-state" class="text-center py-12">
        <div class="animate-spin inline-block w-8 h-8 border-4 border-primary-500 border-t-transparent rounded-full"></div>
        <p class="text-gray-500 mt-4">Lade Quellen...</p>
      </div>

      <!-- Source Table -->
      <div class="bg-white rounded-xl shadow-sm overflow-hidden hidden" id="source-table">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quelle</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Typ</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Letzter Erfolg</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Events/Fetch</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fehler</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aktionen</th>
              </tr>
            </thead>
            <tbody id="source-tbody" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>

      <!-- Detail Panel (Slide-over) -->
      <div class="fixed inset-0 bg-black/50 hidden z-50" id="detail-overlay">
        <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-xl flex flex-col">
          <div class="p-4 border-b flex items-center justify-between">
            <h2 id="panel-title" class="text-lg font-semibold">Quelle</h2>
            <button id="panel-close" class="text-2xl text-gray-400 hover:text-gray-600">&times;</button>
          </div>
          
          <div class="flex-1 overflow-y-auto p-4 space-y-6">
            <!-- Status & Info -->
            <div>
              <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Info</h3>
              <div id="panel-info" class="space-y-2"></div>
            </div>

            <!-- Error Info -->
            <div id="panel-error-section" class="hidden">
              <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Letzter Fehler</h3>
              <div id="panel-error" class="bg-red-50 border border-red-200 rounded-lg p-3 text-sm text-red-700"></div>
            </div>

            <!-- Recent Fetches -->
            <div>
              <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Letzte Fetches</h3>
              <div id="panel-fetches" class="space-y-2 text-sm text-gray-500">Keine Daten</div>
            </div>
          </div>

          <div class="p-4 border-t flex flex-wrap gap-2">
            <button id="trigger-btn" class="flex-1 px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600">
              üîÑ Jetzt abrufen
            </button>
            <button id="toggle-btn" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
              ‚è∏Ô∏è Deaktivieren
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<script define:vars={{ API_URL }}>
  let sources = [];
  let currentSourceId = null;
  const token = localStorage.getItem('auth_token');

  // Auth check
  if (!token) {
    window.location.href = '/login?redirect=/admin/sources';
  }

  // Fetch helper
  async function apiFetch(endpoint, options = {}) {
    const res = await fetch(`${API_URL}${endpoint}`, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
        ...options.headers,
      },
    });
    if (res.status === 401 || res.status === 403) {
      localStorage.removeItem('auth_token');
      window.location.href = '/login?redirect=/admin/sources';
      throw new Error('Unauthorized');
    }
    return res.json();
  }

  // Load sources
  async function loadSources() {
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('source-table').classList.add('hidden');

    try {
      const data = await apiFetch('/api/sources');
      sources = data.data || [];
      
      // Count by health status
      const counts = { healthy: 0, degraded: 0, failing: 0, dead: 0, unknown: 0 };
      sources.forEach(s => {
        const status = s.health_status || 'unknown';
        counts[status] = (counts[status] || 0) + 1;
      });

      document.getElementById('healthy-count').textContent = counts.healthy;
      document.getElementById('degraded-count').textContent = counts.degraded;
      document.getElementById('failing-count').textContent = counts.failing;
      document.getElementById('dead-count').textContent = counts.dead;
      document.getElementById('unknown-count').textContent = counts.unknown;

      renderTable();
      document.getElementById('source-table').classList.remove('hidden');
    } catch (e) {
      console.error('Load error:', e);
    } finally {
      document.getElementById('loading-state').classList.add('hidden');
    }
  }

  // Render table
  function renderTable() {
    const tbody = document.getElementById('source-tbody');
    tbody.innerHTML = sources.map(source => {
      const lastSuccess = source.last_success_at 
        ? new Date(source.last_success_at).toLocaleString('de-DE', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })
        : 'Nie';
      
      const statusColors = {
        healthy: 'bg-green-100 text-green-700',
        degraded: 'bg-yellow-100 text-yellow-700',
        failing: 'bg-orange-100 text-orange-700',
        dead: 'bg-red-100 text-red-700',
        unknown: 'bg-gray-100 text-gray-600',
      };
      const statusLabels = {
        healthy: 'Gesund',
        degraded: 'Eingeschr√§nkt',
        failing: 'Fehlerhaft',
        dead: 'Tot',
        unknown: 'Unbekannt',
      };
      const status = source.health_status || 'unknown';
      const isActive = source.is_active !== false;

      return `
        <tr class="hover:bg-gray-50 cursor-pointer ${!isActive ? 'opacity-50' : ''}" data-id="${source.id}">
          <td class="px-4 py-3">
            <span class="px-2 py-1 text-xs rounded-full ${statusColors[status]}">
              ${statusLabels[status]}
            </span>
            ${!isActive ? '<span class="ml-1 px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">Deaktiviert</span>' : ''}
          </td>
          <td class="px-4 py-3 font-medium">${source.name}</td>
          <td class="px-4 py-3">
            <span class="px-2 py-1 text-xs rounded bg-gray-100 uppercase">${source.type}</span>
          </td>
          <td class="px-4 py-3 text-sm text-gray-500">${lastSuccess}</td>
          <td class="px-4 py-3 text-sm">${source.avg_events_per_fetch?.toFixed(1) || '-'}</td>
          <td class="px-4 py-3">
            ${source.consecutive_failures > 0 
              ? `<span class="text-red-600 font-medium">${source.consecutive_failures}</span>` 
              : '<span class="text-gray-400">0</span>'
            }
          </td>
          <td class="px-4 py-3">
            <button class="trigger-btn px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm" data-id="${source.id}" ${!isActive ? 'disabled' : ''}>
              üîÑ
            </button>
          </td>
        </tr>
      `;
    }).join('');

    // Event handlers
    tbody.querySelectorAll('tr[data-id]').forEach(row => {
      row.addEventListener('click', (e) => {
        if (!e.target.closest('.trigger-btn')) {
          openPanel(row.dataset.id);
        }
      });
    });

    tbody.querySelectorAll('.trigger-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        triggerFetch(btn.dataset.id, btn);
      });
    });
  }

  // Open detail panel
  function openPanel(id) {
    currentSourceId = id;
    const source = sources.find(s => s.id === id);
    if (!source) return;

    document.getElementById('panel-title').textContent = source.name;
    
    const isActive = source.is_active !== false;
    document.getElementById('toggle-btn').textContent = isActive ? '‚è∏Ô∏è Deaktivieren' : '‚ñ∂Ô∏è Aktivieren';
    document.getElementById('toggle-btn').className = isActive 
      ? 'flex-1 px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50'
      : 'flex-1 px-4 py-2 border border-green-300 text-green-600 rounded-lg hover:bg-green-50';

    const formatDate = d => d ? new Date(d).toLocaleString('de-DE') : '-';
    document.getElementById('panel-info').innerHTML = `
      <div class="grid grid-cols-2 gap-2 text-sm">
        <div class="bg-gray-50 p-2 rounded"><span class="text-gray-500 block">Typ</span><strong>${source.type}</strong></div>
        <div class="bg-gray-50 p-2 rounded"><span class="text-gray-500 block">Status</span><strong>${source.health_status}</strong></div>
        <div class="bg-gray-50 p-2 rounded"><span class="text-gray-500 block">Aktiv</span><strong>${isActive ? 'Ja' : 'Nein'}</strong></div>
        <div class="bg-gray-50 p-2 rounded"><span class="text-gray-500 block">Priorit√§t</span><strong>${source.priority || '-'}</strong></div>
        <div class="bg-gray-50 p-2 rounded col-span-2"><span class="text-gray-500 block">Letzter Erfolg</span><strong>${formatDate(source.last_success_at)}</strong></div>
        <div class="bg-gray-50 p-2 rounded col-span-2"><span class="text-gray-500 block">Letzter Fehler</span><strong>${formatDate(source.last_failure_at)}</strong></div>
        ${source.url ? `<div class="bg-gray-50 p-2 rounded col-span-2"><span class="text-gray-500 block">URL</span><a href="${source.url}" target="_blank" class="text-primary-500 break-all">${source.url}</a></div>` : ''}
      </div>
    `;

    // Error section
    if (source.consecutive_failures > 0) {
      document.getElementById('panel-error-section').classList.remove('hidden');
      document.getElementById('panel-error').textContent = `${source.consecutive_failures} aufeinanderfolgende Fehler`;
    } else {
      document.getElementById('panel-error-section').classList.add('hidden');
    }

    document.getElementById('detail-overlay').classList.remove('hidden');
  }

  // Close panel
  function closePanel() {
    document.getElementById('detail-overlay').classList.add('hidden');
    currentSourceId = null;
  }

  // Trigger fetch
  async function triggerFetch(id, btn) {
    if (!confirm('Fetch jetzt starten?')) return;
    
    const originalText = btn?.innerHTML;
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = '...';
    }

    try {
      await apiFetch(`/api/sources/${id}/trigger`, { method: 'POST' });
      alert('Fetch gestartet');
      loadSources();
    } catch (e) {
      alert('Fehler: ' + e.message);
    } finally {
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }
  }

  // Toggle active status
  async function toggleActive() {
    const source = sources.find(s => s.id === currentSourceId);
    if (!source) return;

    const isActive = source.is_active !== false;
    const action = isActive ? 'deaktivieren' : 'aktivieren';
    if (!confirm(`Quelle wirklich ${action}?`)) return;

    const btn = document.getElementById('toggle-btn');
    btn.disabled = true;
    btn.textContent = 'Wird gespeichert...';

    try {
      await apiFetch(`/api/sources/${currentSourceId}`, {
        method: 'PATCH',
        body: JSON.stringify({ is_active: !isActive }),
      });
      closePanel();
      loadSources();
    } catch (e) {
      alert('Fehler: ' + e.message);
    } finally {
      btn.disabled = false;
    }
  }

  // Event listeners
  document.getElementById('panel-close').addEventListener('click', closePanel);
  document.getElementById('detail-overlay').addEventListener('click', (e) => {
    if (e.target.id === 'detail-overlay') closePanel();
  });
  document.getElementById('trigger-btn').addEventListener('click', () => {
    if (currentSourceId) triggerFetch(currentSourceId);
  });
  document.getElementById('toggle-btn').addEventListener('click', toggleActive);

  // Initial load
  loadSources();
</script>
