---
import BaseLayout from '../../layouts/BaseLayout.astro';
import StickyHeader from '../../components/layout/StickyHeader.astro';
import AdminMobileNav from '../../components/admin/AdminMobileNav.astro';
---

<BaseLayout title="Admin Dashboard - kiezling">
  <StickyHeader />
  <AdminMobileNav currentPage="dashboard" />
  <main class="min-h-screen bg-gray-50 py-6 lg:py-8 lg:ml-56">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <header class="mb-6 lg:mb-8 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900 mb-1">Admin Dashboard</h1>
          <p class="text-sm sm:text-base text-gray-500">Verwaltung von Events, Quellen und Datenqualit√§t</p>
        </div>
        <button id="logout-btn" class="hidden lg:block text-sm text-gray-500 hover:text-gray-700">Abmelden</button>
      </header>

      <!-- Loading State -->
      <div id="loading-state" class="text-center py-12">
        <div class="animate-spin inline-block w-8 h-8 border-4 border-primary-500 border-t-transparent rounded-full"></div>
        <p class="text-gray-500 mt-4">Lade Dashboard...</p>
      </div>

      <!-- Dashboard Content (hidden until loaded) -->
      <div id="dashboard-content" class="hidden">
        <!-- Dashboard Cards - Horizontal scroll on mobile -->
        <div class="flex lg:grid lg:grid-cols-3 xl:grid-cols-5 gap-3 sm:gap-4 md:gap-6 mb-6 lg:mb-8 overflow-x-auto pb-2 -mx-4 px-4 lg:mx-0 lg:px-0 lg:overflow-visible snap-x snap-mandatory lg:snap-none">
          <!-- Review Queue -->
          <a href="/admin/review" class="flex-shrink-0 w-40 sm:w-auto lg:w-auto snap-start bg-white rounded-2xl shadow-card p-4 sm:p-6 hover:shadow-lg transition-shadow border border-gray-100">
            <div class="text-2xl sm:text-3xl mb-2 sm:mb-4">üìã</div>
            <div>
              <h2 class="font-semibold text-gray-900 text-sm sm:text-base">Review Queue</h2>
              <p class="text-xs sm:text-sm text-gray-500 mt-1 hidden sm:block">Events zur manuellen Pr√ºfung</p>
              <div class="mt-2">
                <span id="review-count" class="text-lg sm:text-xl font-bold text-primary-500">--</span>
                <span class="block text-xs text-gray-500">ausstehend</span>
              </div>
            </div>
          </a>

          <a href="/admin/sources" class="flex-shrink-0 w-40 sm:w-auto lg:w-auto snap-start bg-white rounded-2xl shadow-card p-4 sm:p-6 hover:shadow-lg transition-shadow border border-gray-100">
            <div class="text-2xl sm:text-3xl mb-2 sm:mb-4">üì°</div>
            <div>
              <h2 class="font-semibold text-gray-900 text-sm sm:text-base">Quellen-Status</h2>
              <p class="text-xs sm:text-sm text-gray-500 mt-1 hidden sm:block">Gesundheit der Datenquellen</p>
              <div class="mt-2">
                <span id="source-health" class="text-lg sm:text-xl font-bold text-primary-500">--</span>
                <span class="block text-xs text-gray-500">aktive Quellen</span>
              </div>
            </div>
          </a>

          <a href="/admin/dedup" class="flex-shrink-0 w-40 sm:w-auto lg:w-auto snap-start bg-white rounded-2xl shadow-card p-4 sm:p-6 hover:shadow-lg transition-shadow border border-gray-100">
            <div class="text-2xl sm:text-3xl mb-2 sm:mb-4">‚ö†Ô∏è</div>
            <div>
              <h2 class="font-semibold text-gray-900 text-sm sm:text-base">Duplikate</h2>
              <p class="text-xs sm:text-sm text-gray-500 mt-1 hidden sm:block">M√∂gliche Duplikate pr√ºfen</p>
              <div class="mt-2">
                <span id="dup-count" class="text-lg sm:text-xl font-bold text-primary-500">--</span>
                <span class="block text-xs text-gray-500">offen</span>
              </div>
            </div>
          </a>

          <a href="/admin/runs" class="flex-shrink-0 w-40 sm:w-auto lg:w-auto snap-start bg-white rounded-2xl shadow-card p-4 sm:p-6 hover:shadow-lg transition-shadow border border-gray-100">
            <div class="text-2xl sm:text-3xl mb-2 sm:mb-4">üîÑ</div>
            <div>
              <h2 class="font-semibold text-gray-900 text-sm sm:text-base">Ingest-Runs</h2>
              <p class="text-xs sm:text-sm text-gray-500 mt-1 hidden sm:block">Import-Jobs √ºberwachen</p>
              <div class="mt-2">
                <span id="attention-count" class="text-lg sm:text-xl font-bold text-primary-500">--</span>
                <span class="block text-xs text-gray-500">brauchen Aufmerksamkeit</span>
              </div>
            </div>
          </a>

          <a href="/admin/trends" class="flex-shrink-0 w-40 sm:w-auto lg:w-auto snap-start bg-white rounded-2xl shadow-card p-4 sm:p-6 hover:shadow-lg transition-shadow border border-gray-100">
            <div class="text-2xl sm:text-3xl mb-2 sm:mb-4">üî•</div>
            <div>
              <h2 class="font-semibold text-gray-900 text-sm sm:text-base">Trends & Suche</h2>
              <p class="text-xs sm:text-sm text-gray-500 mt-1 hidden sm:block">Suchtrends und Autocomplete</p>
              <div class="mt-2">
                <span id="trending-count" class="text-lg sm:text-xl font-bold text-primary-500">--</span>
                <span class="block text-xs text-gray-500">aktive Trends</span>
              </div>
            </div>
          </a>
        </div>

        <section class="mb-8">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">√úbersicht</h2>
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <a href="/admin/review?status=all" class="bg-white rounded-xl p-4 text-center border border-gray-100 hover:border-primary-300 hover:shadow-md transition-all block">
              <span id="total-events" class="block text-xl font-bold text-primary-500">--</span>
              <span class="text-sm text-gray-500">Events gesamt</span>
            </a>
            <a href="/admin/review?status=published" class="bg-white rounded-xl p-4 text-center border border-gray-100 hover:border-primary-300 hover:shadow-md transition-all block">
              <span id="published-events" class="block text-xl font-bold text-primary-500">--</span>
              <span class="text-sm text-gray-500">Ver√∂ffentlicht</span>
            </a>
            <a href="/admin/review?status=pending_review" class="bg-white rounded-xl p-4 text-center border border-gray-100 hover:border-primary-300 hover:shadow-md transition-all block">
              <span id="pending-events" class="block text-xl font-bold text-primary-500">--</span>
              <span class="text-sm text-gray-500">Ausstehend</span>
            </a>
            <a href="/admin/runs" class="bg-white rounded-xl p-4 text-center border border-gray-100 hover:border-primary-300 hover:shadow-md transition-all block">
              <span id="today-imports" class="block text-xl font-bold text-primary-500">--</span>
              <span class="text-sm text-gray-500">Heute importiert</span>
            </a>
          </div>
        </section>

        <section>
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Quellen-Gesundheit</h2>
          <a href="/admin/sources" class="block bg-white rounded-2xl shadow-card p-4 hover:shadow-lg transition-shadow">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
              <div>
                <span id="sources-healthy" class="block text-lg font-bold text-green-500">--</span>
                <span class="text-xs text-gray-500">Gesund</span>
              </div>
              <div>
                <span id="sources-degraded" class="block text-lg font-bold text-yellow-500">--</span>
                <span class="text-xs text-gray-500">Eingeschr√§nkt</span>
              </div>
              <div>
                <span id="sources-failing" class="block text-lg font-bold text-orange-500">--</span>
                <span class="text-xs text-gray-500">Fehlerhaft</span>
              </div>
              <div>
                <span id="sources-dead" class="block text-lg font-bold text-red-500">--</span>
                <span class="text-xs text-gray-500">Tot</span>
              </div>
              <div>
                <span id="sources-unknown" class="block text-lg font-bold text-gray-400">--</span>
                <span class="text-xs text-gray-500">Unbekannt</span>
              </div>
            </div>
          </a>
        </section>
      </div>

      <!-- Error State -->
      <div id="error-state" class="hidden text-center py-12">
        <p class="text-red-500 text-lg mb-4">Fehler beim Laden des Dashboards</p>
        <button onclick="location.reload()" class="px-4 py-2 bg-primary-500 text-white rounded-lg">Erneut versuchen</button>
      </div>
    </div>
  </main>
</BaseLayout>

<script>
  import { supabase, getSession } from '../../lib/supabase';
  
  const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:4000';
  
  // Hilfsfunktion: Warte auf Auth-Initialisierung
  async function waitForAuth(maxWaitMs = 3000): Promise<string | null> {
    let token = localStorage.getItem('auth_token');
    if (token) return token;

    // Warte auf Supabase Auth State Change (robuster als getSession allein)
    return new Promise((resolve) => {
      let resolved = false;

      const timeout = setTimeout(() => {
        if (!resolved) {
          resolved = true;
          resolve(localStorage.getItem('auth_token'));
        }
      }, maxWaitMs);

      const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
        if (!resolved && session?.access_token) {
          resolved = true;
          clearTimeout(timeout);
          localStorage.setItem('auth_token', session.access_token);
          subscription.unsubscribe();
          resolve(session.access_token);
        }
      });

      getSession().then(session => {
        if (!resolved && session?.access_token) {
          resolved = true;
          clearTimeout(timeout);
          localStorage.setItem('auth_token', session.access_token);
          subscription.unsubscribe();
          resolve(session.access_token);
        }
      });
    });
  }

  (async function() {
    let token = await waitForAuth();

    if (!token) {
      window.location.href = '/login?redirect=/admin';
      return;
    }

    // Verify admin role
    try {
      const meRes = await fetch(`${API_URL}/api/auth/me`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!meRes.ok) {
        // Token ung√ºltig - versuche Supabase-Session als Fallback
        const session = await getSession();
        if (session?.access_token) {
          token = session.access_token;
          localStorage.setItem('auth_token', token);
          const retryRes = await fetch(`${API_URL}/api/auth/me`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (!retryRes.ok) {
            localStorage.removeItem('auth_token');
            window.location.href = '/login?redirect=/admin';
            return;
          }
          const retryData = await retryRes.json();
          if (retryData.data.role !== 'admin') {
            window.location.href = '/?error=not_admin';
            return;
          }
        } else {
          localStorage.removeItem('auth_token');
          window.location.href = '/login?redirect=/admin';
          return;
        }
      } else {
        const meData = await meRes.json();
        if (meData.data.role !== 'admin') {
          window.location.href = '/?error=not_admin';
          return;
        }
      }
    } catch (e) {
      // Netzwerkfehler (z. B. Backend nicht erreichbar): nicht zu Login weiterleiten
      const isNetworkError = e instanceof TypeError && (e.message === 'Failed to fetch' || e.message?.includes('fetch'));
      if (isNetworkError) {
        document.getElementById('loading-state')?.classList.add('hidden');
        document.getElementById('error-state')?.classList.remove('hidden');
        const errEl = document.querySelector('#error-state p');
        if (errEl) errEl.textContent = 'Backend nicht erreichbar. Bitte pr√ºfe, ob der Server l√§uft, und versuche es erneut.';
        return;
      }
      window.location.href = '/login?redirect=/admin';
      return;
    }

    // Load dashboard data
    try {
      const [statsRes, dupsRes, attentionRes, trendsRes] = await Promise.all([
        fetch(`${API_URL}/api/admin/stats`, {
          headers: { Authorization: `Bearer ${token}` }
        }),
        fetch(`${API_URL}/api/admin/duplicates?status=pending&limit=1`, {
          headers: { Authorization: `Bearer ${token}` }
        }),
        fetch(`${API_URL}/api/admin/ingest-runs/needs-attention`, {
          headers: { Authorization: `Bearer ${token}` }
        }),
        fetch(`${API_URL}/api/admin/trends/stats`, {
          headers: { Authorization: `Bearer ${token}` }
        }),
      ]);

      if (!statsRes.ok) throw new Error('Stats fetch failed');

      const stats = await statsRes.json();
      const dups = dupsRes.ok ? await dupsRes.json() : { pagination: { total: 0 } };
      const attention = attentionRes.ok ? await attentionRes.json() : { total: 0 };
      const trends = trendsRes.ok ? await trendsRes.json() : { uniqueTerms: 0, lastComputed: null };

      // Update DOM
      const totalEvents = document.getElementById('total-events');
      const publishedEvents = document.getElementById('published-events');
      const pendingEvents = document.getElementById('pending-events');
      const todayImports = document.getElementById('today-imports');
      const reviewCount = document.getElementById('review-count');
      if (totalEvents) totalEvents.textContent = stats.data.events.total;
      if (publishedEvents) publishedEvents.textContent = stats.data.events.published;
      if (pendingEvents) pendingEvents.textContent = stats.data.events.pending_review;
      if (todayImports) todayImports.textContent = stats.data.events.today_imports;
      if (reviewCount) reviewCount.textContent = stats.data.events.pending_review;

      // Source health
      const sourceTotal = (Object.values(stats.data.sources) as number[]).reduce((a, b) => a + b, 0);
      const sourceHealth = document.getElementById('source-health');
      const sourcesHealthy = document.getElementById('sources-healthy');
      const sourcesDegraded = document.getElementById('sources-degraded');
      const sourcesFailing = document.getElementById('sources-failing');
      const sourcesDead = document.getElementById('sources-dead');
      const sourcesUnknown = document.getElementById('sources-unknown');
      if (sourceHealth) sourceHealth.textContent = String(sourceTotal);
      if (sourcesHealthy) sourcesHealthy.textContent = stats.data.sources.healthy;
      if (sourcesDegraded) sourcesDegraded.textContent = stats.data.sources.degraded;
      if (sourcesFailing) sourcesFailing.textContent = stats.data.sources.failing;
      if (sourcesDead) sourcesDead.textContent = stats.data.sources.dead;
      if (sourcesUnknown) sourcesUnknown.textContent = stats.data.sources.unknown;

      // Duplicates & attention
      const dupCount = document.getElementById('dup-count');
      const attentionCount = document.getElementById('attention-count');
      if (dupCount) dupCount.textContent = String(dups.pagination?.total || 0);
      if (attentionCount) attentionCount.textContent = String(attention.total || 0);

      // Trends
      const trendingCount = document.getElementById('trending-count');
      if (trendingCount) trendingCount.textContent = String(trends.lastComputed ? (trends.uniqueTerms || 0) : 0);

      // Show content
      document.getElementById('loading-state')?.classList.add('hidden');
      document.getElementById('dashboard-content')?.classList.remove('hidden');

    } catch (e) {
      console.error('Dashboard load error:', e);
      document.getElementById('loading-state')?.classList.add('hidden');
      document.getElementById('error-state')?.classList.remove('hidden');
    }

    // Logout handler
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('auth_token');
      window.location.href = '/login';
    });
  })();
</script>
