---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { TEASER_PRESETS } from '../../lib/teaserPresets';
---

<AdminLayout title="Dashboard - kiezling Admin" currentPage="dashboard">
  <!-- Loading State -->
  <div id="loading-state" class="flex items-center justify-center py-16">
    <div class="text-center">
      <div class="animate-spin inline-block w-10 h-10 border-4 border-primary-500 border-t-transparent rounded-full mb-4"></div>
      <p class="text-gray-500">Lade Dashboard...</p>
    </div>
  </div>

  <!-- Dashboard Content (hidden until loaded) -->
  <div id="dashboard-content" class="hidden">
    <script type="application/json" id="teaser-presets-json" set:html={JSON.stringify(TEASER_PRESETS).replace(/</g, '\\u003c')}></script>
    <!-- Page Header -->
    <header class="mb-6">
      <h1 class="text-2xl font-bold text-gray-900">Dashboard</h1>
      <p class="text-gray-500 mt-1">Ãœbersicht Ã¼ber Events, Quellen und Systemstatus</p>
    </header>

    <!-- Teaser-Box (Startseite): Titel + Einstellungen in einer Zeile, darunter Vorschau -->
    <section class="mb-6 bento-card">
      <div class="flex flex-wrap items-center gap-x-4 gap-y-1 mb-3">
        <details id="teaser-settings-details" class="group w-full min-w-0 sm:w-auto">
          <summary class="cursor-pointer list-none flex items-center gap-2 px-3 py-2 rounded-lg bg-gray-100 border border-gray-200 text-sm font-medium text-gray-700 hover:bg-gray-200 hover:border-gray-300 active:bg-gray-300 select-none w-fit transition-colors shadow-sm">
            <svg class="w-4 h-4 text-gray-600 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 2.31.841 1.37 1.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.841 2.31-1.37 1.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-2.31-.841-1.37-1.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.841-2.31 1.37-1.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Einstellungen
          </summary>
          <div class="pt-3 mt-2 border-t border-gray-200">
          <form id="teaser-form" class="space-y-3 max-w-xl">
            <div>
              <label for="teaser-authorName" class="block text-sm font-medium text-gray-700">Autor-Name</label>
              <input type="text" id="teaser-authorName" name="authorName" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-sm" placeholder="WENKE" />
            </div>
            <div>
              <label for="teaser-message" class="block text-sm font-medium text-gray-700">Nachricht</label>
              <textarea id="teaser-message" name="message" rows="3" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-sm" placeholder="Heute Abend gibt's ein kleines Geheimkonzert â€¦"></textarea>
            </div>
            <div>
              <label for="teaser-avatarSrc" class="block text-sm font-medium text-gray-700">Profilbild-URL</label>
              <input type="url" id="teaser-avatarSrc" name="avatarSrc" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-sm" placeholder="https://â€¦" />
            </div>
            <div>
              <label for="teaser-countdownEndDate" class="block text-sm font-medium text-gray-700">Countdown-Enddatum (ISO)</label>
              <input type="datetime-local" id="teaser-countdownEndDate" name="countdownEndDate" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-sm" />
            </div>
            <div>
              <label for="teaser-preset" class="block text-sm font-medium text-gray-700">Design / Anlass</label>
              <select id="teaser-preset" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-sm">
                {TEASER_PRESETS.map((p) => (
                  <option value={p.id}>{p.name}</option>
                ))}
              </select>
            </div>
            <input type="hidden" id="teaser-variant" name="variant" value="7" />
            <input type="hidden" id="teaser-contentVariant" name="contentVariant" value="16" />
            <input type="hidden" id="teaser-teaserLabel" name="teaserLabel" value="Tipp von" />
            <input type="hidden" id="teaser-teaserIcon" name="teaserIcon" value="" />
            <input type="hidden" id="teaser-teaserThemeClass" name="teaserThemeClass" value="" />
            <div class="flex gap-2 pt-2">
              <button type="button" id="teaser-preview-btn" class="px-4 py-2 rounded-md bg-gray-100 text-gray-800 text-sm font-medium hover:bg-gray-200">Vorschau aktualisieren</button>
              <button type="submit" id="teaser-save-btn" class="px-4 py-2 rounded-md bg-primary-600 text-white text-sm font-medium hover:bg-primary-700">Speichern</button>
            </div>
          </form>
          <p id="teaser-save-status" class="mt-2 text-sm text-green-600 hidden">Gespeichert.</p>
          </div>
        </details>
        <div class="flex flex-wrap items-baseline gap-x-2 gap-y-1">
          <h2 class="font-semibold text-gray-900">Teaser-Box (Startseite)</h2>
          <span class="text-sm text-gray-500">â€” Vorschau wie auf der Startseite</span>
        </div>
      </div>

      <!-- Vorschau 1:1 wie auf der Startseite (ohne abgerundete Ecken) -->
      <div class="tagestipp-section pt-3 px-[18px] pb-0 bg-tagestipp-bg overflow-hidden">
        <div class="max-w-[1220px] mx-auto">
          <iframe id="teaser-preview-iframe" title="Teaser-Box Vorschau" class="w-full border-0 bg-tagestipp-bg block" style="min-height: 170px; height: 170px;"></iframe>
        </div>
      </div>
    </section>

    <!-- KPI Cards: Top Section - 2x3 Grid -->
    <section class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
      <!-- Events Total -->
      <a href="/admin/review?status=all" class="kpi-card group">
        <div class="kpi-icon bg-blue-100 text-blue-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
          </svg>
        </div>
        <span id="kpi-total" class="kpi-number">--</span>
        <span class="kpi-label">Events gesamt</span>
      </a>

      <!-- Published -->
      <a href="/admin/review?status=published" class="kpi-card group">
        <div class="kpi-icon bg-green-100 text-green-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <span id="kpi-published" class="kpi-number text-green-600">--</span>
        <span class="kpi-label">VerÃ¶ffentlicht</span>
      </a>

      <!-- Pending Review -->
      <a href="/admin/review?status=pending_review" class="kpi-card group">
        <div class="kpi-icon bg-purple-100 text-purple-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
          </svg>
        </div>
        <span id="kpi-pending" class="kpi-number text-purple-600">--</span>
        <span class="kpi-label">Zur PrÃ¼fung</span>
      </a>

      <!-- Today Imports -->
      <a href="/admin/runs" class="kpi-card group">
        <div class="kpi-icon bg-cyan-100 text-cyan-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
          </svg>
        </div>
        <span id="kpi-today" class="kpi-number text-cyan-600">--</span>
        <span class="kpi-label">Heute importiert</span>
      </a>

      <!-- Pending AI -->
      <a href="/admin/ai-worker" class="kpi-card group">
        <div class="kpi-icon bg-amber-100 text-amber-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
        </div>
        <span id="kpi-pending-ai" class="kpi-number text-amber-600">--</span>
        <span class="kpi-label">Warten auf AI</span>
      </a>

      <!-- Duplicates -->
      <a href="/admin/dedup" class="kpi-card group">
        <div class="kpi-icon bg-red-100 text-red-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" />
          </svg>
        </div>
        <span id="kpi-duplicates" class="kpi-number text-red-600">--</span>
        <span class="kpi-label">Duplikate</span>
      </a>
    </section>

    <!-- AI Processing Stats Section -->
    <section class="mb-6">
      <a href="/admin/ai-worker" class="bento-card group">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold text-gray-900 flex items-center gap-2">
            <span class="text-lg">ðŸ¤–</span>
            Von AI Ã¼berprÃ¼ft
          </h2>
          <span id="ai-total-processed" class="text-sm text-gray-500">-- Events verarbeitet</span>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <!-- AI Published -->
          <div class="text-center p-4 rounded-xl bg-gradient-to-br from-green-50 to-emerald-50 border border-green-100">
            <div class="flex items-center justify-center gap-2 mb-1">
              <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class="text-xs font-medium text-green-700">Freigegeben</span>
            </div>
            <span id="ai-published" class="block text-3xl font-bold text-green-600">--</span>
            <span class="text-xs text-green-600">auto-verÃ¶ffentlicht</span>
          </div>

          <!-- AI Pending Review -->
          <div class="text-center p-4 rounded-xl bg-gradient-to-br from-amber-50 to-yellow-50 border border-amber-100">
            <div class="flex items-center justify-center gap-2 mb-1">
              <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class="text-xs font-medium text-amber-700">Zur PrÃ¼fung</span>
            </div>
            <span id="ai-pending-review" class="block text-3xl font-bold text-amber-600">--</span>
            <span class="text-xs text-amber-600">manuelle PrÃ¼fung</span>
          </div>

          <!-- AI Rejected -->
          <div class="text-center p-4 rounded-xl bg-gradient-to-br from-red-50 to-rose-50 border border-red-100">
            <div class="flex items-center justify-center gap-2 mb-1">
              <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class="text-xs font-medium text-red-700">Abgelehnt</span>
            </div>
            <span id="ai-rejected" class="block text-3xl font-bold text-red-600">--</span>
            <span class="text-xs text-red-600">nicht familientauglich</span>
          </div>
        </div>
      </a>
    </section>

    <!-- Middle Section: Two Columns -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      <!-- System Health Widget -->
      <a href="/admin/health" class="bento-card group">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold text-gray-900 flex items-center gap-2">
            <span class="text-lg">ðŸ’š</span>
            System Health
          </h2>
          <span id="health-status-badge" class="px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-500">
            PrÃ¼fe...
          </span>
        </div>
        
        <div class="grid grid-cols-4 gap-3 mb-4">
          <div class="flex flex-col items-center gap-1.5 p-2 rounded-lg bg-gray-50">
            <span id="health-db-indicator" class="w-3 h-3 rounded-full bg-gray-300"></span>
            <span class="text-xs text-gray-600 font-medium">Database</span>
          </div>
          <div class="flex flex-col items-center gap-1.5 p-2 rounded-lg bg-gray-50">
            <span id="health-redis-indicator" class="w-3 h-3 rounded-full bg-gray-300"></span>
            <span class="text-xs text-gray-600 font-medium">Redis</span>
          </div>
          <div class="flex flex-col items-center gap-1.5 p-2 rounded-lg bg-gray-50">
            <span id="health-ai-indicator" class="w-3 h-3 rounded-full bg-gray-300"></span>
            <span class="text-xs text-gray-600 font-medium">AI Worker</span>
          </div>
          <div class="flex flex-col items-center gap-1.5 p-2 rounded-lg bg-gray-50">
            <span id="health-queue-indicator" class="w-3 h-3 rounded-full bg-gray-300"></span>
            <span class="text-xs text-gray-600 font-medium">Queue</span>
          </div>
        </div>

        <div class="text-xs text-gray-400 flex items-center justify-between">
          <span id="health-last-update">Letzte Aktualisierung: --</span>
          <span id="health-uptime" class="text-gray-500"></span>
        </div>
      </a>

      <!-- Sources Health -->
      <a href="/admin/sources" class="bento-card group">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold text-gray-900 flex items-center gap-2">
            <span class="text-lg">ðŸ“¡</span>
            Quellen-Gesundheit
          </h2>
          <span id="sources-total" class="text-sm text-gray-500">-- Quellen</span>
        </div>

        <div class="grid grid-cols-5 gap-2">
          <div class="text-center p-3 rounded-lg bg-green-50">
            <span id="sources-healthy" class="block text-xl font-bold text-green-600">--</span>
            <span class="text-xs text-green-700">Gesund</span>
          </div>
          <div class="text-center p-3 rounded-lg bg-yellow-50">
            <span id="sources-degraded" class="block text-xl font-bold text-yellow-600">--</span>
            <span class="text-xs text-yellow-700">Eingeschr.</span>
          </div>
          <div class="text-center p-3 rounded-lg bg-orange-50">
            <span id="sources-failing" class="block text-xl font-bold text-orange-600">--</span>
            <span class="text-xs text-orange-700">Fehler</span>
          </div>
          <div class="text-center p-3 rounded-lg bg-red-50">
            <span id="sources-dead" class="block text-xl font-bold text-red-600">--</span>
            <span class="text-xs text-red-700">Tot</span>
          </div>
          <div class="text-center p-3 rounded-lg bg-gray-50">
            <span id="sources-unknown" class="block text-xl font-bold text-gray-500">--</span>
            <span class="text-xs text-gray-600">Unbek.</span>
          </div>
        </div>
      </a>
    </section>

    <!-- Bottom Section: Two Columns -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Trends Mini Stats -->
      <a href="/admin/trends" class="bento-card group">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold text-gray-900 flex items-center gap-2">
            <span class="text-lg">ðŸ”¥</span>
            Trends & Suche
          </h2>
          <svg class="w-5 h-5 text-gray-400 group-hover:text-primary-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </div>

        <div class="flex items-center gap-4">
          <div class="flex-1 p-4 rounded-xl bg-gradient-to-br from-orange-50 to-amber-50">
            <span id="trends-count" class="block text-3xl font-bold text-orange-600">--</span>
            <span class="text-sm text-orange-700">Trending Terms</span>
          </div>
          <div class="flex-1 text-sm text-gray-500">
            <p>Zuletzt berechnet:</p>
            <p id="trends-last-computed" class="font-medium text-gray-700">--</p>
          </div>
        </div>
      </a>

      <!-- Ingest Attention List -->
      <a href="/admin/runs" class="bento-card group">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold text-gray-900 flex items-center gap-2">
            <span class="text-lg">ðŸ”„</span>
            Ingest-Runs
          </h2>
          <span class="text-sm text-primary-600 group-hover:underline">Alle anzeigen â†’</span>
        </div>

        <div class="flex items-center gap-4">
          <div id="attention-container" class="flex-1 p-4 rounded-xl bg-gradient-to-br from-red-50 to-orange-50">
            <span id="attention-count" class="block text-3xl font-bold text-red-600">--</span>
            <span class="text-sm text-red-700">brauchen Aufmerksamkeit</span>
          </div>
          <div class="flex-1 text-sm text-gray-500">
            <p>Runs mit Fehlern oder</p>
            <p>ungewÃ¶hnlichem Verhalten</p>
          </div>
        </div>
      </a>
    </section>
  </div>

  <!-- Error State -->
  <div id="error-state" class="hidden">
    <div class="text-center py-16">
      <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
      </div>
      <p class="text-red-600 text-lg font-medium mb-2">Fehler beim Laden des Dashboards</p>
      <p id="error-message" class="text-gray-500 mb-4">Bitte versuche es erneut.</p>
      <button onclick="location.reload()" class="px-6 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors">
        Erneut versuchen
      </button>
    </div>
  </div>
</AdminLayout>

<style>
  /* KPI Card Styles */
  .kpi-card {
    @apply relative bg-white rounded-2xl shadow-sm p-4 
           border border-gray-100 
           hover:shadow-md hover:border-gray-200
           transition-all duration-200
           flex flex-col items-center text-center;
  }

  .kpi-icon {
    @apply absolute top-3 right-3 w-8 h-8 rounded-lg 
           flex items-center justify-center
           opacity-70 group-hover:opacity-100 transition-opacity;
  }

  .kpi-number {
    @apply text-3xl font-bold text-gray-900 mt-2 mb-1;
  }

  .kpi-label {
    @apply text-xs text-gray-500 font-medium;
  }

  /* Bento Card Styles */
  .bento-card {
    @apply block bg-white rounded-2xl shadow-sm p-5
           border border-gray-100
           hover:shadow-md hover:border-gray-200
           transition-all duration-200;
  }

  /* Health Status Colors */
  .health-ok { @apply bg-green-500; }
  .health-degraded { @apply bg-yellow-500; }
  .health-error { @apply bg-red-500; }
  .health-unknown { @apply bg-gray-400; }

  /* Teaser: Einstellungen aufgeklappt = volle Breite fÃ¼r Formular */
  #teaser-settings-details[open] { width: 100%; }
</style>

<script>
  const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:4000';
  const TEASER_PRESETS = (() => {
    try {
      const el = document.getElementById('teaser-presets-json');
      return el?.textContent ? JSON.parse(el.textContent) : [];
    } catch {
      return [];
    }
  })();

  // Get auth token
  function getToken(): string | null {
    return localStorage.getItem('auth_token');
  }

  // Fetch with auth
  async function fetchWithAuth(url: string) {
    const token = getToken();
    if (!token) throw new Error('No auth token');
    
    const res = await fetch(url, {
      headers: { Authorization: `Bearer ${token}` }
    });
    
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  // Format relative time
  function formatRelativeTime(dateStr: string | null): string {
    if (!dateStr) return 'Nie';
    
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);

    if (diffMins < 1) return 'Gerade eben';
    if (diffMins < 60) return `vor ${diffMins} Min.`;
    if (diffHours < 24) return `vor ${diffHours} Std.`;
    return `vor ${diffDays} Tagen`;
  }

  // Teaser-Box: Form aus Daten fÃ¼llen (inkl. Preset-Dropdown und teaserLabel/Icon/ThemeClass)
  function fillTeaserForm(data: Record<string, unknown> | null) {
    if (!data) return;
    const authorName = document.getElementById('teaser-authorName') as HTMLInputElement;
    const message = document.getElementById('teaser-message') as HTMLTextAreaElement;
    const avatarSrc = document.getElementById('teaser-avatarSrc') as HTMLInputElement;
    const countdownEndDate = document.getElementById('teaser-countdownEndDate') as HTMLInputElement;
    const variant = document.getElementById('teaser-variant') as HTMLInputElement;
    const contentVariant = document.getElementById('teaser-contentVariant') as HTMLInputElement;
    const teaserLabel = document.getElementById('teaser-teaserLabel') as HTMLInputElement;
    const teaserIcon = document.getElementById('teaser-teaserIcon') as HTMLInputElement;
    const teaserThemeClass = document.getElementById('teaser-teaserThemeClass') as HTMLInputElement;
    const presetSelect = document.getElementById('teaser-preset') as HTMLSelectElement;
    if (authorName && data.authorName != null) authorName.value = String(data.authorName);
    if (message && data.message != null) message.value = String(data.message);
    if (avatarSrc && data.avatarSrc != null) avatarSrc.value = String(data.avatarSrc);
    if (countdownEndDate && data.countdownEndDate != null) {
      const iso = String(data.countdownEndDate);
      countdownEndDate.value = iso.slice(0, 16);
    }
    if (data.teaserLabel != null && teaserLabel) teaserLabel.value = String(data.teaserLabel);
    if (data.teaserIcon != null && teaserIcon) teaserIcon.value = String(data.teaserIcon);
    if (data.teaserThemeClass != null && teaserThemeClass) teaserThemeClass.value = String(data.teaserThemeClass);
    if (variant && data.variant != null) variant.value = String(data.variant);
    if (contentVariant && data.contentVariant != null) contentVariant.value = String(data.contentVariant);
    if (presetSelect && Array.isArray(TEASER_PRESETS) && TEASER_PRESETS.length > 0) {
      const v = Number(variant?.value ?? 7);
      const c = Number(contentVariant?.value ?? 16);
      const theme = teaserThemeClass?.value ?? '';
      const match = TEASER_PRESETS.find((p) => p.variant === v && p.contentVariant === c && (p.themeClass === theme || (!p.themeClass && !theme)));
      presetSelect.value = match ? String(match.id) : '1';
    }
  }

  // Teaser-Box: iframe-Vorschau-URL aus Form bauen und setzen
  function updateTeaserPreview() {
    const iframe = document.getElementById('teaser-preview-iframe') as HTMLIFrameElement;
    if (!iframe) return;
    const authorName = (document.getElementById('teaser-authorName') as HTMLInputElement)?.value || 'WENKE';
    const message = (document.getElementById('teaser-message') as HTMLTextAreaElement)?.value || '';
    const avatarSrc = (document.getElementById('teaser-avatarSrc') as HTMLInputElement)?.value || '';
    const countdownEndDate = (document.getElementById('teaser-countdownEndDate') as HTMLInputElement)?.value || '';
    const variant = (document.getElementById('teaser-variant') as HTMLInputElement)?.value || '7';
    const contentVariant = (document.getElementById('teaser-contentVariant') as HTMLInputElement)?.value || '16';
    const teaserLabel = (document.getElementById('teaser-teaserLabel') as HTMLInputElement)?.value ?? '';
    const teaserIcon = (document.getElementById('teaser-teaserIcon') as HTMLInputElement)?.value ?? '';
    const teaserThemeClass = (document.getElementById('teaser-teaserThemeClass') as HTMLInputElement)?.value ?? '';
    const params = new URLSearchParams({
      authorName,
      message,
      avatarSrc,
      countdownEndDate: countdownEndDate ? countdownEndDate.replace(' ', 'T') : '2025-08-16T20:00:00',
      variant,
      contentVariant,
    });
    if (teaserLabel) params.set('teaserLabel', teaserLabel);
    if (teaserIcon) params.set('teaserIcon', teaserIcon);
    if (teaserThemeClass) params.set('teaserThemeClass', teaserThemeClass);
    iframe.src = `/admin/teaser-preview?${params.toString()}`;
  }

  // Load all dashboard data
  async function loadDashboardData() {
    try {
      const [statsRes, dupsRes, attentionRes, trendsRes, pendingAiRes, teaserRes] = await Promise.all([
        fetchWithAuth(`${API_URL}/api/admin/stats`),
        fetchWithAuth(`${API_URL}/api/admin/duplicates?status=pending&limit=1`).catch(() => ({ pagination: { total: 0 } })),
        fetchWithAuth(`${API_URL}/api/admin/ingest-runs/needs-attention`).catch(() => ({ total: 0 })),
        fetchWithAuth(`${API_URL}/api/admin/trends/stats`).catch(() => ({ uniqueTerms: 0, lastComputed: null })),
        fetchWithAuth(`${API_URL}/api/admin/pending-ai-count`).catch(() => ({ data: { count: 0 } })),
        fetchWithAuth(`${API_URL}/api/admin/settings/homepage-teaser`).catch(() => ({ data: null })),
      ]);

      // Update KPI Cards
      const setText = (id: string, value: string | number) => {
        const el = document.getElementById(id);
        if (el) el.textContent = String(value);
      };

      setText('kpi-total', statsRes.data.events.total);
      setText('kpi-published', statsRes.data.events.published);
      setText('kpi-pending', statsRes.data.events.pending_review);
      setText('kpi-today', statsRes.data.events.today_imports);
      setText('kpi-pending-ai', pendingAiRes.data?.count || 0);
      setText('kpi-duplicates', dupsRes.pagination?.total || 0);

      // Update AI Processing Stats
      const aiStats = statsRes.data.ai_stats;
      if (aiStats) {
        setText('ai-total-processed', `${aiStats.total_processed} Events verarbeitet`);
        setText('ai-published', aiStats.ai_published);
        setText('ai-pending-review', aiStats.ai_pending_review);
        setText('ai-rejected', aiStats.ai_rejected);
      }

      // Update Source Health
      const sources = statsRes.data.sources;
      const totalSources = Object.values(sources).reduce((a: number, b) => a + (b as number), 0);
      setText('sources-total', `${totalSources} Quellen`);
      setText('sources-healthy', sources.healthy);
      setText('sources-degraded', sources.degraded);
      setText('sources-failing', sources.failing);
      setText('sources-dead', sources.dead);
      setText('sources-unknown', sources.unknown);

      // Update Trends
      setText('trends-count', trendsRes.uniqueTerms || 0);
      setText('trends-last-computed', formatRelativeTime(trendsRes.lastComputed));

      // Update Attention Count
      const attentionCount = attentionRes.total || 0;
      setText('attention-count', attentionCount);
      
      // Update attention container color based on count
      const attentionContainer = document.getElementById('attention-container');
      if (attentionContainer) {
        if (attentionCount === 0) {
          attentionContainer.className = 'flex-1 p-4 rounded-xl bg-gradient-to-br from-green-50 to-emerald-50';
          const countEl = attentionContainer.querySelector('#attention-count');
          const labelEl = attentionContainer.querySelector('span:last-child');
          if (countEl) countEl.className = 'block text-3xl font-bold text-green-600';
          if (labelEl) {
            labelEl.className = 'text-sm text-green-700';
            labelEl.textContent = 'alles in Ordnung';
          }
        }
      }

      // Show content
      document.getElementById('loading-state')?.classList.add('hidden');
      document.getElementById('dashboard-content')?.classList.remove('hidden');

      // Teaser-Box: Form fÃ¼llen und Vorschau setzen
      fillTeaserForm(teaserRes?.data ?? null);
      updateTeaserPreview();

    } catch (e) {
      console.error('Dashboard load error:', e);
      document.getElementById('loading-state')?.classList.add('hidden');
      document.getElementById('error-state')?.classList.remove('hidden');
      
      const errorMsg = document.getElementById('error-message');
      if (errorMsg && e instanceof Error) {
        if (e.message.includes('Failed to fetch')) {
          errorMsg.textContent = 'Backend nicht erreichbar. Bitte prÃ¼fe, ob der Server lÃ¤uft.';
        }
      }
    }
  }

  // Update health widget
  async function updateHealthWidget() {
    try {
      const health = await fetchWithAuth(`${API_URL}/api/health/detailed`);

      // Status badge
      const statusBadge = document.getElementById('health-status-badge');
      if (statusBadge) {
        const statusStyles: Record<string, string> = {
          ok: 'bg-green-100 text-green-700',
          degraded: 'bg-yellow-100 text-yellow-700',
          error: 'bg-red-100 text-red-700',
        };
        const statusLabels: Record<string, string> = {
          ok: 'Alles OK',
          degraded: 'EingeschrÃ¤nkt',
          error: 'Fehler',
        };
        const statusKey = String(health.status ?? '');
        statusBadge.className = `px-3 py-1 text-xs font-medium rounded-full ${statusStyles[statusKey] || 'bg-gray-100 text-gray-500'}`;
        statusBadge.textContent = statusLabels[statusKey] || 'Unbekannt';
      }

      // Database indicator
      const dbIndicator = document.getElementById('health-db-indicator');
      if (dbIndicator && health.services?.database) {
        const dbStatus = health.services.database.status;
        dbIndicator.className = `w-3 h-3 rounded-full ${dbStatus === 'ok' ? 'bg-green-500' : 'bg-red-500'}`;
      }

      // Redis indicator
      const redisIndicator = document.getElementById('health-redis-indicator');
      if (redisIndicator && health.services?.redis) {
        const redisStatus = health.services.redis.status;
        const redisOk = ['connected', 'ok'].includes(redisStatus);
        const redisDisabled = redisStatus === 'disabled';
        redisIndicator.className = `w-3 h-3 rounded-full ${redisOk ? 'bg-green-500' : redisDisabled ? 'bg-gray-400' : 'bg-red-500'}`;
      }

      // AI Worker indicator
      const aiIndicator = document.getElementById('health-ai-indicator');
      if (aiIndicator) {
        try {
          const aiHealth = await fetchWithAuth(`${API_URL}/api/admin/ai-worker/health`);
          const aiOk = aiHealth.success && aiHealth.data?.status === 'healthy';
          aiIndicator.className = `w-3 h-3 rounded-full ${aiOk ? 'bg-green-500' : 'bg-yellow-500'}`;
        } catch {
          aiIndicator.className = 'w-3 h-3 rounded-full bg-gray-400';
        }
      }

      // Queue indicator
      const queueIndicator = document.getElementById('health-queue-indicator');
      if (queueIndicator && health.queue) {
        const hasFailedJobs = (health.queue.failed || 0) > 0;
        queueIndicator.className = `w-3 h-3 rounded-full ${hasFailedJobs ? 'bg-yellow-500' : 'bg-green-500'}`;
      } else if (queueIndicator) {
        queueIndicator.className = 'w-3 h-3 rounded-full bg-gray-400';
      }

      // Last update timestamp
      const lastUpdate = document.getElementById('health-last-update');
      if (lastUpdate) {
        lastUpdate.textContent = `Aktualisiert: ${new Date().toLocaleTimeString('de-DE')}`;
      }

      // Uptime
      const uptimeEl = document.getElementById('health-uptime');
      if (uptimeEl && health.uptime) {
        const uptimeHours = Math.floor(health.uptime / 3600);
        const uptimeMins = Math.floor((health.uptime % 3600) / 60);
        uptimeEl.textContent = `Uptime: ${uptimeHours}h ${uptimeMins}m`;
      }

    } catch (e) {
      console.error('Health widget error:', e);
      const statusBadge = document.getElementById('health-status-badge');
      if (statusBadge) {
        statusBadge.className = 'px-3 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700';
        statusBadge.textContent = 'Nicht erreichbar';
      }
    }
  }

  // Initialize dashboard
  async function initDashboard() {
    // Wait a bit for AdminLayout auth check to complete
    await new Promise(resolve => setTimeout(resolve, 100));
    
    // Check if we have a token (AdminLayout handles redirect if not)
    const token = getToken();
    if (!token) {
      // AdminLayout will handle redirect
      return;
    }

    // Load initial data
    await loadDashboardData();
    await updateHealthWidget();

    // Teaser-Box: Preset-Dropdown â€“ bei Ã„nderung Hidden-Felder setzen und Vorschau aktualisieren
    document.getElementById('teaser-preset')?.addEventListener('change', () => {
      if (!Array.isArray(TEASER_PRESETS) || TEASER_PRESETS.length === 0) return;
      const presetSelect = document.getElementById('teaser-preset') as HTMLSelectElement;
      const id = parseInt(presetSelect?.value || '1', 10);
      const preset = TEASER_PRESETS.find((p) => p.id === id) ?? TEASER_PRESETS[0];
      if (!preset) return;
      const variant = document.getElementById('teaser-variant') as HTMLInputElement;
      const contentVariant = document.getElementById('teaser-contentVariant') as HTMLInputElement;
      const teaserLabel = document.getElementById('teaser-teaserLabel') as HTMLInputElement;
      const teaserIcon = document.getElementById('teaser-teaserIcon') as HTMLInputElement;
      const teaserThemeClass = document.getElementById('teaser-teaserThemeClass') as HTMLInputElement;
      if (variant) variant.value = String(preset.variant);
      if (contentVariant) contentVariant.value = String(preset.contentVariant);
      if (teaserLabel) teaserLabel.value = preset.label ?? '';
      if (teaserIcon) teaserIcon.value = preset.icon ?? '';
      if (teaserThemeClass) teaserThemeClass.value = preset.themeClass ?? '';
      updateTeaserPreview();
    });

    // Teaser-Box: Buttons und Form
    document.getElementById('teaser-preview-btn')?.addEventListener('click', updateTeaserPreview);
    document.getElementById('teaser-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target as HTMLFormElement;
      const countdownVal = (document.getElementById('teaser-countdownEndDate') as HTMLInputElement)?.value;
      const payload = {
        authorName: (form.authorName as HTMLInputElement)?.value,
        message: (form.message as HTMLTextAreaElement)?.value,
        avatarSrc: (form.avatarSrc as HTMLInputElement)?.value,
        countdownEndDate: countdownVal ? countdownVal.replace(' ', 'T') : undefined,
        variant: parseInt((form.variant as HTMLInputElement)?.value || '7', 10),
        contentVariant: parseInt((form.contentVariant as HTMLInputElement)?.value || '16', 10),
        teaserLabel: (form.teaserLabel as HTMLInputElement)?.value ?? undefined,
        teaserIcon: (form.teaserIcon as HTMLInputElement)?.value ?? undefined,
        teaserThemeClass: (form.teaserThemeClass as HTMLInputElement)?.value ?? undefined,
      };
      const putRes = await fetch(`${API_URL}/api/admin/settings/homepage-teaser`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${getToken()}`,
        },
        body: JSON.stringify(payload),
      });
      if (!putRes.ok) throw new Error(`HTTP ${putRes.status}`);
      const json = await putRes.json();
      fillTeaserForm(json.data ?? null);
      updateTeaserPreview();
      const statusEl = document.getElementById('teaser-save-status');
      if (statusEl) {
        statusEl.classList.remove('hidden');
        setTimeout(() => statusEl.classList.add('hidden'), 3000);
      }
    });

    // Auto-refresh every 30 seconds
    setInterval(() => {
      loadDashboardData();
      updateHealthWidget();
    }, 30000);
  }

  // Start when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDashboard);
  } else {
    initDashboard();
  }
</script>
