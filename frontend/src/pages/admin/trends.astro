---
import AdminLayout from '../../layouts/AdminLayout.astro';
const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:4000';
---

<AdminLayout title="Trends - kiezling Admin" currentPage="trends">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Trends & Suche</h1>
      <p class="text-sm text-gray-500 mt-1">
        Zuletzt berechnet: <span id="last-computed-header" class="font-medium">-</span>
      </p>
    </div>
    <button 
      id="compute-trends-btn" 
      class="inline-flex items-center gap-2 px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors font-medium"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
      <span>Compute Trends</span>
    </button>
  </div>

  <!-- Tab Navigation -->
  <div class="bg-white rounded-xl shadow-sm mb-6">
    <div class="border-b border-gray-200">
      <nav class="flex">
        <button class="main-tab active" data-tab="stats">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          Stats
        </button>
        <button class="main-tab" data-tab="preview">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
          Preview
        </button>
        <button class="main-tab" data-tab="overrides">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
          </svg>
          Overrides
        </button>
      </nav>
    </div>

    <!-- Tab: Stats -->
    <div id="tab-stats" class="tab-content p-6">
      <!-- Stats Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
        <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500">Suchanfragen (7d)</p>
              <p class="text-2xl font-bold text-gray-900 mt-1" id="stat-searches">-</p>
            </div>
            <div class="w-16 h-10" id="stat-searches-chart">
              <!-- Mini bar chart placeholder -->
              <div class="flex items-end gap-0.5 h-full">
                <div class="flex-1 bg-primary-200 rounded-t" style="height: 40%"></div>
                <div class="flex-1 bg-primary-200 rounded-t" style="height: 60%"></div>
                <div class="flex-1 bg-primary-200 rounded-t" style="height: 45%"></div>
                <div class="flex-1 bg-primary-200 rounded-t" style="height: 80%"></div>
                <div class="flex-1 bg-primary-200 rounded-t" style="height: 70%"></div>
                <div class="flex-1 bg-primary-300 rounded-t" style="height: 90%"></div>
                <div class="flex-1 bg-primary-500 rounded-t" style="height: 100%"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500">Einzigartige Begriffe</p>
              <p class="text-2xl font-bold text-gray-900 mt-1" id="stat-unique">-</p>
            </div>
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
              </svg>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500">Zuletzt berechnet</p>
              <p class="text-lg font-medium text-gray-900 mt-1" id="stat-computed">-</p>
            </div>
            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Top Trending Terms Table -->
      <div class="border border-gray-200 rounded-xl overflow-hidden">
        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
          <h3 class="font-semibold text-gray-900">Top Trending Terms</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 text-left text-sm text-gray-500">
              <tr>
                <th class="px-4 py-3 font-medium">#</th>
                <th class="px-4 py-3 font-medium">Begriff</th>
                <th class="px-4 py-3 font-medium">Suchanfragen</th>
                <th class="px-4 py-3 font-medium text-right">Aktionen</th>
              </tr>
            </thead>
            <tbody id="trending-table-body" class="divide-y divide-gray-100">
              <tr>
                <td colspan="4" class="px-4 py-8 text-center text-gray-400">Wird geladen...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tab: Preview -->
    <div id="tab-preview" class="tab-content hidden p-6">
      <!-- Preview Controls -->
      <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
        <div class="flex items-center gap-4">
          <!-- Device Toggle -->
          <div class="flex rounded-lg border border-gray-200 overflow-hidden text-sm">
            <button class="device-toggle px-3 py-2 bg-gray-100 font-medium" data-device="mobile">
              <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              Mobile
            </button>
            <button class="device-toggle px-3 py-2" data-device="desktop">
              <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
              Desktop
            </button>
          </div>

          <!-- Override Toggle -->
          <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
            <input type="checkbox" id="hide-overrides" class="rounded border-gray-300 text-primary-500 focus:ring-primary-500">
            <span>Ohne Overrides</span>
          </label>
        </div>

        <button id="preview-refresh" class="text-sm text-primary-500 hover:text-primary-600 flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Aktualisieren
        </button>
      </div>

      <!-- Preview Frame -->
      <div id="preview-container" class="preview-mobile bg-gray-100 rounded-xl p-6">
        <div class="preview-inner mx-auto">
          <!-- Mock Search Input -->
          <div class="bg-white rounded-full border border-gray-200 px-4 py-3 flex items-center shadow-sm mb-2">
            <svg class="w-5 h-5 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input 
              type="text" 
              id="preview-query" 
              placeholder="Was wollt ihr machen?"
              class="flex-1 bg-transparent outline-none text-gray-700"
            />
          </div>

          <!-- Autocomplete Dropdown -->
          <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden relative">
            <!-- Loading Overlay -->
            <div id="preview-loading" class="hidden absolute inset-0 bg-white/80 flex items-center justify-center z-10">
              <div class="animate-spin w-6 h-6 border-2 border-primary-500 border-t-transparent rounded-full"></div>
            </div>

            <!-- Suggestions Section -->
            <div id="preview-suggestions-section">
              <div class="px-4 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wide bg-gray-50">
                Vorschl√§ge
              </div>
              <div id="preview-suggestions-list"></div>
            </div>

            <!-- Trending Section -->
            <div id="preview-trending-section" class="border-t border-gray-100">
              <div class="px-4 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wide bg-gray-50">
                Trending
              </div>
              <div id="preview-trending-list"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Debug Info -->
      <div class="mt-4 text-center text-xs text-gray-400" id="preview-debug"></div>
    </div>

    <!-- Tab: Overrides -->
    <div id="tab-overrides" class="tab-content hidden p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
        <div>
          <h3 class="font-semibold text-gray-900">Override-Regeln</h3>
          <p class="text-sm text-gray-500">Manuelle Anpassungen der Suchergebnisse</p>
        </div>
        <button id="create-override-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors font-medium">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          Neuer Override
        </button>
      </div>

      <!-- Overrides List -->
      <div class="border border-gray-200 rounded-xl overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 text-left text-sm text-gray-500">
              <tr>
                <th class="px-4 py-3 font-medium">Begriff</th>
                <th class="px-4 py-3 font-medium">Aktion</th>
                <th class="px-4 py-3 font-medium">Ersetzung</th>
                <th class="px-4 py-3 font-medium">Priorit√§t</th>
                <th class="px-4 py-3 font-medium text-right">Aktionen</th>
              </tr>
            </thead>
            <tbody id="overrides-table-body" class="divide-y divide-gray-100">
              <tr>
                <td colspan="5" class="px-4 py-8 text-center text-gray-400">Wird geladen...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Undo Toast -->
  <div id="undo-toast" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-4 z-50">
    <span id="undo-message">Aktion durchgef√ºhrt</span>
    <button id="undo-btn" class="text-primary-400 hover:text-primary-300 font-medium">R√ºckg√§ngig</button>
    <button id="close-toast" class="text-gray-400 hover:text-white">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>

  <!-- Override Modal -->
  <div id="override-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-gray-100">
        <h3 class="text-xl font-bold text-gray-900" id="modal-title">Neuer Override</h3>
      </div>
      
      <form id="override-form" class="p-6 space-y-4">
        <input type="hidden" name="id" />
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Suchbegriff</label>
          <input 
            type="text" 
            name="term" 
            required 
            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            placeholder="z.B. spielplatz"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Aktion</label>
          <select 
            name="action" 
            required 
            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
          >
            <option value="PIN">PIN - Ganz oben fixieren</option>
            <option value="HIDE">HIDE - Verstecken</option>
            <option value="BOOST">BOOST - Score erh√∂hen</option>
            <option value="REPLACE">REPLACE - Durch anderen Begriff ersetzen</option>
            <option value="PUSH">PUSH - In Trending einf√ºgen</option>
          </select>
        </div>

        <div id="replacement-field" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-1">Ersatz-Begriff</label>
          <input 
            type="text" 
            name="replacement" 
            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            placeholder="z.B. kinderspielplatz"
          />
        </div>

        <div id="priority-field">
          <label class="block text-sm font-medium text-gray-700 mb-1">Priorit√§t</label>
          <input 
            type="number" 
            name="priority" 
            value="0" 
            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
          />
          <p class="text-xs text-gray-500 mt-1">H√∂here Werte = weiter oben bei PIN/PUSH</p>
        </div>

        <div class="flex gap-3 pt-4">
          <button 
            type="submit" 
            class="flex-1 px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors font-medium"
          >
            Speichern
          </button>
          <button 
            type="button" 
            id="cancel-modal" 
            class="flex-1 px-4 py-2 bg-white border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium"
          >
            Abbrechen
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Quick Action Modal (BOOST/REPLACE/PUSH) -->
  <div id="quick-action-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-sm">
      <div class="p-6 border-b border-gray-100">
        <h3 class="text-lg font-bold text-gray-900" id="quick-modal-title">Aktion</h3>
        <p class="text-sm text-gray-500 mt-1">Begriff: <span id="quick-modal-term" class="font-medium">-</span></p>
      </div>
      
      <form id="quick-action-form" class="p-6 space-y-4">
        <input type="hidden" name="term" />
        <input type="hidden" name="action" />
        
        <div id="quick-priority-field" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-1">Priorit√§t</label>
          <input 
            type="number" 
            name="priority" 
            value="50" 
            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
          />
        </div>

        <div id="quick-replacement-field" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-1">Ersetzen durch</label>
          <input 
            type="text" 
            name="replacement" 
            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            placeholder="Neuer Begriff"
          />
        </div>

        <div class="flex gap-3">
          <button 
            type="submit" 
            class="flex-1 px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors font-medium"
          >
            Anwenden
          </button>
          <button 
            type="button" 
            id="cancel-quick-modal" 
            class="flex-1 px-4 py-2 bg-white border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium"
          >
            Abbrechen
          </button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<script is:inline define:vars={{ API_URL }}>
  // State
  let currentAbortController = null;
  let lastCreatedOverrideId = null;
  let undoTimeout = null;
  let inputDebounce = null;

  // API helper
  async function adminApi(method, endpoint, body = null, options = {}) {
    const token = localStorage.getItem('auth_token');
    const config = {
      method,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      ...options
    };
    
    if (body) {
      config.body = JSON.stringify(body);
    }
    
    const res = await fetch(`${API_URL}/api${endpoint}`, config);
    
    if (!res.ok) {
      const error = await res.json().catch(() => ({ error: 'Request failed' }));
      const err = new Error(error.error || error.message || 'Request failed');
      err.status = res.status;
      err.data = error;
      throw err;
    }
    
    return res.json();
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }

  // Stats
  async function loadStats() {
    try {
      const stats = await adminApi('GET', '/admin/trends/stats');
      document.getElementById('stat-searches').textContent = stats.totalSearches?.toLocaleString() || '0';
      document.getElementById('stat-unique').textContent = stats.uniqueTerms?.toLocaleString() || '0';
      
      if (stats.lastComputed) {
        const date = new Date(stats.lastComputed);
        const formatted = date.toLocaleString('de-DE', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        document.getElementById('stat-computed').textContent = formatted;
        document.getElementById('last-computed-header').textContent = formatted;
      }
    } catch (error) {
      console.error('Failed to load stats:', error);
    }
  }

  // Trending Terms
  async function loadTrendingTerms() {
    try {
      const data = await adminApi('GET', '/admin/trends/terms');
      const tbody = document.getElementById('trending-table-body');
      
      if (!data.data || data.data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-400">Keine Trending-Begriffe gefunden</td></tr>';
        return;
      }
      
      tbody.innerHTML = data.data.map((t, idx) => `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 text-gray-500 font-medium">${idx + 1}</td>
          <td class="px-4 py-3 font-medium text-gray-900">${escapeHtml(t.term)}</td>
          <td class="px-4 py-3 text-gray-600">${t.searches24h || t.searchCount || 0}</td>
          <td class="px-4 py-3 text-right">
            <div class="flex items-center justify-end gap-1">
              <button class="action-btn action-pin" data-action="pin" data-term="${escapeHtml(t.term)}" title="Fixieren">PIN</button>
              <button class="action-btn action-hide" data-action="hide" data-term="${escapeHtml(t.term)}" title="Verstecken">HIDE</button>
              <button class="action-btn action-boost" data-action="boost" data-term="${escapeHtml(t.term)}" title="Boosten">BOOST</button>
              <button class="action-btn action-replace" data-action="replace" data-term="${escapeHtml(t.term)}" title="Ersetzen">REPLACE</button>
              <button class="action-btn action-push" data-action="push" data-term="${escapeHtml(t.term)}" title="Pushen">PUSH</button>
            </div>
          </td>
        </tr>
      `).join('');
    } catch (error) {
      console.error('Failed to load trending terms:', error);
      document.getElementById('trending-table-body').innerHTML = 
        '<tr><td colspan="4" class="px-4 py-8 text-center text-red-500">Fehler beim Laden</td></tr>';
    }
  }

  // Preview
  function showPreviewLoading(show) {
    document.getElementById('preview-loading')?.classList.toggle('hidden', !show);
  }

  async function updatePreview() {
    if (currentAbortController) {
      currentAbortController.abort();
    }
    currentAbortController = new AbortController();
    
    const query = document.getElementById('preview-query')?.value || '';
    const hideOverrides = document.getElementById('hide-overrides')?.checked;
    
    showPreviewLoading(true);
    
    try {
      const params = new URLSearchParams({
        q: query,
        applyOverrides: (!hideOverrides).toString()
      });
      
      const data = await adminApi('GET', `/admin/trends/preview?${params}`, null, {
        signal: currentAbortController.signal
      });
      
      renderPreview(data.preview, data.debug);
    } catch (error) {
      if (error.name !== 'AbortError') {
        console.error('Preview error:', error);
      }
    } finally {
      showPreviewLoading(false);
    }
  }

  function renderPreview(preview, debug) {
    // Suggestions
    const suggestionsHtml = (preview?.suggestions || []).map(s => `
      <div class="flex items-center px-4 py-3 hover:bg-gray-50 group">
        <svg class="w-5 h-5 text-gray-400 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <span class="text-gray-700 truncate flex-1">${escapeHtml(s.text)}</span>
        <span class="source-badge source-${s.source || 'log'}">${getSourceLabel(s.source)}</span>
      </div>
    `).join('');
    
    document.getElementById('preview-suggestions-list').innerHTML = 
      suggestionsHtml || '<div class="px-4 py-3 text-gray-400 text-sm">Keine Vorschl√§ge</div>';
    
    // Trending
    const trendingHtml = (preview?.trending || []).map(t => `
      <div class="flex items-center px-4 py-3 hover:bg-gray-50 group">
        <span class="text-lg mr-3">${t.badge || 'üî•'}</span>
        <span class="text-gray-700 font-medium truncate flex-1">${escapeHtml(t.text)}</span>
        <span class="source-badge source-${t.source || 'trending'}">${getSourceLabel(t.source)}</span>
      </div>
    `).join('');
    
    document.getElementById('preview-trending-list').innerHTML = 
      trendingHtml || '<div class="px-4 py-3 text-gray-400 text-sm">Keine Trending-Begriffe</div>';
    
    // Debug
    if (debug) {
      document.getElementById('preview-debug').textContent = 
        `${debug.baseSuggestionsCount || 0} Vorschl√§ge, ${debug.baseTrendingCount || 0} Trending, ${debug.overridesApplied || 0} Overrides`;
    }
  }

  function getSourceLabel(source) {
    const labels = {
      'log': 'Suche',
      'entity': 'Kategorie',
      'event': 'Event',
      'override_pin': 'PIN',
      'override_push': 'PUSH',
      'override_replace': 'ERSETZT',
      'override_boost': 'BOOST',
      'trending': 'Trend'
    };
    return labels[source] || source || 'Suche';
  }

  // Overrides
  async function loadOverrides() {
    try {
      const data = await adminApi('GET', '/admin/trends/overrides');
      const tbody = document.getElementById('overrides-table-body');
      
      if (!data.data || data.data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-400">Keine Overrides definiert</td></tr>';
        return;
      }
      
      tbody.innerHTML = data.data.map(o => `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 font-medium text-gray-900">${escapeHtml(o.term)}</td>
          <td class="px-4 py-3">
            <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full action-badge-${o.action.toLowerCase()}">${o.action}</span>
          </td>
          <td class="px-4 py-3 text-gray-600">${o.replacement ? escapeHtml(o.replacement) : '-'}</td>
          <td class="px-4 py-3 text-gray-600">${o.priority || 0}</td>
          <td class="px-4 py-3 text-right">
            <div class="flex items-center justify-end gap-2">
              <button class="text-primary-600 hover:text-primary-700 text-sm font-medium" data-action="edit-override" data-id="${o.id}">Bearbeiten</button>
              <button class="text-red-600 hover:text-red-700 text-sm font-medium" data-action="delete-override" data-id="${o.id}">L√∂schen</button>
            </div>
          </td>
        </tr>
      `).join('');
    } catch (error) {
      console.error('Failed to load overrides:', error);
      document.getElementById('overrides-table-body').innerHTML = 
        '<tr><td colspan="5" class="px-4 py-8 text-center text-red-500">Fehler beim Laden</td></tr>';
    }
  }

  // Quick Actions
  async function quickAction(action, term) {
    showPreviewLoading(true);
    
    try {
      const result = await adminApi('POST', '/admin/trends/overrides', {
        term,
        action,
        priority: action === 'PIN' ? 100 : 0
      });
      
      lastCreatedOverrideId = result.data?.id;
      showUndoToast(`"${term}" ‚Üí ${action}`);
      await Promise.all([updatePreview(), loadOverrides()]);
    } catch (error) {
      if (error.status === 409) {
        showNotification('Override existiert bereits', 'error');
      } else {
        showNotification('Fehler: ' + error.message, 'error');
      }
    } finally {
      showPreviewLoading(false);
    }
  }

  // Undo
  function showUndoToast(message) {
    const toast = document.getElementById('undo-toast');
    document.getElementById('undo-message').textContent = message;
    toast.classList.remove('hidden');
    
    clearTimeout(undoTimeout);
    undoTimeout = setTimeout(hideUndoToast, 5000);
  }

  function hideUndoToast() {
    document.getElementById('undo-toast').classList.add('hidden');
    clearTimeout(undoTimeout);
  }

  async function undoLastAction() {
    if (!lastCreatedOverrideId) return;
    
    try {
      await adminApi('DELETE', `/admin/trends/overrides/${lastCreatedOverrideId}?hard=true`);
      lastCreatedOverrideId = null;
      hideUndoToast();
      await Promise.all([updatePreview(), loadOverrides()]);
      showNotification('R√ºckg√§ngig gemacht', 'success');
    } catch (error) {
      showNotification('Undo fehlgeschlagen', 'error');
    }
  }

  function showNotification(message, type = 'info') {
    // Simple notification
    const colors = {
      success: 'bg-green-500',
      error: 'bg-red-500',
      info: 'bg-blue-500'
    };
    
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.remove(), 3000);
  }

  // Modal handling
  function openOverrideModal(data = null) {
    const modal = document.getElementById('override-modal');
    const form = document.getElementById('override-form');
    const title = document.getElementById('modal-title');
    
    form.reset();
    
    if (data) {
      title.textContent = 'Override bearbeiten';
      form.querySelector('[name="id"]').value = data.id || '';
      form.querySelector('[name="term"]').value = data.term || '';
      form.querySelector('[name="action"]').value = data.action || 'PIN';
      form.querySelector('[name="replacement"]').value = data.replacement || '';
      form.querySelector('[name="priority"]').value = data.priority || 0;
    } else {
      title.textContent = 'Neuer Override';
    }
    
    updateFieldVisibility();
    modal.classList.remove('hidden');
  }

  function closeOverrideModal() {
    document.getElementById('override-modal').classList.add('hidden');
  }

  function updateFieldVisibility() {
    const action = document.querySelector('#override-form [name="action"]').value;
    document.getElementById('replacement-field').classList.toggle('hidden', action !== 'REPLACE');
  }

  function openQuickActionModal(action, term) {
    const modal = document.getElementById('quick-action-modal');
    const form = document.getElementById('quick-action-form');
    
    document.getElementById('quick-modal-title').textContent = action + ' Aktion';
    document.getElementById('quick-modal-term').textContent = term;
    
    form.querySelector('[name="term"]').value = term;
    form.querySelector('[name="action"]').value = action;
    
    document.getElementById('quick-priority-field').classList.toggle('hidden', action === 'REPLACE');
    document.getElementById('quick-replacement-field').classList.toggle('hidden', action !== 'REPLACE');
    
    modal.classList.remove('hidden');
  }

  function closeQuickActionModal() {
    document.getElementById('quick-action-modal').classList.add('hidden');
  }

  // Event handlers
  function setupEventHandlers() {
    // Tab switching
    document.querySelectorAll('.main-tab').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        
        document.querySelectorAll('.main-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.getElementById(`tab-${tab}`)?.classList.remove('hidden');
        
        // Load data for the tab
        if (tab === 'stats') {
          loadStats();
          loadTrendingTerms();
        } else if (tab === 'preview') {
          updatePreview();
        } else if (tab === 'overrides') {
          loadOverrides();
        }
      });
    });

    // Device toggle
    document.querySelectorAll('.device-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.device-toggle').forEach(b => b.classList.remove('bg-gray-100', 'font-medium'));
        btn.classList.add('bg-gray-100', 'font-medium');
        
        const container = document.getElementById('preview-container');
        const device = btn.dataset.device;
        container.classList.remove('preview-mobile', 'preview-desktop');
        container.classList.add(`preview-${device}`);
      });
    });

    // Preview controls
    document.getElementById('hide-overrides')?.addEventListener('change', updatePreview);
    document.getElementById('preview-refresh')?.addEventListener('click', updatePreview);
    
    document.getElementById('preview-query')?.addEventListener('input', () => {
      clearTimeout(inputDebounce);
      inputDebounce = setTimeout(updatePreview, 300);
    });

    // Compute trends
    document.getElementById('compute-trends-btn')?.addEventListener('click', async () => {
      if (!confirm('Trends jetzt neu berechnen?')) return;
      
      try {
        document.getElementById('compute-trends-btn').disabled = true;
        await adminApi('POST', '/admin/trends/compute', {});
        showNotification('Trends wurden neu berechnet!', 'success');
        loadStats();
        loadTrendingTerms();
        updatePreview();
      } catch (error) {
        showNotification('Fehler bei der Berechnung', 'error');
      } finally {
        document.getElementById('compute-trends-btn').disabled = false;
      }
    });

    // Undo
    document.getElementById('undo-btn')?.addEventListener('click', undoLastAction);
    document.getElementById('close-toast')?.addEventListener('click', hideUndoToast);

    // Override modal
    document.getElementById('create-override-btn')?.addEventListener('click', () => openOverrideModal());
    document.getElementById('cancel-modal')?.addEventListener('click', closeOverrideModal);
    
    document.querySelector('#override-form [name="action"]')?.addEventListener('change', updateFieldVisibility);
    
    document.getElementById('override-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const data = {};
      formData.forEach((value, key) => {
        if (value) data[key] = value;
      });
      
      try {
        if (data.id) {
          await adminApi('PATCH', `/admin/trends/overrides/${data.id}`, data);
          showNotification('Override aktualisiert', 'success');
        } else {
          const result = await adminApi('POST', '/admin/trends/overrides', data);
          lastCreatedOverrideId = result.data?.id;
          showUndoToast(`Override erstellt: ${data.term}`);
        }
        
        closeOverrideModal();
        loadOverrides();
        updatePreview();
      } catch (error) {
        showNotification('Fehler: ' + (error.data?.error || error.message), 'error');
      }
    });

    // Quick action modal
    document.getElementById('cancel-quick-modal')?.addEventListener('click', closeQuickActionModal);
    
    document.getElementById('quick-action-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const data = {};
      formData.forEach((value, key) => {
        if (value) data[key] = value;
      });
      
      try {
        const result = await adminApi('POST', '/admin/trends/overrides', data);
        lastCreatedOverrideId = result.data?.id;
        showUndoToast(`${data.action}: ${data.term}`);
        closeQuickActionModal();
        loadOverrides();
        updatePreview();
      } catch (error) {
        showNotification('Fehler: ' + (error.data?.error || error.message), 'error');
      }
    });

    // Delegated click handlers
    document.addEventListener('click', async (e) => {
      const target = e.target.closest('[data-action]');
      if (!target) return;
      
      const action = target.dataset.action;
      const term = target.dataset.term;
      const id = target.dataset.id;
      
      switch (action) {
        case 'pin':
          await quickAction('PIN', term);
          break;
        case 'hide':
          await quickAction('HIDE', term);
          break;
        case 'boost':
        case 'push':
          openQuickActionModal(action.toUpperCase(), term);
          break;
        case 'replace':
          openQuickActionModal('REPLACE', term);
          break;
        case 'edit-override':
          try {
            const data = await adminApi('GET', '/admin/trends/overrides');
            const override = data.data.find(o => o.id === id);
            if (override) openOverrideModal(override);
          } catch (error) {
            showNotification('Fehler beim Laden', 'error');
          }
          break;
        case 'delete-override':
          if (confirm('Override wirklich l√∂schen?')) {
            try {
              await adminApi('DELETE', `/admin/trends/overrides/${id}`);
              showNotification('Override gel√∂scht', 'success');
              loadOverrides();
              updatePreview();
            } catch (error) {
              showNotification('Fehler beim L√∂schen', 'error');
            }
          }
          break;
      }
    });

    // Close modals on backdrop click
    document.getElementById('override-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeOverrideModal();
    });
    
    document.getElementById('quick-action-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeQuickActionModal();
    });
  }

  // Initialize
  function init() {
    setupEventHandlers();
    loadStats();
    loadTrendingTerms();
  }

  // Wait for DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>

<style>
  /* Tab styles */
  .main-tab {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 1.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }

  .main-tab:hover {
    color: #374151;
    background-color: #f9fafb;
  }

  .main-tab.active {
    color: #4f46e5;
    border-bottom-color: #4f46e5;
  }

  /* Preview device modes */
  .preview-mobile .preview-inner {
    max-width: 375px;
  }

  .preview-desktop .preview-inner {
    max-width: 600px;
  }

  /* Source badges */
  .source-badge {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    white-space: nowrap;
    font-weight: 500;
  }

  .source-log, .source-trending {
    background: #dbeafe;
    color: #1d4ed8;
  }

  .source-entity, .source-category {
    background: #dcfce7;
    color: #15803d;
  }

  .source-override_pin, .source-override_push, .source-override_boost, .source-override_replace {
    background: #fef3c7;
    color: #b45309;
  }

  .source-event {
    background: #f3e8ff;
    color: #7c3aed;
  }

  /* Action buttons */
  .action-btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.625rem;
    font-weight: 600;
    border-radius: 0.25rem;
    transition: all 0.15s;
  }

  .action-pin {
    background: #dbeafe;
    color: #1d4ed8;
  }
  .action-pin:hover {
    background: #bfdbfe;
  }

  .action-hide {
    background: #fee2e2;
    color: #dc2626;
  }
  .action-hide:hover {
    background: #fecaca;
  }

  .action-boost {
    background: #d1fae5;
    color: #059669;
  }
  .action-boost:hover {
    background: #a7f3d0;
  }

  .action-replace {
    background: #fef3c7;
    color: #d97706;
  }
  .action-replace:hover {
    background: #fde68a;
  }

  .action-push {
    background: #e0e7ff;
    color: #4f46e5;
  }
  .action-push:hover {
    background: #c7d2fe;
  }

  /* Override action badges */
  .action-badge-pin {
    background: #dbeafe;
    color: #1d4ed8;
  }

  .action-badge-hide {
    background: #fee2e2;
    color: #dc2626;
  }

  .action-badge-boost {
    background: #d1fae5;
    color: #059669;
  }

  .action-badge-replace {
    background: #fef3c7;
    color: #d97706;
  }

  .action-badge-push {
    background: #e0e7ff;
    color: #4f46e5;
  }

  /* Animation */
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(-0.5rem);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.2s ease-out;
  }
</style>


