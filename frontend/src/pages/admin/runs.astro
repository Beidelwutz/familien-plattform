---
import BaseLayout from '../../layouts/BaseLayout.astro';
import StickyHeader from '../../components/layout/StickyHeader.astro';

const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:4000';
---

<BaseLayout title="Ingest-Runs - Admin - kiezling">
  <StickyHeader />
  <main class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <header class="mb-6">
        <a href="/admin" class="text-sm text-primary-500 hover:text-primary-600 font-medium mb-2 inline-block">&larr; Zur√ºck zum Dashboard</a>
        <h1 class="text-2xl font-bold text-gray-900">Ingest-Runs</h1>
        <p class="text-gray-500">Import-Jobs √ºberwachen und Fehler beheben</p>
      </header>

      <!-- Filters -->
      <div class="flex flex-wrap gap-3 mb-6">
        <select id="status-filter" class="px-4 py-2 border-2 border-gray-200 rounded-lg bg-white text-sm">
          <option value="">Alle Status</option>
          <option value="running">Laufend</option>
          <option value="success">Erfolgreich</option>
          <option value="partial">Teilweise</option>
          <option value="failed">Fehlgeschlagen</option>
        </select>
        <label class="flex items-center gap-2 px-4 py-2 bg-white border-2 border-gray-200 rounded-lg text-sm cursor-pointer">
          <input type="checkbox" id="attention-filter" class="rounded">
          <span>Nur Aufmerksamkeit erforderlich</span>
        </label>
        <button id="refresh-btn" class="px-4 py-2 bg-white border-2 border-gray-200 rounded-lg text-sm hover:bg-gray-50">
          üîÑ Aktualisieren
        </button>
        <span id="run-count" class="ml-auto text-sm text-gray-500 self-center"></span>
      </div>

      <!-- Attention Banner -->
      <div id="attention-banner" class="hidden mb-6 bg-orange-50 border border-orange-200 rounded-xl p-4">
        <div class="flex items-center gap-3">
          <span class="text-2xl">‚ö†Ô∏è</span>
          <div>
            <p class="font-medium text-orange-800"><span id="attention-count">0</span> Runs ben√∂tigen Aufmerksamkeit</p>
            <p class="text-sm text-orange-600">Diese Runs sind fehlgeschlagen und wurden nicht automatisch gel√∂st.</p>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loading-state" class="text-center py-12">
        <div class="animate-spin inline-block w-8 h-8 border-4 border-primary-500 border-t-transparent rounded-full"></div>
        <p class="text-gray-500 mt-4">Lade Runs...</p>
      </div>

      <!-- Runs Table -->
      <div class="bg-white rounded-xl shadow-sm overflow-hidden hidden" id="runs-table">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Correlation-ID</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quelle</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Events</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Zeit</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aktionen</th>
              </tr>
            </thead>
            <tbody id="runs-tbody" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="hidden text-center py-12">
        <p class="text-gray-500 text-lg">Keine Runs gefunden</p>
      </div>

      <!-- Error Detail Modal -->
      <div class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4" id="error-modal">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
          <div class="p-4 border-b flex items-center justify-between">
            <h3 class="font-semibold">Fehlerdetails</h3>
            <button id="modal-close" class="text-2xl text-gray-400 hover:text-gray-600">&times;</button>
          </div>
          <div class="p-4 overflow-y-auto flex-1">
            <div class="mb-4">
              <span class="text-sm text-gray-500">Correlation-ID:</span>
              <code id="modal-correlation" class="block bg-gray-100 px-2 py-1 rounded mt-1 text-sm font-mono"></code>
            </div>
            <div class="mb-4">
              <span class="text-sm text-gray-500">Fehlermeldung:</span>
              <pre id="modal-error" class="block bg-red-50 text-red-700 px-3 py-2 rounded mt-1 text-sm overflow-x-auto whitespace-pre-wrap"></pre>
            </div>
            <div id="modal-details-section" class="hidden">
              <span class="text-sm text-gray-500">Details:</span>
              <pre id="modal-details" class="block bg-gray-100 px-3 py-2 rounded mt-1 text-sm overflow-x-auto"></pre>
            </div>
          </div>
          <div class="p-4 border-t">
            <button id="acknowledge-btn" class="w-full px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600">
              ‚úì Als bearbeitet markieren
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<script is:inline define:vars={{ API_URL }}>
  let runs = [];
  let currentRunId = null;
  const token = localStorage.getItem('auth_token');

  // Auth check
  if (!token) {
    window.location.href = '/login?redirect=/admin/runs';
  }

  // Fetch helper
  async function apiFetch(endpoint, options = {}) {
    const res = await fetch(`${API_URL}${endpoint}`, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
        ...options.headers,
      },
    });
    if (res.status === 401 || res.status === 403) {
      localStorage.removeItem('auth_token');
      window.location.href = '/login?redirect=/admin/runs';
      throw new Error('Unauthorized');
    }
    return res.json();
  }

  // Load runs
  async function loadRuns() {
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('runs-table').classList.add('hidden');
    document.getElementById('empty-state').classList.add('hidden');

    try {
      const params = new URLSearchParams({ limit: '50' });
      const status = document.getElementById('status-filter').value;
      const attention = document.getElementById('attention-filter').checked;
      
      if (status) params.set('status', status);
      if (attention) params.set('needs_attention', 'true');

      const data = await apiFetch(`/api/admin/ingest-runs?${params}`);
      runs = data.data || [];
      
      document.getElementById('run-count').textContent = `${runs.length} Runs`;

      // Check attention count
      const attentionCount = runs.filter(r => r.needs_attention).length;
      if (attentionCount > 0) {
        document.getElementById('attention-count').textContent = attentionCount;
        document.getElementById('attention-banner').classList.remove('hidden');
      } else {
        document.getElementById('attention-banner').classList.add('hidden');
      }

      if (runs.length === 0) {
        document.getElementById('empty-state').classList.remove('hidden');
      } else {
        renderRuns();
        document.getElementById('runs-table').classList.remove('hidden');
      }
    } catch (e) {
      console.error('Load error:', e);
      document.getElementById('empty-state').classList.remove('hidden');
      document.getElementById('empty-state').innerHTML = '<p class="text-red-500">Fehler beim Laden</p>';
    } finally {
      document.getElementById('loading-state').classList.add('hidden');
    }
  }

  // Render runs table
  function renderRuns() {
    const tbody = document.getElementById('runs-tbody');
    
    const statusColors = {
      running: 'bg-blue-100 text-blue-700',
      success: 'bg-green-100 text-green-700',
      partial: 'bg-yellow-100 text-yellow-700',
      failed: 'bg-red-100 text-red-700',
    };
    const statusLabels = {
      running: 'Laufend',
      success: 'Erfolgreich',
      partial: 'Teilweise',
      failed: 'Fehlgeschlagen',
    };

    tbody.innerHTML = runs.map(run => {
      const formatDate = d => d ? new Date(d).toLocaleString('de-DE', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : '-';
      const duration = run.finished_at && run.started_at 
        ? Math.round((new Date(run.finished_at) - new Date(run.started_at)) / 1000) + 's'
        : '-';

      return `
        <tr class="${run.needs_attention ? 'bg-orange-50' : ''}">
          <td class="px-4 py-3">
            <div class="flex items-center gap-2">
              <span class="px-2 py-1 text-xs rounded-full ${statusColors[run.status] || 'bg-gray-100'}">
                ${statusLabels[run.status] || run.status}
              </span>
              ${run.needs_attention ? '<span class="text-orange-500" title="Braucht Aufmerksamkeit">‚ö†Ô∏è</span>' : ''}
            </div>
          </td>
          <td class="px-4 py-3">
            <code class="text-xs bg-gray-100 px-1 py-0.5 rounded">${run.correlation_id}</code>
          </td>
          <td class="px-4 py-3 text-sm">
            ${run.source?.name || '-'}
          </td>
          <td class="px-4 py-3 text-sm">
            <span title="Gefunden">${run.events_found}</span> /
            <span class="text-green-600" title="Erstellt">${run.events_created}</span> /
            <span class="text-blue-600" title="Aktualisiert">${run.events_updated}</span> /
            <span class="text-gray-400" title="√úbersprungen">${run.events_skipped}</span>
          </td>
          <td class="px-4 py-3 text-sm text-gray-500">
            ${formatDate(run.started_at)}
            <span class="text-xs text-gray-400">(${duration})</span>
          </td>
          <td class="px-4 py-3">
            ${run.error_message 
              ? `<button class="error-btn text-red-600 hover:text-red-800 text-sm" data-id="${run.id}">Fehler anzeigen</button>`
              : '<span class="text-gray-400 text-sm">-</span>'
            }
          </td>
        </tr>
      `;
    }).join('');

    // Error button handlers
    tbody.querySelectorAll('.error-btn').forEach(btn => {
      btn.addEventListener('click', () => openErrorModal(btn.dataset.id));
    });
  }

  // Open error modal
  function openErrorModal(id) {
    currentRunId = id;
    const run = runs.find(r => r.id === id);
    if (!run) return;

    document.getElementById('modal-correlation').textContent = run.correlation_id;
    document.getElementById('modal-error').textContent = run.error_message || 'Keine Fehlermeldung';

    if (run.error_details) {
      document.getElementById('modal-details').textContent = JSON.stringify(run.error_details, null, 2);
      document.getElementById('modal-details-section').classList.remove('hidden');
    } else {
      document.getElementById('modal-details-section').classList.add('hidden');
    }

    // Show/hide acknowledge button
    document.getElementById('acknowledge-btn').classList.toggle('hidden', !run.needs_attention);

    document.getElementById('error-modal').classList.remove('hidden');
    document.getElementById('error-modal').classList.add('flex');
  }

  // Close modal
  function closeModal() {
    document.getElementById('error-modal').classList.add('hidden');
    document.getElementById('error-modal').classList.remove('flex');
    currentRunId = null;
  }

  // Acknowledge run
  async function acknowledgeRun() {
    if (!currentRunId) return;

    const btn = document.getElementById('acknowledge-btn');
    btn.disabled = true;
    btn.textContent = 'Wird gespeichert...';

    try {
      await apiFetch(`/api/admin/ingest-runs/${currentRunId}/acknowledge`, { method: 'POST' });
      closeModal();
      loadRuns();
    } catch (e) {
      alert('Fehler: ' + e.message);
    } finally {
      btn.disabled = false;
      btn.textContent = '‚úì Als bearbeitet markieren';
    }
  }

  // Event listeners
  document.getElementById('status-filter').addEventListener('change', loadRuns);
  document.getElementById('attention-filter').addEventListener('change', loadRuns);
  document.getElementById('refresh-btn').addEventListener('click', loadRuns);
  document.getElementById('modal-close').addEventListener('click', closeModal);
  document.getElementById('acknowledge-btn').addEventListener('click', acknowledgeRun);
  document.getElementById('error-modal').addEventListener('click', (e) => {
    if (e.target.id === 'error-modal') closeModal();
  });

  // Initial load
  loadRuns();
</script>
