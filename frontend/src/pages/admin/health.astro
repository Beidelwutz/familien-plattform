---
import BaseLayout from "../../layouts/BaseLayout.astro";
import StickyHeader from "../../components/layout/StickyHeader.astro";

const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:4000";
const WORKER_URL = import.meta.env.PUBLIC_AI_WORKER_URL || "http://localhost:5000";
---

<BaseLayout title="System Health - Admin - kiezling">
  <StickyHeader />
  <main class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <header class="mb-6 flex justify-between items-start">
        <div>
          <a href="/admin" class="text-sm text-primary-500 hover:text-primary-600 font-medium mb-2 inline-block">&larr; Zurück zum Dashboard</a>
          <h1 class="text-2xl font-bold text-gray-900">System Health</h1>
          <p class="text-gray-500">Übersicht aller Systemkomponenten</p>
        </div>
        <button id="refresh-btn" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition text-sm font-medium">
          Aktualisieren
        </button>
      </header>

      <!-- Overall Status -->
      <div id="overall-status" class="mb-6 bg-white rounded-lg shadow p-6">
        <div class="flex items-center gap-4">
          <div id="status-indicator" class="w-4 h-4 rounded-full bg-gray-400"></div>
          <div>
            <div id="status-text" class="text-lg font-semibold">Prüfe Status...</div>
            <div id="status-time" class="text-sm text-gray-500">-</div>
          </div>
        </div>
        <div id="status-issues" class="mt-4 hidden">
          <div class="text-sm font-medium text-gray-700 mb-2">Probleme:</div>
          <ul id="issues-list" class="list-disc list-inside text-sm text-red-600"></ul>
        </div>
      </div>

      <!-- Service Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-900">Backend API</h3>
            <div id="backend-status" class="w-3 h-3 rounded-full bg-gray-400"></div>
          </div>
          <div id="backend-info" class="text-sm text-gray-600">Prüfe...</div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-900">AI Worker</h3>
            <div id="worker-status" class="w-3 h-3 rounded-full bg-gray-400"></div>
          </div>
          <div id="worker-info" class="text-sm text-gray-600">Prüfe...</div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-900">Redis Queue</h3>
            <div id="redis-status" class="w-3 h-3 rounded-full bg-gray-400"></div>
          </div>
          <div id="redis-info" class="text-sm text-gray-600">Prüfe...</div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-900">Database</h3>
            <div id="db-status" class="w-3 h-3 rounded-full bg-gray-400"></div>
          </div>
          <div id="db-info" class="text-sm text-gray-600">Prüfe...</div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-900">OpenAI API</h3>
            <div id="openai-status" class="w-3 h-3 rounded-full bg-gray-400"></div>
          </div>
          <div id="openai-info" class="text-sm text-gray-600">Prüfe...</div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-900">AI Budget</h3>
            <div id="budget-status" class="w-3 h-3 rounded-full bg-gray-400"></div>
          </div>
          <div id="budget-info" class="text-sm text-gray-600">Prüfe...</div>
        </div>
      </div>

      <!-- Queue Stats -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="font-semibold text-gray-900 mb-4">Queue Status</h3>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
          <div class="text-center p-4 bg-gray-50 rounded">
            <div id="queue-crawl" class="text-2xl font-bold text-gray-900">-</div>
            <div class="text-sm text-gray-500">Crawl</div>
          </div>
          <div class="text-center p-4 bg-gray-50 rounded">
            <div id="queue-classify" class="text-2xl font-bold text-gray-900">-</div>
            <div class="text-sm text-gray-500">Classify</div>
          </div>
          <div class="text-center p-4 bg-gray-50 rounded">
            <div id="queue-score" class="text-2xl font-bold text-gray-900">-</div>
            <div class="text-sm text-gray-500">Score</div>
          </div>
          <div class="text-center p-4 bg-gray-50 rounded">
            <div id="queue-geocode" class="text-2xl font-bold text-gray-900">-</div>
            <div class="text-sm text-gray-500">Geocode</div>
          </div>
          <div class="text-center p-4 bg-red-50 rounded">
            <div id="queue-dlq" class="text-2xl font-bold text-red-600">-</div>
            <div class="text-sm text-gray-500">DLQ</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script is:inline define:vars={{ API_URL, WORKER_URL }}>
    const workerUrl = WORKER_URL;

    function setStatus(elementId, status) {
      const el = document.getElementById(elementId);
      if (!el) return;
      el.className = 'w-3 h-3 rounded-full';
      switch (status) {
        case 'ok': el.classList.add('bg-green-500'); break;
        case 'warning': el.classList.add('bg-yellow-500'); break;
        case 'error': el.classList.add('bg-red-500'); break;
        default: el.classList.add('bg-gray-400');
      }
    }

    async function checkHealth() {
      const issues = [];
      let overallStatus = 'healthy';

      // Check Backend
      try {
        const backendRes = await fetch(`${API_URL}/api/health`);
        const backendData = await backendRes.json();
        
        setStatus('backend-status', backendData.status === 'ok' ? 'ok' : 'warning');
        document.getElementById('backend-info').textContent = backendData.status === 'ok' ? 'Online' : 'Probleme';
        
        if (backendData.services?.database?.status === 'ok') {
          setStatus('db-status', 'ok');
          document.getElementById('db-info').textContent = 'Verbunden';
        } else {
          setStatus('db-status', 'error');
          document.getElementById('db-info').textContent = 'Nicht erreichbar';
          issues.push('Datenbank nicht erreichbar');
          overallStatus = 'degraded';
        }
      } catch (e) {
        setStatus('backend-status', 'error');
        document.getElementById('backend-info').textContent = 'Nicht erreichbar';
        setStatus('db-status', 'error');
        document.getElementById('db-info').textContent = 'Unbekannt';
        issues.push('Backend API nicht erreichbar');
        overallStatus = 'unhealthy';
      }

      // Check Worker
      try {
        const workerRes = await fetch(`${workerUrl}/health/ready`);
        const workerData = await workerRes.json();
        
        if (workerData.status === 'ok') {
          setStatus('worker-status', 'ok');
          document.getElementById('worker-info').textContent = 'Online';
        } else {
          setStatus('worker-status', 'warning');
          document.getElementById('worker-info').textContent = 'Degradiert';
          overallStatus = 'degraded';
        }
        
        if (workerData.checks?.redis?.status === 'ok') {
          setStatus('redis-status', 'ok');
          document.getElementById('redis-info').textContent = 'Verbunden';
        } else {
          setStatus('redis-status', 'warning');
          document.getElementById('redis-info').textContent = 'Nicht verbunden';
        }
        
        if (workerData.checks?.openai?.status === 'ok') {
          setStatus('openai-status', 'ok');
          document.getElementById('openai-info').textContent = 'Verbunden';
        } else if (workerData.checks?.openai?.status === 'not_configured') {
          setStatus('openai-status', 'warning');
          document.getElementById('openai-info').textContent = 'Nicht konfiguriert';
        } else {
          setStatus('openai-status', 'error');
          document.getElementById('openai-info').textContent = 'Fehler';
        }
      } catch (e) {
        setStatus('worker-status', 'error');
        document.getElementById('worker-info').textContent = 'Nicht erreichbar';
        setStatus('redis-status', 'error');
        document.getElementById('redis-info').textContent = 'Unbekannt';
        setStatus('openai-status', 'error');
        document.getElementById('openai-info').textContent = 'Unbekannt';
        issues.push('AI Worker nicht erreichbar');
        overallStatus = 'unhealthy';
      }

      // Check Metrics
      try {
        const metricsRes = await fetch(`${workerUrl}/metrics`);
        const metrics = await metricsRes.json();
        
        document.getElementById('queue-crawl').textContent = metrics.queues?.depths?.crawl ?? '-';
        document.getElementById('queue-classify').textContent = metrics.queues?.depths?.classify ?? '-';
        document.getElementById('queue-score').textContent = metrics.queues?.depths?.score ?? '-';
        document.getElementById('queue-geocode').textContent = metrics.queues?.depths?.geocode ?? '-';
        document.getElementById('queue-dlq').textContent = metrics.dlq?.count ?? '-';
        
        if (metrics.dlq?.alert) {
          issues.push(`DLQ hat ${metrics.dlq.count} Jobs`);
          overallStatus = 'degraded';
        }
        
        if (metrics.budget) {
          const budgetStatus = metrics.budget.status;
          if (budgetStatus === 'ok') {
            setStatus('budget-status', 'ok');
            document.getElementById('budget-info').textContent = `${metrics.budget.daily?.percent_used || 0}% verbraucht`;
          } else if (budgetStatus === 'exceeded') {
            setStatus('budget-status', 'error');
            document.getElementById('budget-info').textContent = 'Budget überschritten!';
            issues.push('AI Budget überschritten');
            overallStatus = 'degraded';
          } else {
            setStatus('budget-status', 'warning');
            document.getElementById('budget-info').textContent = 'Budget kritisch';
          }
        }
      } catch (e) {
        // Metrics not available
      }

      // Update overall status
      const statusIndicator = document.getElementById('status-indicator');
      const statusText = document.getElementById('status-text');
      
      if (statusIndicator) {
        statusIndicator.className = 'w-4 h-4 rounded-full';
        if (overallStatus === 'healthy') {
          statusIndicator.classList.add('bg-green-500');
          statusText.textContent = 'Alle Systeme operational';
          statusText.className = 'text-lg font-semibold text-green-600';
        } else if (overallStatus === 'degraded') {
          statusIndicator.classList.add('bg-yellow-500');
          statusText.textContent = 'System eingeschränkt';
          statusText.className = 'text-lg font-semibold text-yellow-600';
        } else {
          statusIndicator.classList.add('bg-red-500');
          statusText.textContent = 'System nicht verfügbar';
          statusText.className = 'text-lg font-semibold text-red-600';
        }
      }

      const issuesSection = document.getElementById('status-issues');
      const issuesList = document.getElementById('issues-list');
      if (issues.length > 0 && issuesSection && issuesList) {
        issuesSection.classList.remove('hidden');
        issuesList.innerHTML = issues.map(i => `<li>${i}</li>`).join('');
      } else if (issuesSection) {
        issuesSection.classList.add('hidden');
      }

      document.getElementById('status-time').textContent = new Date().toLocaleTimeString('de-DE');
    }

    document.getElementById('refresh-btn')?.addEventListener('click', checkHealth);
    checkHealth();
    setInterval(checkHealth, 15000);
  </script>
</BaseLayout>
