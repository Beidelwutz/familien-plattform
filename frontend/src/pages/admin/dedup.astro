---
import BaseLayout from '../../layouts/BaseLayout.astro';
import StickyHeader from '../../components/layout/StickyHeader.astro';

const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:4000';
---

<BaseLayout title="Duplikate - Admin - kiezling">
  <StickyHeader />
  <main class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <header class="mb-6">
        <a href="/admin" class="text-sm text-primary-500 hover:text-primary-600 font-medium mb-2 inline-block">&larr; Zur√ºck zum Dashboard</a>
        <h1 class="text-2xl font-bold text-gray-900">Duplikate pr√ºfen</h1>
        <p class="text-gray-500">M√∂gliche Duplikate vergleichen und zusammenf√ºhren</p>
      </header>

      <!-- Filter -->
      <div class="flex gap-3 mb-6">
        <select id="confidence-filter" class="px-4 py-2 border-2 border-gray-200 rounded-lg bg-white text-sm">
          <option value="">Alle Konfidenz-Stufen</option>
          <option value="exact">Exakt</option>
          <option value="likely">Wahrscheinlich</option>
          <option value="maybe">Vielleicht</option>
        </select>
        <button id="refresh-btn" class="px-4 py-2 bg-white border-2 border-gray-200 rounded-lg text-sm hover:bg-gray-50">
          üîÑ Aktualisieren
        </button>
        <span id="dup-count" class="ml-auto text-sm text-gray-500 self-center"></span>
      </div>

      <!-- Loading State -->
      <div id="loading-state" class="text-center py-12">
        <div class="animate-spin inline-block w-8 h-8 border-4 border-primary-500 border-t-transparent rounded-full"></div>
        <p class="text-gray-500 mt-4">Lade Duplikate...</p>
      </div>

      <!-- Duplicate List -->
      <div id="dup-list" class="hidden space-y-6"></div>

      <!-- Empty State -->
      <div id="empty-state" class="hidden text-center py-12">
        <p class="text-4xl mb-4">üéâ</p>
        <p class="text-gray-500 text-lg">Keine offenen Duplikate</p>
      </div>
    </div>
  </main>
</BaseLayout>

<script define:vars={{ API_URL }}>
  let duplicates = [];
  const token = localStorage.getItem('auth_token');

  // Auth check
  if (!token) {
    window.location.href = '/login?redirect=/admin/dedup';
  }

  // Fetch helper
  async function apiFetch(endpoint, options = {}) {
    const res = await fetch(`${API_URL}${endpoint}`, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
        ...options.headers,
      },
    });
    if (res.status === 401 || res.status === 403) {
      localStorage.removeItem('auth_token');
      window.location.href = '/login?redirect=/admin/dedup';
      throw new Error('Unauthorized');
    }
    return res.json();
  }

  // Load duplicates
  async function loadDuplicates() {
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('dup-list').classList.add('hidden');
    document.getElementById('empty-state').classList.add('hidden');

    try {
      const confidence = document.getElementById('confidence-filter').value;
      const params = new URLSearchParams({ status: 'pending', limit: '50' });
      if (confidence) params.set('confidence', confidence);

      const data = await apiFetch(`/api/admin/duplicates?${params}`);
      duplicates = data.data || [];
      
      document.getElementById('dup-count').textContent = `${duplicates.length} Duplikate`;

      if (duplicates.length === 0) {
        document.getElementById('empty-state').classList.remove('hidden');
      } else {
        renderDuplicates();
        document.getElementById('dup-list').classList.remove('hidden');
      }
    } catch (e) {
      console.error('Load error:', e);
      document.getElementById('empty-state').classList.remove('hidden');
      document.getElementById('empty-state').innerHTML = '<p class="text-red-500">Fehler beim Laden</p>';
    } finally {
      document.getElementById('loading-state').classList.add('hidden');
    }
  }

  // Render duplicates
  function renderDuplicates() {
    const list = document.getElementById('dup-list');
    
    list.innerHTML = duplicates.map(dup => {
      const confidenceColors = {
        exact: 'bg-red-100 text-red-700',
        likely: 'bg-orange-100 text-orange-700',
        maybe: 'bg-yellow-100 text-yellow-700',
      };
      const confidenceLabels = {
        exact: 'Exakt',
        likely: 'Wahrscheinlich',
        maybe: 'Vielleicht',
      };

      const formatDate = d => d ? new Date(d).toLocaleString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-';

      return `
        <div class="bg-white rounded-xl shadow-sm overflow-hidden" data-id="${dup.id}">
          <!-- Header -->
          <div class="bg-gray-50 px-4 py-3 flex items-center justify-between border-b">
            <span class="px-3 py-1 text-sm rounded-full ${confidenceColors[dup.confidence]}">
              ${confidenceLabels[dup.confidence]} ${dup.score ? `(${Math.round(dup.score * 100)}%)` : ''}
            </span>
            <span class="text-sm text-gray-500">Erkannt: ${formatDate(dup.detected_at)}</span>
          </div>

          <!-- Side-by-side comparison -->
          <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-gray-200">
            <!-- Event A -->
            <div class="p-4">
              <div class="flex items-start justify-between mb-2">
                <span class="px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded">Event A</span>
              </div>
              <h3 class="font-semibold text-gray-900 mb-2">${dup.event_a.title}</h3>
              <div class="text-sm text-gray-500 space-y-1">
                <p>üìÖ ${formatDate(dup.event_a.start_datetime)}</p>
                <p class="truncate">üìç ${dup.event_a.location_address || '-'}</p>
              </div>
            </div>

            <!-- Event B -->
            <div class="p-4">
              <div class="flex items-start justify-between mb-2">
                <span class="px-2 py-0.5 text-xs bg-purple-100 text-purple-700 rounded">Event B</span>
              </div>
              <h3 class="font-semibold text-gray-900 mb-2">${dup.event_b.title}</h3>
              <div class="text-sm text-gray-500 space-y-1">
                <p>üìÖ ${formatDate(dup.event_b.start_datetime)}</p>
                <p class="truncate">üìç ${dup.event_b.location_address || '-'}</p>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="bg-gray-50 px-4 py-3 flex flex-wrap gap-2 border-t">
            <button class="action-btn px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm" data-action="merge" data-id="${dup.id}">
              ‚úì Zusammenf√ºhren (A behalten)
            </button>
            <button class="action-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm" data-action="different" data-id="${dup.id}">
              ‚úó Unterschiedlich
            </button>
            <button class="action-btn px-4 py-2 text-gray-500 hover:text-gray-700 text-sm" data-action="ignore" data-id="${dup.id}">
              Ignorieren
            </button>
          </div>
        </div>
      `;
    }).join('');

    // Event handlers
    list.querySelectorAll('.action-btn').forEach(btn => {
      btn.addEventListener('click', () => handleAction(btn.dataset.action, btn.dataset.id, btn));
    });
  }

  // Handle actions
  async function handleAction(action, id, btn) {
    const messages = {
      merge: 'Events zusammenf√ºhren? Event A wird behalten, Event B wird archiviert.',
      different: 'Als unterschiedliche Events markieren?',
      ignore: 'Duplikat-Vorschlag ignorieren?',
    };

    if (!confirm(messages[action])) return;

    const endpoints = {
      merge: `/api/admin/duplicates/${id}/merge`,
      different: `/api/admin/duplicates/${id}/mark-different`,
      ignore: `/api/admin/duplicates/${id}/ignore`,
    };

    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = '...';

    try {
      await apiFetch(endpoints[action], { method: 'POST' });
      duplicates = duplicates.filter(d => d.id !== id);
      
      if (duplicates.length === 0) {
        document.getElementById('dup-list').classList.add('hidden');
        document.getElementById('empty-state').classList.remove('hidden');
      } else {
        renderDuplicates();
      }
      document.getElementById('dup-count').textContent = `${duplicates.length} Duplikate`;
    } catch (e) {
      alert('Fehler: ' + e.message);
    } finally {
      btn.disabled = false;
      btn.textContent = originalText;
    }
  }

  // Event listeners
  document.getElementById('confidence-filter').addEventListener('change', loadDuplicates);
  document.getElementById('refresh-btn').addEventListener('click', loadDuplicates);

  // Initial load
  loadDuplicates();
</script>
