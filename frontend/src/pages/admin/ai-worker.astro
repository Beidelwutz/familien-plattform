---
import BaseLayout from '../../layouts/BaseLayout.astro';
import StickyHeader from '../../components/layout/StickyHeader.astro';
import AdminMobileNav from '../../components/admin/AdminMobileNav.astro';
---

<BaseLayout title="AI Worker - Admin - kiezling">
  <StickyHeader />
  <AdminMobileNav currentPage="ai-worker" />
  
  <main class="min-h-screen bg-gray-50 py-6 lg:py-8 lg:ml-56">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <header class="mb-6">
        <a href="/admin" class="text-sm text-primary-500 hover:text-primary-600 font-medium mb-2 inline-block">&larr; Zur√ºck zum Dashboard</a>
        <h1 class="text-2xl font-bold text-gray-900">AI Worker</h1>
        <p class="text-gray-500 text-sm mt-1">Pending-Events klassifizieren und Status setzen</p>
      </header>

      <!-- Loading State -->
      <div id="loading-state" class="text-center py-12">
        <div class="animate-spin inline-block w-8 h-8 border-4 border-primary-500 border-t-transparent rounded-full"></div>
        <p class="text-gray-500 mt-4">Lade Status...</p>
      </div>

      <!-- Content -->
      <div id="content" class="hidden space-y-6">
        <!-- Pending AI Card -->
        <div class="bg-white rounded-2xl shadow-card p-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-lg font-semibold text-gray-900">Warten auf AI-Klassifizierung</h2>
              <p class="text-sm text-gray-500">Events mit Status <code class="bg-gray-100 px-1 rounded">pending_ai</code></p>
            </div>
            <div class="text-right">
              <span id="pending-ai-count" class="text-4xl font-bold text-amber-500">--</span>
              <span class="block text-sm text-gray-500">Events</span>
            </div>
          </div>
          
          <div class="border-t border-gray-100 pt-4 mt-4">
            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
              <div class="flex items-center gap-2">
                <label for="limit-select" class="text-sm text-gray-600">Limit:</label>
                <select id="limit-select" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                  <option value="10">10</option>
                  <option value="20">20</option>
                  <option value="50" selected>50</option>
                  <option value="100">100</option>
                </select>
              </div>
              <button 
                id="process-btn" 
                class="flex-1 sm:flex-none px-6 py-3 bg-primary-500 hover:bg-primary-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2"
              >
                <span id="btn-icon">üöÄ</span>
                <span id="btn-text">Pending-AI verarbeiten</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Processing Progress (shown during processing) -->
        <div id="progress-card" class="hidden bg-white rounded-2xl shadow-card p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">AI-Klassifizierung l√§uft...</h3>
            <button id="cancel-btn" class="text-sm text-gray-500 hover:text-red-500 transition-colors">
              Abbrechen
            </button>
          </div>
          
          <!-- Progress Bar -->
          <div class="mb-4">
            <div class="flex justify-between text-sm text-gray-600 mb-1">
              <span id="progress-text">0 von 0</span>
              <span id="progress-percent">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
              <div id="progress-bar" class="bg-primary-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
          
          <!-- Current Event -->
          <div class="flex items-center gap-2 text-sm text-gray-600 mb-2">
            <span class="animate-pulse">‚ñ∏</span>
            <span>Aktuell:</span>
            <span id="current-event" class="font-medium text-gray-900 truncate">-</span>
          </div>
          
          <!-- Estimated Time -->
          <div class="flex items-center gap-2 text-sm text-gray-500 mb-4">
            <span>‚è±</span>
            <span>Gesch√§tzt:</span>
            <span id="estimated-time">Berechne...</span>
          </div>
          
          <!-- Live Results Summary -->
          <div class="grid grid-cols-4 gap-2 mb-4">
            <div class="bg-green-50 rounded-lg p-2 text-center">
              <span id="live-published" class="text-lg font-bold text-green-600">0</span>
              <span class="block text-xs text-green-600">Ver√∂ff.</span>
            </div>
            <div class="bg-amber-50 rounded-lg p-2 text-center">
              <span id="live-review" class="text-lg font-bold text-amber-600">0</span>
              <span class="block text-xs text-amber-600">Review</span>
            </div>
            <div class="bg-red-50 rounded-lg p-2 text-center">
              <span id="live-rejected" class="text-lg font-bold text-red-600">0</span>
              <span class="block text-xs text-red-600">Abgel.</span>
            </div>
            <div class="bg-gray-100 rounded-lg p-2 text-center">
              <span id="live-failed" class="text-lg font-bold text-gray-600">0</span>
              <span class="block text-xs text-gray-600">Fehler</span>
            </div>
          </div>
          
          <!-- Live Results List -->
          <div class="border-t border-gray-100 pt-4">
            <h4 class="text-sm font-medium text-gray-700 mb-2">Bisherige Ergebnisse:</h4>
            <div id="live-result-list" class="max-h-48 overflow-y-auto space-y-1 text-sm">
              <p class="text-gray-400 text-center py-4">Noch keine Ergebnisse...</p>
            </div>
          </div>
        </div>

        <!-- Processing Result (shown after completion) -->
        <div id="result-card" class="hidden bg-white rounded-2xl shadow-card p-6">
          <div class="flex items-center gap-2 mb-4">
            <span class="text-2xl">‚úÖ</span>
            <h3 class="text-lg font-semibold text-gray-900">Verarbeitung abgeschlossen</h3>
          </div>
          
          <!-- Result Summary -->
          <div id="result-summary" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4">
            <div class="bg-green-50 rounded-xl p-4 text-center">
              <span id="result-published" class="text-2xl font-bold text-green-600">0</span>
              <span class="block text-sm text-green-600">Ver√∂ffentlicht</span>
            </div>
            <div class="bg-amber-50 rounded-xl p-4 text-center">
              <span id="result-review" class="text-2xl font-bold text-amber-600">0</span>
              <span class="block text-sm text-amber-600">Zur Pr√ºfung</span>
            </div>
            <div class="bg-red-50 rounded-xl p-4 text-center">
              <span id="result-rejected" class="text-2xl font-bold text-red-600">0</span>
              <span class="block text-sm text-red-600">Abgelehnt</span>
            </div>
            <div class="bg-gray-50 rounded-xl p-4 text-center">
              <span id="result-failed" class="text-2xl font-bold text-gray-600">0</span>
              <span class="block text-sm text-gray-600">Fehler</span>
            </div>
          </div>

          <!-- Result Details -->
          <div id="result-details" class="hidden">
            <div class="border-t border-gray-100 pt-4">
              <h4 class="text-sm font-medium text-gray-700 mb-2">Details:</h4>
              <div id="result-list" class="max-h-64 overflow-y-auto space-y-2 text-sm"></div>
            </div>
          </div>
        </div>

        <!-- Worker Status (Optional - wenn Backend-Proxy existiert) -->
        <div id="worker-status-card" class="hidden bg-white rounded-2xl shadow-card p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">AI Worker Status</h3>
          <div class="flex items-center gap-3">
            <span id="worker-indicator" class="w-3 h-3 rounded-full bg-gray-300"></span>
            <span id="worker-status-text" class="text-gray-600">Pr√ºfe...</span>
          </div>
        </div>

        <!-- Quick Links -->
        <div class="bg-white rounded-2xl shadow-card p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Schnellzugriff</h3>
          <div class="flex flex-wrap gap-3">
            <a href="/admin/review?status=pending_ai" class="px-4 py-2 bg-amber-100 text-amber-700 rounded-lg hover:bg-amber-200 transition-colors text-sm font-medium">
              üìã Pending-AI Events ansehen
            </a>
            <a href="/admin/review?status=pending_review" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm font-medium">
              üëÅÔ∏è Review Queue
            </a>
            <a href="/admin/ai-usage" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors text-sm font-medium">
              üìä AI Usage Monitor
            </a>
          </div>
        </div>
      </div>

      <!-- Error State -->
      <div id="error-state" class="hidden text-center py-12 bg-white rounded-2xl shadow-card">
        <p class="text-red-500 text-lg mb-4">Fehler beim Laden</p>
        <button onclick="loadData()" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600">Erneut versuchen</button>
      </div>
    </div>
  </main>
</BaseLayout>

<script>
  const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:4000';
  
  const token = localStorage.getItem('auth_token');
  if (!token) {
    window.location.href = '/login?redirect=/admin/ai-worker';
  }

  let isProcessing = false;
  let currentJobId = null;
  let pollInterval = null;

  async function loadData() {
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('content').classList.add('hidden');
    document.getElementById('error-state').classList.add('hidden');

    try {
      const pendingRes = await fetch(`${API_URL}/api/admin/pending-ai-count`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!pendingRes.ok) throw new Error('Failed to load pending count');

      const pending = await pendingRes.json();
      document.getElementById('pending-ai-count').textContent = pending.data?.count || 0;

      // Optional: Check worker health
      checkWorkerHealth();

      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');
    } catch (e) {
      console.error('Load error:', e);
      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('error-state').classList.remove('hidden');
    }
  }

  async function checkWorkerHealth() {
    const card = document.getElementById('worker-status-card');
    const indicator = document.getElementById('worker-indicator');
    const statusText = document.getElementById('worker-status-text');

    try {
      const res = await fetch(`${API_URL}/api/admin/ai-worker/health`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (res.ok) {
        const data = await res.json();
        card.classList.remove('hidden');
        if (data.success && data.data?.status === 'healthy') {
          indicator.className = 'w-3 h-3 rounded-full bg-green-500';
          statusText.textContent = 'Erreichbar';
          statusText.className = 'text-green-600';
        } else {
          indicator.className = 'w-3 h-3 rounded-full bg-yellow-500';
          statusText.textContent = 'Eingeschr√§nkt';
          statusText.className = 'text-yellow-600';
        }
      }
    } catch (e) {
      // Worker health endpoint nicht verf√ºgbar - Card versteckt lassen
      console.log('Worker health check not available');
    }
  }

  async function processEvents() {
    if (isProcessing) return;

    const btn = document.getElementById('process-btn');
    const btnIcon = document.getElementById('btn-icon');
    const btnText = document.getElementById('btn-text');
    const limit = document.getElementById('limit-select').value;

    // Set loading state
    isProcessing = true;
    btn.disabled = true;
    btnIcon.textContent = '‚è≥';
    btnText.textContent = 'Startet...';

    // Hide result card if visible
    document.getElementById('result-card').classList.add('hidden');

    try {
      const res = await fetch(`${API_URL}/api/admin/process-pending-ai?limit=${limit}`, {
        method: 'POST',
        headers: { 
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.error || 'Processing failed');
      }

      // Check if we got a jobId (async processing) or direct results (no events)
      if (data.jobId) {
        currentJobId = data.jobId;
        showProgressUI(data.total);
        startPolling();
      } else {
        // No events to process or synchronous response
        showResults({ summary: data.summary, results: [] });
        resetButton();
      }

    } catch (e) {
      console.error('Processing error:', e);
      alert('Fehler bei der Verarbeitung: ' + e.message);
      resetButton();
    }
  }

  function showProgressUI(total) {
    const progressCard = document.getElementById('progress-card');
    progressCard.classList.remove('hidden');
    
    // Reset progress UI
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-text').textContent = `0 von ${total}`;
    document.getElementById('progress-percent').textContent = '0%';
    document.getElementById('current-event').textContent = 'Starte...';
    document.getElementById('estimated-time').textContent = 'Berechne...';
    document.getElementById('live-published').textContent = '0';
    document.getElementById('live-review').textContent = '0';
    document.getElementById('live-rejected').textContent = '0';
    document.getElementById('live-failed').textContent = '0';
    document.getElementById('live-result-list').innerHTML = '<p class="text-gray-400 text-center py-4">Noch keine Ergebnisse...</p>';
    
    // Update button
    document.getElementById('btn-text').textContent = 'Verarbeite...';
    
    // Scroll to progress
    progressCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  function startPolling() {
    if (pollInterval) clearInterval(pollInterval);
    
    // Poll every 1.5 seconds
    pollInterval = setInterval(pollJobStatus, 1500);
    
    // Also poll immediately
    pollJobStatus();
  }

  function stopPolling() {
    if (pollInterval) {
      clearInterval(pollInterval);
      pollInterval = null;
    }
  }

  async function pollJobStatus() {
    if (!currentJobId) return;

    try {
      const res = await fetch(`${API_URL}/api/admin/ai-job-status/${currentJobId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!res.ok) {
        console.error('Failed to poll job status');
        return;
      }

      const { data } = await res.json();
      
      if (!data) return;

      updateProgressUI(data);

      // Check if job is completed or failed
      if (data.status === 'completed' || data.status === 'failed') {
        stopPolling();
        onJobComplete(data);
      }

    } catch (e) {
      console.error('Polling error:', e);
    }
  }

  function updateProgressUI(data) {
    const percent = data.total > 0 ? Math.round((data.processed / data.total) * 100) : 0;
    
    // Update progress bar
    document.getElementById('progress-bar').style.width = `${percent}%`;
    document.getElementById('progress-text').textContent = `${data.processed} von ${data.total}`;
    document.getElementById('progress-percent').textContent = `${percent}%`;
    
    // Update current event
    if (data.currentEvent) {
      document.getElementById('current-event').textContent = data.currentEvent.title || data.currentEvent.id;
    } else if (data.status === 'completed') {
      document.getElementById('current-event').textContent = 'Fertig!';
    }
    
    // Update estimated time
    if (data.estimatedSecondsRemaining !== null && data.estimatedSecondsRemaining > 0) {
      const mins = Math.floor(data.estimatedSecondsRemaining / 60);
      const secs = data.estimatedSecondsRemaining % 60;
      if (mins > 0) {
        document.getElementById('estimated-time').textContent = `~${mins} Min ${secs} Sek verbleibend`;
      } else {
        document.getElementById('estimated-time').textContent = `~${secs} Sek verbleibend`;
      }
    } else if (data.status === 'completed') {
      document.getElementById('estimated-time').textContent = 'Abgeschlossen';
    }
    
    // Update live summary
    if (data.summary) {
      document.getElementById('live-published').textContent = data.summary.published || 0;
      document.getElementById('live-review').textContent = data.summary.pending_review || 0;
      document.getElementById('live-rejected').textContent = data.summary.rejected || 0;
      document.getElementById('live-failed').textContent = data.summary.failed || 0;
    }
    
    // Update live results list
    if (data.results && data.results.length > 0) {
      const listEl = document.getElementById('live-result-list');
      listEl.innerHTML = data.results.slice(-10).reverse().map(r => {
        let statusIcon = '‚ùì';
        let statusClass = 'text-gray-500';
        
        if (r.status === 'published') {
          statusIcon = '‚úÖ';
          statusClass = 'text-green-600';
        } else if (r.status === 'pending_review') {
          statusIcon = 'üëÅÔ∏è';
          statusClass = 'text-amber-600';
        } else if (r.status === 'rejected') {
          statusIcon = '‚ùå';
          statusClass = 'text-red-600';
        } else if (r.error) {
          statusIcon = '‚ö†Ô∏è';
          statusClass = 'text-gray-500';
        }

        return `
          <div class="flex items-center justify-between py-1 px-2 rounded ${r === data.results[data.results.length - 1] ? 'bg-primary-50' : ''}">
            <div class="flex items-center gap-2 min-w-0">
              <span class="text-xs">${statusIcon}</span>
              <span class="truncate text-xs" title="${r.title}">${r.title}</span>
            </div>
            <span class="${statusClass} text-xs whitespace-nowrap ml-2">
              ${r.error ? 'Fehler' : r.status}
              ${r.familyFit ? `(${r.familyFit}%)` : ''}
            </span>
          </div>
        `;
      }).join('');
      
      // Show count if more than 10
      if (data.results.length > 10) {
        listEl.innerHTML += `<p class="text-xs text-gray-400 text-center mt-2">... und ${data.results.length - 10} weitere</p>`;
      }
    }
  }

  function onJobComplete(data) {
    // Hide progress card
    document.getElementById('progress-card').classList.add('hidden');
    
    // Show results
    showResults(data);
    
    // Reset button and state
    resetButton();
    
    // Reload pending count
    reloadPendingCount();
  }

  async function reloadPendingCount() {
    try {
      const pendingRes = await fetch(`${API_URL}/api/admin/pending-ai-count`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (pendingRes.ok) {
        const pending = await pendingRes.json();
        document.getElementById('pending-ai-count').textContent = pending.data?.count || 0;
      }
    } catch (e) {
      console.error('Failed to reload pending count:', e);
    }
  }

  function resetButton() {
    isProcessing = false;
    currentJobId = null;
    const btn = document.getElementById('process-btn');
    btn.disabled = false;
    document.getElementById('btn-icon').textContent = 'üöÄ';
    document.getElementById('btn-text').textContent = 'Pending-AI verarbeiten';
  }

  function cancelProcessing() {
    // Note: This only stops polling, the backend job continues
    stopPolling();
    document.getElementById('progress-card').classList.add('hidden');
    resetButton();
    
    // Reload to show current state
    reloadPendingCount();
  }

  function showResults(data) {
    const resultCard = document.getElementById('result-card');
    resultCard.classList.remove('hidden');

    // Summary
    const summary = data.summary || {};
    document.getElementById('result-published').textContent = summary.published || 0;
    document.getElementById('result-review').textContent = summary.pending_review || 0;
    document.getElementById('result-rejected').textContent = summary.rejected || 0;
    document.getElementById('result-failed').textContent = summary.failed || 0;

    // Details
    const results = data.results || [];
    if (results.length > 0) {
      document.getElementById('result-details').classList.remove('hidden');
      const listEl = document.getElementById('result-list');
      
      listEl.innerHTML = results.map(r => {
        let statusClass = 'text-gray-600';
        let statusIcon = '‚ùì';
        
        if (r.status === 'published') {
          statusClass = 'text-green-600';
          statusIcon = '‚úÖ';
        } else if (r.status === 'pending_review') {
          statusClass = 'text-amber-600';
          statusIcon = 'üëÅÔ∏è';
        } else if (r.status === 'rejected') {
          statusClass = 'text-red-600';
          statusIcon = '‚ùå';
        } else if (r.error) {
          statusClass = 'text-gray-500';
          statusIcon = '‚ö†Ô∏è';
        }

        return `
          <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
            <div class="flex items-center gap-2 min-w-0">
              <span>${statusIcon}</span>
              <span class="truncate" title="${r.title || r.id}">${r.title || r.id}</span>
            </div>
            <span class="${statusClass} text-xs font-medium whitespace-nowrap ml-2">
              ${r.error ? r.error : r.status}
              ${r.familyFit ? `(${r.familyFit}%)` : ''}
            </span>
          </div>
        `;
      }).join('');
    } else {
      document.getElementById('result-details').classList.add('hidden');
    }

    // Scroll to results
    resultCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  // Event listeners
  document.getElementById('process-btn').addEventListener('click', processEvents);
  document.getElementById('cancel-btn').addEventListener('click', cancelProcessing);

  // Initial load
  loadData();
</script>
