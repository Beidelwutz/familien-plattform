---
import AdminLayout from '../../layouts/AdminLayout.astro';
const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:4000';
---

<AdminLayout title="AI Worker - kiezling Admin" currentPage="ai-worker">
  <div class="max-w-5xl mx-auto">
    <!-- Header -->
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">AI Worker</h1>
        <p class="text-gray-500 text-sm mt-1">Pending-Events klassifizieren und Status setzen</p>
      </div>
      <div id="health-badge" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-100 text-gray-500 text-sm font-medium">
        <span id="health-dot" class="w-2 h-2 rounded-full bg-gray-400"></span>
        <span id="health-text">Pr√ºfe...</span>
      </div>
    </header>

    <!-- Loading State -->
    <div id="loading-state" class="text-center py-12">
      <div class="animate-spin inline-block w-8 h-8 border-4 border-primary-500 border-t-transparent rounded-full"></div>
      <p class="text-gray-500 mt-4">Lade Status...</p>
    </div>

    <!-- Content -->
    <div id="content" class="hidden space-y-6">
      <!-- Stats Row -->
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <!-- Large KPI: Pending AI Events -->
        <div id="pending-card" class="lg:col-span-1 bg-white rounded-2xl shadow-card p-6 border-l-4 border-gray-300">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 font-medium">Pending AI</p>
              <p id="pending-ai-count" class="text-4xl font-bold text-gray-900 mt-1">--</p>
              <p class="text-xs text-gray-400 mt-1">Events warten</p>
            </div>
            <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center text-2xl">
              ü§ñ
            </div>
          </div>
        </div>

        <!-- Mini Stats -->
        <div class="lg:col-span-3 grid grid-cols-3 gap-4">
          <div class="bg-white rounded-2xl shadow-card p-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center text-lg">
                ‚úÖ
              </div>
              <div>
                <p class="text-sm text-gray-500">Heute verarbeitet</p>
                <p id="processed-today" class="text-xl font-bold text-gray-900">--</p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-2xl shadow-card p-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-lg">
                üìä
              </div>
              <div>
                <p class="text-sm text-gray-500">Erfolgsrate</p>
                <p id="success-rate" class="text-xl font-bold text-gray-900">--%</p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-2xl shadow-card p-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center text-lg">
                ‚è±Ô∏è
              </div>
              <div>
                <p class="text-sm text-gray-500">√ò Zeit/Event</p>
                <p id="avg-time" class="text-xl font-bold text-gray-900">-- ms</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Last Activity Info -->
      <div id="last-activity" class="bg-gray-50 rounded-xl p-3 hidden">
        <div class="flex items-center gap-2 text-sm text-gray-500">
          <span>üïí</span>
          <span>Letzte Verarbeitung: <span id="last-processed-at" class="font-medium text-gray-700">--</span></span>
        </div>
      </div>

      <!-- Batch Processing Section -->
      <div class="bg-white rounded-2xl shadow-card p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Batch-Verarbeitung</h2>
        
        <div class="space-y-4">
          <!-- Batch Limit Slider -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <label for="batch-slider" class="text-sm font-medium text-gray-700">Batch-Gr√∂√üe</label>
              <span id="slider-value" class="text-sm font-bold text-primary-600 bg-primary-50 px-2 py-0.5 rounded">25</span>
            </div>
            <div class="relative">
              <input 
                type="range" 
                id="batch-slider" 
                min="10" 
                max="100" 
                value="25" 
                step="5"
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb"
              />
              <div class="flex justify-between text-xs text-gray-400 mt-1">
                <span>10</span>
                <span>50</span>
                <span>100</span>
              </div>
            </div>
          </div>

          <!-- Start Button -->
          <button 
            id="start-batch-btn" 
            class="w-full sm:w-auto px-8 py-3 bg-primary-500 hover:bg-primary-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2 text-lg"
          >
            <span id="btn-icon">üöÄ</span>
            <span id="btn-text">Start Batch</span>
          </button>
          
          <p id="btn-hint" class="text-sm text-gray-500 hidden"></p>
        </div>
      </div>

      <!-- Progress Section (hidden by default) -->
      <div id="progress-section" class="hidden bg-white rounded-2xl shadow-card p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-900">Verarbeitung l√§uft...</h3>
          <button id="cancel-btn" class="px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg transition-colors font-medium">
            Abbrechen
          </button>
        </div>

        <!-- Progress Bar -->
        <div class="mb-6">
          <div class="flex justify-between text-sm mb-2">
            <span id="progress-text" class="text-gray-600">0 / 0</span>
            <span id="progress-percent" class="font-bold text-primary-600">0%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
            <div 
              id="progress-bar" 
              class="bg-gradient-to-r from-primary-500 to-primary-400 h-4 rounded-full transition-all duration-300 relative overflow-hidden"
              style="width: 0%"
            >
              <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
            </div>
          </div>
        </div>

        <!-- Stats Breakdown -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
          <div class="bg-gray-50 rounded-xl p-3 text-center">
            <span id="stat-processed" class="text-2xl font-bold text-gray-900">0</span>
            <span class="block text-xs text-gray-500 mt-1">Verarbeitet</span>
          </div>
          <div class="bg-green-50 rounded-xl p-3 text-center">
            <span id="stat-published" class="text-2xl font-bold text-green-600">0</span>
            <span class="block text-xs text-green-600 mt-1">‚Üí Published</span>
          </div>
          <div class="bg-amber-50 rounded-xl p-3 text-center">
            <span id="stat-review" class="text-2xl font-bold text-amber-600">0</span>
            <span class="block text-xs text-amber-600 mt-1">‚Üí pending_review</span>
          </div>
          <div class="bg-red-50 rounded-xl p-3 text-center">
            <span id="stat-failed" class="text-2xl font-bold text-red-600">0</span>
            <span class="block text-xs text-red-600 mt-1">Fehler</span>
          </div>
        </div>

        <!-- Elapsed Time -->
        <div class="flex items-center gap-2 text-sm text-gray-500">
          <span>‚è±Ô∏è</span>
          <span>Vergangene Zeit:</span>
          <span id="elapsed-time" class="font-medium text-gray-700">0:00</span>
        </div>
      </div>

      <!-- Results Section -->
      <div id="results-section" class="hidden bg-white rounded-2xl shadow-card p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-900">Ergebnisse</h3>
          <button id="clear-results-btn" class="px-3 py-1.5 text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
            Leeren
          </button>
        </div>

        <!-- Results List -->
        <div id="results-list" class="max-h-96 overflow-y-auto space-y-2">
          <p class="text-gray-400 text-center py-8">Keine Ergebnisse</p>
        </div>
      </div>

      <!-- Diagnostics Section -->
      <div id="diagnostics-section" class="bg-white rounded-2xl shadow-card p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
            üîç Diagnose
          </h3>
          <button id="refresh-diagnostics-btn" class="px-3 py-1.5 text-sm text-primary-600 hover:bg-primary-50 rounded-lg transition-colors font-medium">
            ‚Üª Aktualisieren
          </button>
        </div>

        <!-- Loading State -->
        <div id="diagnostics-loading" class="text-center py-8">
          <div class="animate-spin inline-block w-6 h-6 border-2 border-primary-500 border-t-transparent rounded-full"></div>
          <p class="text-gray-500 mt-2 text-sm">Pr√ºfe AI-Worker...</p>
        </div>

        <!-- Diagnostics Content -->
        <div id="diagnostics-content" class="hidden space-y-4">
          <!-- Connection Status -->
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <!-- Worker Reachable -->
            <div id="diag-worker" class="p-3 rounded-xl bg-gray-50">
              <div class="flex items-center gap-2 mb-1">
                <span id="diag-worker-dot" class="w-2.5 h-2.5 rounded-full bg-gray-400"></span>
                <span class="text-sm font-medium text-gray-700">AI-Worker</span>
              </div>
              <span id="diag-worker-status" class="text-xs text-gray-500">Pr√ºfe...</span>
            </div>

            <!-- Redis Status -->
            <div id="diag-redis" class="p-3 rounded-xl bg-gray-50">
              <div class="flex items-center gap-2 mb-1">
                <span id="diag-redis-dot" class="w-2.5 h-2.5 rounded-full bg-gray-400"></span>
                <span class="text-sm font-medium text-gray-700">Redis</span>
              </div>
              <span id="diag-redis-status" class="text-xs text-gray-500">Pr√ºfe...</span>
            </div>

            <!-- OpenAI Status -->
            <div id="diag-openai" class="p-3 rounded-xl bg-gray-50">
              <div class="flex items-center gap-2 mb-1">
                <span id="diag-openai-dot" class="w-2.5 h-2.5 rounded-full bg-gray-400"></span>
                <span class="text-sm font-medium text-gray-700">OpenAI API</span>
              </div>
              <span id="diag-openai-status" class="text-xs text-gray-500">Pr√ºfe...</span>
            </div>
          </div>

          <!-- Issues/Warnings -->
          <div id="diag-issues" class="hidden">
            <h4 class="text-sm font-medium text-gray-700 mb-2">‚ö†Ô∏è Probleme</h4>
            <ul id="diag-issues-list" class="space-y-1 text-sm text-red-600 bg-red-50 p-3 rounded-lg"></ul>
          </div>

          <!-- Config Info -->
          <div class="text-xs text-gray-400 pt-2 border-t border-gray-100">
            <div class="flex flex-wrap gap-4">
              <span>Worker: <span id="diag-worker-url" class="font-mono">--</span></span>
              <span>Version: <span id="diag-version" class="font-mono">--</span></span>
              <span>Budget: <span id="diag-budget" class="font-mono">--</span></span>
            </div>
          </div>
        </div>

        <!-- Error State -->
        <div id="diagnostics-error" class="hidden text-center py-6">
          <p class="text-red-500 mb-2">‚ùå AI-Worker nicht erreichbar</p>
          <p id="diagnostics-error-msg" class="text-sm text-gray-500 mb-4">--</p>
          <button onclick="loadDiagnostics()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors">
            Erneut versuchen
          </button>
        </div>
      </div>

      <!-- Quick Links -->
      <div class="bg-white rounded-2xl shadow-card p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Schnellzugriff</h3>
        <div class="flex flex-wrap gap-3">
          <a href="/admin/review?status=pending_ai" class="px-4 py-2 bg-amber-100 text-amber-700 rounded-lg hover:bg-amber-200 transition-colors text-sm font-medium">
            üìã Pending-AI Events ansehen
          </a>
          <a href="/admin/review?status=pending_review" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm font-medium">
            üëÅÔ∏è Review Queue
          </a>
          <a href="/admin/review?status=rejected" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm font-medium">
            üö´ Abgelehnte Events
          </a>
          <a href="/admin/ai-usage" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors text-sm font-medium">
            üìä AI Usage Monitor
          </a>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="hidden text-center py-12 bg-white rounded-2xl shadow-card">
      <p class="text-red-500 text-lg mb-4">Fehler beim Laden</p>
      <button onclick="loadData()" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600">
        Erneut versuchen
      </button>
    </div>
  </div>
</AdminLayout>

<style>
  /* Custom slider styles */
  .slider-thumb {
    -webkit-appearance: none;
    appearance: none;
  }
  
  .slider-thumb::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #4f46e5;
    cursor: pointer;
    border: 3px solid white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    transition: transform 0.15s ease;
  }
  
  .slider-thumb::-webkit-slider-thumb:hover {
    transform: scale(1.1);
  }
  
  .slider-thumb::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #4f46e5;
    cursor: pointer;
    border: 3px solid white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }
  
  /* Result item styles */
  .result-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    background: #f9fafb;
    border-radius: 0.75rem;
    transition: background-color 0.2s;
  }
  
  .result-item:hover {
    background: #f3f4f6;
  }
  
  .result-item.new {
    animation: highlight 1s ease-out;
  }
  
  @keyframes highlight {
    0% { background-color: #e0e7ff; }
    100% { background-color: #f9fafb; }
  }
</style>

<script is:inline define:vars={{ API_URL }}>
  const token = localStorage.getItem('auth_token');
  if (!token) {
    window.location.href = '/login?redirect=/admin/ai-worker';
  }

  // State
  let isProcessing = false;
  let currentJobId = null;
  let pollInterval = null;
  let elapsedInterval = null;
  let startTime = null;
  let results = [];

  // DOM Elements
  const elements = {
    loadingState: document.getElementById('loading-state'),
    content: document.getElementById('content'),
    errorState: document.getElementById('error-state'),
    healthBadge: document.getElementById('health-badge'),
    healthDot: document.getElementById('health-dot'),
    healthText: document.getElementById('health-text'),
    pendingCard: document.getElementById('pending-card'),
    pendingAiCount: document.getElementById('pending-ai-count'),
    processedToday: document.getElementById('processed-today'),
    successRate: document.getElementById('success-rate'),
    avgTime: document.getElementById('avg-time'),
    batchSlider: document.getElementById('batch-slider'),
    sliderValue: document.getElementById('slider-value'),
    startBatchBtn: document.getElementById('start-batch-btn'),
    btnIcon: document.getElementById('btn-icon'),
    btnText: document.getElementById('btn-text'),
    btnHint: document.getElementById('btn-hint'),
    progressSection: document.getElementById('progress-section'),
    progressText: document.getElementById('progress-text'),
    progressPercent: document.getElementById('progress-percent'),
    progressBar: document.getElementById('progress-bar'),
    statProcessed: document.getElementById('stat-processed'),
    statPublished: document.getElementById('stat-published'),
    statReview: document.getElementById('stat-review'),
    statFailed: document.getElementById('stat-failed'),
    elapsedTime: document.getElementById('elapsed-time'),
    cancelBtn: document.getElementById('cancel-btn'),
    resultsSection: document.getElementById('results-section'),
    resultsList: document.getElementById('results-list'),
    clearResultsBtn: document.getElementById('clear-results-btn'),
  };

  // Initialize slider
  elements.batchSlider.addEventListener('input', (e) => {
    elements.sliderValue.textContent = e.target.value;
  });

  // Load initial data
  async function loadData() {
    elements.loadingState.classList.remove('hidden');
    elements.content.classList.add('hidden');
    elements.errorState.classList.add('hidden');

    try {
      // Fetch pending count and worker health in parallel
      const [pendingRes, healthRes, statsRes] = await Promise.all([
        fetch(`${API_URL}/api/admin/pending-ai-count`, {
          headers: { Authorization: `Bearer ${token}` }
        }),
        fetch(`${API_URL}/api/admin/ai-worker/health`, {
          headers: { Authorization: `Bearer ${token}` }
        }).catch(() => null),
        fetch(`${API_URL}/api/admin/ai-worker/stats`, {
          headers: { Authorization: `Bearer ${token}` }
        }).catch(() => null),
      ]);

      if (!pendingRes.ok) throw new Error('Failed to load pending count');

      const pending = await pendingRes.json();
      const pendingCount = pending.data?.count || 0;
      elements.pendingAiCount.textContent = pendingCount;

      // Update pending card color based on count
      if (pendingCount > 0) {
        elements.pendingCard.classList.remove('border-gray-300');
        elements.pendingCard.classList.add('border-amber-400');
        elements.pendingAiCount.classList.remove('text-gray-900');
        elements.pendingAiCount.classList.add('text-amber-500');
      } else {
        elements.pendingCard.classList.remove('border-amber-400');
        elements.pendingCard.classList.add('border-gray-300');
        elements.pendingAiCount.classList.remove('text-amber-500');
        elements.pendingAiCount.classList.add('text-gray-900');
      }

      // Update worker health
      if (healthRes && healthRes.ok) {
        const healthData = await healthRes.json();
        if (healthData.success && healthData.data?.status === 'healthy') {
          elements.healthBadge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-100 text-green-700 text-sm font-medium';
          elements.healthDot.className = 'w-2 h-2 rounded-full bg-green-500';
          elements.healthText.textContent = 'OK';
        } else {
          elements.healthBadge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-amber-100 text-amber-700 text-sm font-medium';
          elements.healthDot.className = 'w-2 h-2 rounded-full bg-amber-500';
          elements.healthText.textContent = 'Eingeschr√§nkt';
        }
      } else {
        elements.healthBadge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-100 text-red-700 text-sm font-medium';
        elements.healthDot.className = 'w-2 h-2 rounded-full bg-red-500';
        elements.healthText.textContent = 'Offline';
      }

      // Update stats
      if (statsRes && statsRes.ok) {
        const statsData = await statsRes.json();
        if (statsData.data) {
          elements.processedToday.textContent = statsData.data.processedToday || 0;
          elements.successRate.textContent = statsData.data.successRate ? `${statsData.data.successRate}%` : '--%';
          elements.avgTime.textContent = statsData.data.avgProcessingTime ? `${statsData.data.avgProcessingTime} ms` : '-- ms';
          
          // Show last processed time
          const lastActivityEl = document.getElementById('last-activity');
          const lastProcessedAtEl = document.getElementById('last-processed-at');
          if (statsData.data.lastProcessedAt) {
            const lastTime = new Date(statsData.data.lastProcessedAt);
            const now = new Date();
            const diffMs = now - lastTime;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            let timeAgo;
            if (diffMins < 1) {
              timeAgo = 'gerade eben';
            } else if (diffMins < 60) {
              timeAgo = `vor ${diffMins} Minute${diffMins !== 1 ? 'n' : ''}`;
            } else if (diffHours < 24) {
              timeAgo = `vor ${diffHours} Stunde${diffHours !== 1 ? 'n' : ''}`;
            } else {
              timeAgo = `vor ${diffDays} Tag${diffDays !== 1 ? 'en' : ''}`;
            }
            
            lastProcessedAtEl.textContent = timeAgo;
            lastActivityEl.classList.remove('hidden');
          }
        }
      }

      // Update button state
      updateButtonState(pendingCount);

      elements.loadingState.classList.add('hidden');
      elements.content.classList.remove('hidden');
    } catch (e) {
      console.error('Load error:', e);
      elements.loadingState.classList.add('hidden');
      elements.errorState.classList.remove('hidden');
    }
  }

  function updateButtonState(pendingCount) {
    if (pendingCount === 0) {
      elements.startBatchBtn.disabled = true;
      elements.btnHint.textContent = 'Keine Events in der Queue';
      elements.btnHint.classList.remove('hidden');
    } else if (isProcessing) {
      elements.startBatchBtn.disabled = true;
      elements.btnHint.textContent = 'Verarbeitung l√§uft...';
      elements.btnHint.classList.remove('hidden');
    } else {
      elements.startBatchBtn.disabled = false;
      elements.btnHint.classList.add('hidden');
    }
  }

  // Start batch processing
  async function startBatch() {
    if (isProcessing) return;

    const limit = elements.batchSlider.value;
    
    isProcessing = true;
    elements.startBatchBtn.disabled = true;
    elements.btnIcon.textContent = '‚è≥';
    elements.btnText.textContent = 'Startet...';
    elements.btnHint.textContent = '';
    elements.btnHint.classList.add('hidden');

    try {
      const res = await fetch(`${API_URL}/api/admin/process-pending-ai?limit=${limit}`, {
        method: 'POST',
        headers: { 
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.error || 'Processing failed');
      }

      if (data.jobId) {
        currentJobId = data.jobId;
        startTime = Date.now();
        showProgressSection(data.total || limit);
        startPolling();
        startElapsedTimer();
      } else {
        // No events to process
        alert('Keine Events zu verarbeiten');
        resetButton();
      }

    } catch (e) {
      console.error('Processing error:', e);
      alert('Fehler bei der Verarbeitung: ' + e.message);
      resetButton();
    }
  }

  function showProgressSection(total) {
    elements.progressSection.classList.remove('hidden');
    elements.progressBar.style.width = '0%';
    elements.progressText.textContent = `0 / ${total}`;
    elements.progressPercent.textContent = '0%';
    elements.statProcessed.textContent = '0';
    elements.statPublished.textContent = '0';
    elements.statReview.textContent = '0';
    elements.statFailed.textContent = '0';
    elements.elapsedTime.textContent = '0:00';
    elements.btnText.textContent = 'Verarbeite...';
    
    elements.progressSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  function startPolling() {
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(pollJobStatus, 1500);
    pollJobStatus();
  }

  function stopPolling() {
    if (pollInterval) {
      clearInterval(pollInterval);
      pollInterval = null;
    }
  }

  function startElapsedTimer() {
    if (elapsedInterval) clearInterval(elapsedInterval);
    elapsedInterval = setInterval(updateElapsedTime, 1000);
  }

  function stopElapsedTimer() {
    if (elapsedInterval) {
      clearInterval(elapsedInterval);
      elapsedInterval = null;
    }
  }

  function updateElapsedTime() {
    if (!startTime) return;
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    elements.elapsedTime.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
  }

  async function pollJobStatus() {
    if (!currentJobId) return;

    try {
      const res = await fetch(`${API_URL}/api/admin/ai-job-status/${currentJobId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!res.ok) {
        console.error('Failed to poll job status');
        return;
      }

      const { data } = await res.json();
      if (!data) return;

      updateProgressUI(data);

      if (data.status === 'completed' || data.status === 'failed') {
        stopPolling();
        stopElapsedTimer();
        onJobComplete(data);
      }

    } catch (e) {
      console.error('Polling error:', e);
    }
  }

  function updateProgressUI(data) {
    const percent = data.total > 0 ? Math.round((data.processed / data.total) * 100) : 0;
    
    elements.progressBar.style.width = `${percent}%`;
    elements.progressText.textContent = `${data.processed} / ${data.total}`;
    elements.progressPercent.textContent = `${percent}%`;
    
    elements.statProcessed.textContent = data.processed || 0;
    
    if (data.summary) {
      elements.statPublished.textContent = data.summary.published || 0;
      elements.statReview.textContent = data.summary.pending_review || 0;
      elements.statFailed.textContent = data.summary.failed || 0;
    }

    // Update results list in real-time
    if (data.results && data.results.length > results.length) {
      const newResults = data.results.slice(results.length);
      results = data.results;
      addResultsToList(newResults);
    }
  }

  function addResultsToList(newResults) {
    if (!elements.resultsSection.classList.contains('hidden') === false) {
      elements.resultsSection.classList.remove('hidden');
    }
    
    // Clear "no results" message if present
    if (elements.resultsList.querySelector('p.text-gray-400')) {
      elements.resultsList.innerHTML = '';
    }
    
    elements.resultsSection.classList.remove('hidden');
    
    newResults.forEach(r => {
      const item = createResultItem(r, true);
      elements.resultsList.insertBefore(item, elements.resultsList.firstChild);
    });
  }

  function createResultItem(r, isNew = false) {
    const div = document.createElement('div');
    div.className = `result-item ${isNew ? 'new' : ''}`;
    
    let statusBadge = '';
    let statusClass = '';
    
    if (r.status === 'published') {
      statusBadge = '‚Üí Published';
      statusClass = 'bg-green-100 text-green-700';
    } else if (r.status === 'pending_review') {
      statusBadge = '‚Üí Review';
      statusClass = 'bg-amber-100 text-amber-700';
    } else if (r.error) {
      statusBadge = 'Fehler';
      statusClass = 'bg-red-100 text-red-700';
    } else {
      statusBadge = r.status || 'Unbekannt';
      statusClass = 'bg-gray-100 text-gray-700';
    }

    div.innerHTML = `
      <div class="flex items-center gap-3 min-w-0 flex-1">
        <a href="/event/${r.slug || r.id}" target="_blank" class="font-medium text-gray-900 hover:text-primary-600 truncate" title="${r.title || r.id}">
          ${r.title || r.id}
        </a>
      </div>
      <div class="flex items-center gap-2 flex-shrink-0">
        <span class="text-xs px-2 py-1 rounded-full ${statusClass}">${statusBadge}</span>
        ${r.familyFit ? `<span class="text-xs text-gray-500">${r.familyFit}%</span>` : ''}
        ${r.processingTime ? `<span class="text-xs text-gray-400">${r.processingTime}ms</span>` : ''}
      </div>
    `;
    
    return div;
  }

  function onJobComplete(data) {
    elements.progressSection.classList.add('hidden');
    resetButton();
    reloadPendingCount();
    
    // Show final results
    if (results.length === 0 && data.results) {
      results = data.results;
      elements.resultsSection.classList.remove('hidden');
      elements.resultsList.innerHTML = '';
      data.results.slice().reverse().forEach(r => {
        const item = createResultItem(r);
        elements.resultsList.appendChild(item);
      });
    }
  }

  async function reloadPendingCount() {
    try {
      const pendingRes = await fetch(`${API_URL}/api/admin/pending-ai-count`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (pendingRes.ok) {
        const pending = await pendingRes.json();
        const pendingCount = pending.data?.count || 0;
        elements.pendingAiCount.textContent = pendingCount;
        updateButtonState(pendingCount);
        
        // Update card color
        if (pendingCount > 0) {
          elements.pendingCard.classList.remove('border-gray-300');
          elements.pendingCard.classList.add('border-amber-400');
          elements.pendingAiCount.classList.remove('text-gray-900');
          elements.pendingAiCount.classList.add('text-amber-500');
        } else {
          elements.pendingCard.classList.remove('border-amber-400');
          elements.pendingCard.classList.add('border-gray-300');
          elements.pendingAiCount.classList.remove('text-amber-500');
          elements.pendingAiCount.classList.add('text-gray-900');
        }
      }
    } catch (e) {
      console.error('Failed to reload pending count:', e);
    }
  }

  function resetButton() {
    isProcessing = false;
    currentJobId = null;
    elements.startBatchBtn.disabled = false;
    elements.btnIcon.textContent = 'üöÄ';
    elements.btnText.textContent = 'Start Batch';
  }

  function cancelProcessing() {
    stopPolling();
    stopElapsedTimer();
    elements.progressSection.classList.add('hidden');
    resetButton();
    reloadPendingCount();
  }

  function clearResults() {
    results = [];
    elements.resultsList.innerHTML = '<p class="text-gray-400 text-center py-8">Keine Ergebnisse</p>';
    elements.resultsSection.classList.add('hidden');
  }

  // Diagnostics functions
  async function loadDiagnostics() {
    const diagLoading = document.getElementById('diagnostics-loading');
    const diagContent = document.getElementById('diagnostics-content');
    const diagError = document.getElementById('diagnostics-error');
    const diagErrorMsg = document.getElementById('diagnostics-error-msg');
    
    diagLoading.classList.remove('hidden');
    diagContent.classList.add('hidden');
    diagError.classList.add('hidden');

    try {
      const res = await fetch(`${API_URL}/api/admin/ai-worker/diagnostics`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!res.ok) throw new Error('Failed to fetch diagnostics');
      
      const { data, success, error } = await res.json();
      
      if (!success || !data.reachable) {
        throw new Error(error || 'AI-Worker nicht erreichbar');
      }

      // Update UI elements
      updateDiagnosticsUI(data);
      
      diagLoading.classList.add('hidden');
      diagContent.classList.remove('hidden');
      
    } catch (e) {
      console.error('Diagnostics error:', e);
      diagLoading.classList.add('hidden');
      diagError.classList.remove('hidden');
      diagErrorMsg.textContent = e.message || 'Unbekannter Fehler';
    }
  }

  function updateDiagnosticsUI(data) {
    // Worker status
    const workerDot = document.getElementById('diag-worker-dot');
    const workerStatus = document.getElementById('diag-worker-status');
    
    if (data.reachable) {
      workerDot.className = 'w-2.5 h-2.5 rounded-full bg-green-500';
      workerStatus.textContent = data.status === 'ok' ? 'Verbunden & OK' : `Status: ${data.status}`;
      document.getElementById('diag-worker').className = 'p-3 rounded-xl bg-green-50';
    } else {
      workerDot.className = 'w-2.5 h-2.5 rounded-full bg-red-500';
      workerStatus.textContent = 'Nicht erreichbar';
      document.getElementById('diag-worker').className = 'p-3 rounded-xl bg-red-50';
    }

    // Redis status
    const redisDot = document.getElementById('diag-redis-dot');
    const redisStatus = document.getElementById('diag-redis-status');
    const redisCheck = data.checks?.redis;
    
    if (redisCheck) {
      if (redisCheck.status === 'ok') {
        redisDot.className = 'w-2.5 h-2.5 rounded-full bg-green-500';
        redisStatus.textContent = 'Verbunden';
        document.getElementById('diag-redis').className = 'p-3 rounded-xl bg-green-50';
      } else if (redisCheck.status === 'error' && redisCheck.error?.includes('Connect call failed')) {
        // Redis not configured - show as info, not error
        redisDot.className = 'w-2.5 h-2.5 rounded-full bg-amber-500';
        redisStatus.textContent = 'Nicht konfiguriert';
        document.getElementById('diag-redis').className = 'p-3 rounded-xl bg-amber-50';
      } else {
        redisDot.className = 'w-2.5 h-2.5 rounded-full bg-red-500';
        redisStatus.textContent = redisCheck.error || redisCheck.status;
        document.getElementById('diag-redis').className = 'p-3 rounded-xl bg-red-50';
      }
    } else {
      redisDot.className = 'w-2.5 h-2.5 rounded-full bg-gray-400';
      redisStatus.textContent = 'Status unbekannt';
    }

    // OpenAI status
    const openaiDot = document.getElementById('diag-openai-dot');
    const openaiStatus = document.getElementById('diag-openai-status');
    const openaiCheck = data.checks?.openai;
    
    if (openaiCheck) {
      if (openaiCheck.status === 'ok') {
        openaiDot.className = 'w-2.5 h-2.5 rounded-full bg-green-500';
        openaiStatus.textContent = 'API erreichbar';
        document.getElementById('diag-openai').className = 'p-3 rounded-xl bg-green-50';
      } else if (openaiCheck.status === 'not_configured') {
        openaiDot.className = 'w-2.5 h-2.5 rounded-full bg-gray-400';
        openaiStatus.textContent = 'Nicht konfiguriert';
        document.getElementById('diag-openai').className = 'p-3 rounded-xl bg-gray-50';
      } else {
        openaiDot.className = 'w-2.5 h-2.5 rounded-full bg-red-500';
        openaiStatus.textContent = openaiCheck.error || openaiCheck.status;
        document.getElementById('diag-openai').className = 'p-3 rounded-xl bg-red-50';
      }
    } else {
      openaiDot.className = 'w-2.5 h-2.5 rounded-full bg-gray-400';
      openaiStatus.textContent = 'Status unbekannt';
    }

    // Issues
    const issuesSection = document.getElementById('diag-issues');
    const issuesList = document.getElementById('diag-issues-list');
    const issues = data.metrics?.issues || [];
    
    if (issues.length > 0) {
      issuesSection.classList.remove('hidden');
      issuesList.innerHTML = issues.map(issue => `<li>‚Ä¢ ${issue}</li>`).join('');
    } else {
      issuesSection.classList.add('hidden');
    }

    // Config info
    document.getElementById('diag-worker-url').textContent = data.worker_url || '--';
    document.getElementById('diag-version').textContent = data.basic?.version || '--';
    document.getElementById('diag-budget').textContent = data.metrics?.budget_status || '--';

    // Update main health badge based on detailed status
    if (data.status === 'ok') {
      elements.healthBadge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-100 text-green-700 text-sm font-medium';
      elements.healthDot.className = 'w-2 h-2 rounded-full bg-green-500';
      elements.healthText.textContent = 'OK';
    } else if (data.status === 'degraded') {
      elements.healthBadge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-amber-100 text-amber-700 text-sm font-medium';
      elements.healthDot.className = 'w-2 h-2 rounded-full bg-amber-500';
      elements.healthText.textContent = 'Eingeschr√§nkt';
    } else {
      elements.healthBadge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-100 text-red-700 text-sm font-medium';
      elements.healthDot.className = 'w-2 h-2 rounded-full bg-red-500';
      elements.healthText.textContent = 'Fehler';
    }
  }

  // Event listeners
  elements.startBatchBtn.addEventListener('click', startBatch);
  elements.cancelBtn.addEventListener('click', cancelProcessing);
  elements.clearResultsBtn.addEventListener('click', clearResults);
  document.getElementById('refresh-diagnostics-btn').addEventListener('click', loadDiagnostics);

  // Initial load
  loadData();
  loadDiagnostics();
</script>
