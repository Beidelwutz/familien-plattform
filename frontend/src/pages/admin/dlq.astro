---
import BaseLayout from "../../layouts/BaseLayout.astro";
import StickyHeader from "../../components/layout/StickyHeader.astro";

const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:4000";
const WORKER_URL = import.meta.env.PUBLIC_AI_WORKER_URL || "http://localhost:5000";
---

<BaseLayout title="DLQ Manager - Admin - kiezling">
  <StickyHeader />
  <main class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <header class="mb-6">
        <a href="/admin" class="text-sm text-primary-500 hover:text-primary-600 font-medium mb-2 inline-block">&larr; Zurück zum Dashboard</a>
        <h1 class="text-2xl font-bold text-gray-900">Dead Letter Queue</h1>
        <p class="text-gray-500">Jobs die nach mehrfachen Versuchen fehlgeschlagen sind</p>
      </header>

      <!-- Stats -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
          <div class="text-sm text-gray-500">DLQ Jobs</div>
          <div class="text-3xl font-bold text-red-600" id="dlq-count">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <div class="text-sm text-gray-500">Ältester Job</div>
          <div class="text-xl font-semibold text-gray-900" id="oldest-job">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <div class="text-sm text-gray-500">Häufigster Fehler</div>
          <div class="text-xl font-semibold text-gray-900 truncate" id="common-error">-</div>
        </div>
      </div>

      <!-- Actions -->
      <div class="mb-6 flex flex-wrap gap-3">
        <button id="refresh-btn" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition text-sm font-medium">
          Aktualisieren
        </button>
        <button id="retry-all-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm font-medium">
          Alle erneut versuchen
        </button>
        <button id="clear-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm font-medium">
          DLQ leeren
        </button>
      </div>

      <!-- Job List -->
      <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Job ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Typ</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Versuche</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Letzter Fehler</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Zeitpunkt</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aktionen</th>
              </tr>
            </thead>
            <tbody id="dlq-table" class="bg-white divide-y divide-gray-200">
              <tr>
                <td colspan="6" class="px-6 py-4 text-center text-gray-500">Laden...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script define:vars={{ API_URL, WORKER_URL }}>
    const workerUrl = WORKER_URL;

    async function loadDLQJobs() {
      try {
        const response = await fetch(`${workerUrl}/metrics`);
        if (!response.ok) throw new Error('Worker nicht erreichbar');
        
        const data = await response.json();
        const dlqCount = data.dlq?.count ?? 0;
        
        document.getElementById('dlq-count').textContent = dlqCount;
        
        if (dlqCount === 0) {
          document.getElementById('dlq-table').innerHTML = `
            <tr>
              <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                <div class="text-green-600 font-medium">Keine Jobs in der DLQ</div>
                <div class="text-sm mt-1">Alle Jobs wurden erfolgreich verarbeitet</div>
              </td>
            </tr>
          `;
          document.getElementById('oldest-job').textContent = '-';
          document.getElementById('common-error').textContent = '-';
        } else {
          document.getElementById('dlq-table').innerHTML = `
            <tr>
              <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                ${dlqCount} Jobs in der DLQ. Details-Endpoint in Entwicklung.
              </td>
            </tr>
          `;
        }
      } catch (error) {
        console.error('Failed to load DLQ:', error);
        document.getElementById('dlq-count').textContent = '?';
        document.getElementById('dlq-table').innerHTML = `
          <tr>
            <td colspan="6" class="px-6 py-4 text-center text-red-500">
              Fehler: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    document.getElementById('refresh-btn')?.addEventListener('click', loadDLQJobs);
    
    document.getElementById('retry-all-btn')?.addEventListener('click', () => {
      if (!confirm('Alle DLQ Jobs erneut versuchen?')) return;
      alert('Funktion noch nicht implementiert');
    });
    
    document.getElementById('clear-btn')?.addEventListener('click', () => {
      if (!confirm('DLQ wirklich leeren?')) return;
      alert('Funktion noch nicht implementiert');
    });

    loadDLQJobs();
    setInterval(loadDLQJobs, 30000);
  </script>
</BaseLayout>
