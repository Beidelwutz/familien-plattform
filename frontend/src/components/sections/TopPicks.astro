---
// TopPicks.astro - "Für euch jetzt gut" section with top 6-10 events
import EventCardNew from '../feed/EventCardNew.astro';

interface Event {
  id: string;
  title: string;
  image_urls?: string[];
  start_datetime?: string;
  location_address?: string;
  price_type: 'free' | 'paid' | 'range' | 'unknown';
  price_min?: number;
  price_max?: number;
  age_min?: number;
  age_max?: number;
  is_indoor?: boolean;
  is_outdoor?: boolean;
  scores?: {
    stressfree_score?: number;
    family_fit_score?: number;
  };
  last_verified_at?: string;
}

interface Props {
  events: Event[];
}

const { events } = Astro.props;

// Helper to format time from datetime
const formatTime = (datetime: string | undefined) => {
  if (!datetime) return undefined;
  try {
    return new Date(datetime).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  } catch {
    return undefined;
  }
};

// Helper to format "last verified" relative time
const formatLastVerified = (datetime: string | undefined) => {
  if (!datetime) return undefined;
  try {
    const diff = Date.now() - new Date(datetime).getTime();
    const hours = Math.floor(diff / (1000 * 60 * 60));
    if (hours < 1) return 'vor kurzem';
    if (hours < 24) return `vor ${hours}h`;
    const days = Math.floor(hours / 24);
    return `vor ${days}d`;
  } catch {
    return undefined;
  }
};
---

<section class="py-6 md:py-8">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Section Header -->
    <div class="flex items-center justify-between mb-5">
      <div>
        <h2 class="section-title flex items-center gap-2">
          <span class="text-2xl">✨</span>
          Für euch jetzt gut
        </h2>
        <p class="text-sm text-gray-500 mt-1">Passend zu Zeit, Ort und euren Vorlieben</p>
      </div>
      <a href="/suche" class="hidden sm:flex items-center gap-1 text-sm text-primary-600 hover:text-primary-700 font-medium">
        Alle anzeigen
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </a>
    </div>

    <!-- Events Grid -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
      {events.slice(0, 8).map((event) => (
        <EventCardNew
          id={event.id}
          title={event.title}
          imageUrl={event.image_urls?.[0]}
          startTime={formatTime(event.start_datetime)}
          priceType={event.price_type}
          priceMin={event.price_min}
          priceMax={event.price_max}
          ageMin={event.age_min}
          ageMax={event.age_max}
          isIndoor={event.is_indoor}
          isOutdoor={event.is_outdoor}
          stressfreeScore={event.scores?.stressfree_score}
          familyFitScore={event.scores?.family_fit_score}
          lastVerified={formatLastVerified(event.last_verified_at)}
        />
      ))}
    </div>

    <!-- Mobile "Show All" Link -->
    <div class="mt-4 sm:hidden">
      <a href="/suche" class="btn-secondary w-full text-center block">
        Alle Vorschläge anzeigen
      </a>
    </div>
  </div>
</section>
