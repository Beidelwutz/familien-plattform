---
/**
 * Pick of the day #4 – Timeline (Uhrzeit links, Infos rechts, vertikale Linie).
 */
interface PickEvent {
  id: string;
  title: string;
  start_datetime?: string;
  venue_name?: string;
  location_district?: string;
  price_type: 'free' | 'paid' | 'range' | 'unknown';
  price_min?: number;
  price_max?: number;
  availability_status?: string;
  categories?: { category?: { name_de?: string } }[];
}

interface Props {
  events: PickEvent[];
  locationName?: string;
}

const { events, locationName = 'Karlsruhe' } = Astro.props;

const formatTime = (datetime: string | undefined) => {
  if (!datetime) return '–';
  try {
    return new Date(datetime).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  } catch { return '–'; }
};

const formatPrice = (e: PickEvent) => {
  if (e.availability_status === 'sold_out') return 'Ausverkauft';
  if (e.price_type === 'free') return 'Kostenlos';
  if (e.price_type === 'paid' && e.price_min != null) return `${Number(e.price_min).toLocaleString('de-DE', { minimumFractionDigits: 2 })} €`;
  if (e.price_type === 'range' && e.price_min != null && e.price_max != null) return `${Number(e.price_min).toLocaleString('de-DE', { minimumFractionDigits: 2 })} – ${Number(e.price_max).toLocaleString('de-DE', { minimumFractionDigits: 2 })} €`;
  return '';
};
---

<section id="pick-4" class="py-6 md:py-8" aria-labelledby="pick-4-heading">
  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
    <h2 id="pick-4-heading" class="text-xl md:text-2xl font-bold text-gray-900 mb-1">
      Pick of the day #4 – Events heute in {locationName}
    </h2>
    <p class="text-sm text-gray-500 mb-5">Timeline</p>

    {events.length > 0 ? (
      <div class="relative border-l-2 border-primary-200 pl-6 sm:pl-8 space-y-0">
        {events.map((e) => {
          const venue = e.venue_name || e.location_district || '';
          const priceStr = formatPrice(e);
          const cat = e.categories?.[0]?.category?.name_de;
          return (
            <a href={`/event/${e.id}`} class="block py-4 first:pt-0 last:pb-0 hover:bg-primary-50/50 -ml-6 sm:-ml-8 pl-6 sm:pl-8 -mr-2 rounded-r-lg transition-colors group">
              <div class="flex gap-4">
                <div class="flex-shrink-0 w-14 text-right">
                  <span class="font-mono text-sm font-semibold text-primary-600">{formatTime(e.start_datetime)}</span>
                </div>
                <div class="min-w-0 flex-1">
                  <h3 class="font-semibold text-gray-900 group-hover:text-primary-600 transition-colors truncate">{e.title}</h3>
                  <p class="text-sm text-gray-600 truncate">{venue}{venue && (priceStr || cat) ? ' · ' : ''}{priceStr}{priceStr && cat ? ' · ' : ''}{cat || ''}</p>
                </div>
              </div>
            </a>
          );
        })}
      </div>
    ) : (
      <p class="text-gray-500 text-sm py-6">Keine Events für heute.</p>
    )}
  </div>
</section>
