---
// TagestippCard.astro ‚Äì Card f√ºr Tagestipp-Box mit Kontext-Badges
interface Props {
  id: string;
  title: string;
  imageUrl?: string;
  date?: string;
  startTime?: string;
  distance?: string;
  distanceKm?: number;
  priceType: 'free' | 'paid' | 'range' | 'unknown';
  priceMin?: number;
  priceMax?: number;
  ageMin?: number;
  ageMax?: number;
  isIndoor?: boolean;
  isOutdoor?: boolean;
  venueName?: string;
  locationDistrict?: string;
  categoryName?: string;
  badges?: string[];
  whyRecommended?: string;
  stressfreeScore?: number;
  familyFitScore?: number;
  lastVerified?: string;
}

const {
  id,
  title,
  imageUrl,
  startTime,
  distance,
  distanceKm,
  priceType,
  priceMin,
  priceMax,
  ageMin,
  ageMax,
  isIndoor = false,
  isOutdoor = false,
  venueName,
  locationDistrict,
  categoryName,
  badges = [],
  whyRecommended,
  stressfreeScore,
  familyFitScore,
  lastVerified,
} = Astro.props;

const BADGE_LABELS: Record<string, string> = {
  TRENDING: 'Trending',
  GEHEIMTIPP: 'Geheimtipp',
  LAST_CHANCE: 'Last Chance',
  BUDGET_PICK: 'Budget',
  WEATHER_SAFE: 'Wetter-sicher',
  MATCH: 'Match',
};

const getPriceDisplay = () => {
  if (priceType === 'free') return 'Kostenlos';
  if (priceType === 'paid' && priceMin != null) return `ab ${priceMin}‚Ç¨`;
  if (priceType === 'range' && priceMin != null && priceMax != null) return `${priceMin}-${priceMax}‚Ç¨`;
  return '';
};

const getAgeDisplay = () => {
  if (ageMin != null && ageMax != null) return ageMin === ageMax ? `${ageMin} J.` : `${ageMin}-${ageMax} J.`;
  if (ageMin != null) return `ab ${ageMin} J.`;
  if (ageMax != null) return `bis ${ageMax} J.`;
  return '';
};

const priceDisplay = getPriceDisplay();
const ageDisplay = getAgeDisplay();
const score = stressfreeScore ?? familyFitScore;
const locationDisplay = venueName || locationDistrict || '';
const metaParts = [startTime, categoryName, locationDisplay].filter(Boolean);
---

<article class="card group relative flex-shrink-0 w-full md:w-auto" data-event-id={id}>
  <a href={`/event/${id}`} class="block relative aspect-[4/3] overflow-hidden bg-gray-100 rounded-t-lg">
    {imageUrl ? (
      <img
        src={imageUrl}
        alt={title}
        loading="lazy"
        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
      />
    ) : (
      <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-primary-100 to-primary-50">
        <span class="text-4xl">üéà</span>
      </div>
    )}
    <div class="absolute top-2 left-2 flex flex-wrap gap-1.5">
      {badges.slice(0, 3).map((badge) => (
        <span class="badge bg-white/95 text-gray-800 text-xs font-medium shadow-sm" data-badge={badge}>
          {BADGE_LABELS[badge] ?? badge}
        </span>
      ))}
      {priceType === 'free' && (
        <span class="badge badge-free">Kostenlos</span>
      )}
    </div>
    <button
      class="absolute top-2 right-2 w-9 h-9 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-white transition-all shadow-sm opacity-0 group-hover:opacity-100"
      data-save-btn
      aria-label="Merken"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
      </svg>
    </button>
  </a>

  <div class="p-3 sm:p-4 rounded-b-lg border border-t-0 border-gray-200 bg-white">
    <a href={`/event/${id}`}>
      <h3 class="font-semibold text-gray-900 line-clamp-2 mb-1 group-hover:text-primary-600 transition-colors">
        {title}
      </h3>
    </a>

    {metaParts.length > 0 && (
      <p class="text-sm text-gray-500 mb-2">
        {metaParts.join(' ‚Ä¢ ')}
      </p>
    )}

    {(distance !== undefined && distance !== '') || distanceKm != null ? (
      <p class="text-sm text-gray-500 mb-2">
        {distance ?? (distanceKm != null ? `ca. ${distanceKm} km` : '')}
      </p>
    ) : null}

    <div class="flex items-center justify-between mb-2">
      <div class="flex items-center gap-3">
        {priceDisplay && priceType !== 'free' && (
          <span class="text-sm font-medium text-gray-700">{priceDisplay}</span>
        )}
        {ageDisplay && (
          <span class="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">{ageDisplay}</span>
        )}
      </div>
      {score != null && score >= 70 && (
        <div class="flex items-center gap-1 text-sm" title="Stressfrei-Score">
          <span class="text-accent-500">‚≠ê</span>
          <span class="font-medium text-gray-700">{score}</span>
        </div>
      )}
    </div>

    <div class="flex flex-wrap gap-1.5">
      {isIndoor && <span class="badge badge-indoor">üè† Indoor</span>}
      {isOutdoor && <span class="badge badge-outdoor">üå≥ Outdoor</span>}
    </div>

    {whyRecommended && (
      <details class="mt-2 group-details">
        <summary class="text-xs text-primary-600 hover:text-primary-700 cursor-pointer font-medium">
          Warum empfohlen?
        </summary>
        <p class="text-xs text-gray-600 mt-1 pl-0">{whyRecommended}</p>
      </details>
    )}

    {lastVerified && (
      <div class="mt-2 pt-2 border-t border-gray-100">
        <span class="text-xs text-gray-400 flex items-center gap-1">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Gepr√ºft {lastVerified}
        </span>
      </div>
    )}

    <div class="mt-3 flex gap-2">
      <a
        href={`/event/${id}`}
        class="flex-1 text-center text-sm font-medium text-primary-600 hover:text-primary-700 py-2 rounded-lg border border-primary-200 hover:bg-primary-50 transition-colors"
      >
        Details
      </a>
      <a href={`/event/${id}#similar`} class="text-xs text-gray-500 hover:text-gray-700 self-center">
        √Ñhnliche
      </a>
    </div>
  </div>
</article>

<script>
  document.querySelectorAll('[data-save-btn]').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const card = (btn as HTMLElement).closest('[data-event-id]');
      const eventId = card?.getAttribute('data-event-id');
      const svg = btn.querySelector('svg');
      const isSaved = svg?.getAttribute('fill') === 'currentColor';
      if (isSaved) {
        svg?.setAttribute('fill', 'none');
        btn.classList.remove('text-red-500');
        btn.classList.add('text-gray-400');
      } else {
        svg?.setAttribute('fill', 'currentColor');
        btn.classList.remove('text-gray-400');
        btn.classList.add('text-red-500');
      }
      window.dispatchEvent(new CustomEvent('eventSaved', { detail: { eventId, saved: !isSaved } }));
    });
  });
</script>
